---
layout: default
title: Character Rework Tool
---

<link rel="stylesheet" href="{{ '/assets/css/rework.css' | relative_url }}">

<div class="page">
    <h1>Character Rework Tool</h1>

    {% include auth-header.html %}
    <p id="instruction-text" class="auth-instruction">Please log in to Save/Load WIP Reworks.</p>

    <br>

    <div class="tab-nav">
        <button class="tab-btn active" onclick="window.switchTab('input')">Input</button>
        <button class="tab-btn" onclick="window.switchTab('cost')">Cost Calculations</button>
        <button class="tab-btn" onclick="window.switchTab('output')">Output</button>
    </div>

    <div id="tab-input" class="tab-content active">

        <div class="control-bar" id="controls-area">
            <div id="logged-out-controls" class="control-group" style="display:none; align-items:center; gap: 10px;">
                <button id="custom-login-btn" class="auth-btn auth-btn-discord" onclick="window.authManager.login()">
                    <svg class="discord-logo" width="20" height="20" viewBox="0 0 127.14 96.36" aria-hidden="true">
                        <path fill="currentColor"
                            d="M107.7,8.07A105.15,105.15,0,0,0,81.47,0a72.06,72.06,0,0,0-3.36,6.83A97.68,97.68,0,0,0,49,6.83,72.37,72.37,0,0,0,45.64,0A105.89,105.89,0,0,0,19.39,8.09C2.79,32.65-1.71,56.6.54,80.21h0A105.73,105.73,0,0,0,32.71,96.36,77.11,77.11,0,0,0,39.6,85.25a68.42,68.42,0,0,1-10.85-5.18c.91-.66,1.8-1.34,2.66-2a75.57,75.57,0,0,0,64.32,0c.87.71,1.76,1.39,2.66,2a68.68,68.68,0,0,1-10.87,5.19,77,77,0,0,0,6.89,11.1A105.89,105.89,0,0,0,126.6,80.22c2.36-24.44-2.54-47.89-18.9-72.15ZM42.45,65.69C36.18,65.69,31,60,31,53s5-12.74,11.43-12.74S54,46,53.89,53,48.84,65.69,42.45,65.69Zm42.24,0C78.41,65.69,73.25,60,73.25,53s5.18-12.74,11.44-12.74S96.23,46,96.12,53,91.08,65.69,84.69,65.69Z" />
                    </svg>
                    Login
                </button>
                <span style="font-size:0.9em; margin-left:10px;"> or type your Discord ID if you do not want to login
                    (save/load feature disabled): </span>
                <input type="text" id="manual-discord-id" class="text-input" style="width: 150px;"
                    placeholder="Discord ID">
            </div>

            <div id="logged-in-controls" class="control-group" style="display:none; flex-direction: column; align-items: flex-start;">
                <div style="display: flex; gap: 10px; width: 100%; align-items: center;">
                    <button class="button action-btn btn-save" onclick="window.saveRework()">Save</button>
                    <button class="button action-btn btn-load" onclick="window.loadSelectedRework()">Load</button>
                    <button class="button action-btn btn-delete" onclick="window.deleteRework()" style="background-color: #c0392b; color: #fff;">Delete</button>
                    <select id="load-rework-select" class="load-select" style="flex-grow: 1;">
                        <option value="">-- Load Saved Rework --</option>
                    </select>
                </div>
                <p style="font-size: 0.85em; color: var(--text-muted, #666); margin: 8px 0 0 0; font-style: italic;">
                    *Saved reworks are WIP only and are automatically deleted after 3 months. The <a href="https://discord.com/channels/308324031478890497/1094052066898518057" target="_blank">#Character-Rework-Log</a> on Discord is the only master record.
                </p>
            </div>

            <div id="auth-error-msg" class="control-group" style="display:none; align-items: center; gap: 10px;">
                <span style="color: #e74c3c; font-weight: bold;"></span>
            </div>
        </div>

        <input type="hidden" id="current-rework-id" value="">

        <div class="respec-container">
            <div class="char-column" id="col-original">
                <h2 class="column-header">Original Character</h2>
                <div class="card">
                    <h3 class="card-title">Character Info</h3>
                    <div class="origin-grid">
                        <div class="input-group">
                            <label class="input-label">Character Name</label>
                            <input type="text" class="text-input" id="name-original" placeholder="Name">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Base Attributes (27 Point Buy)</label>
                            <div id="attrs-container-original"></div>
                            <div id="points-original" style="font-size: 0.85em; text-align: right; margin-top: 4px; font-weight: bold; color: #2ecc71;">
                                27 / 27 Pts
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h3 class="card-title">Race/Species</h3>
                    <div class="input-group">
                        <label class="input-label">Race/Species</label>
                        <input type="text" class="text-input" id="race-original" placeholder="Race/Species Details">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Racial Bonuses</label>
                        <div id="race-mod-container-original"></div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Racial Features</label>
                        <div id="race-features-container-original"></div>
                    </div>
                </div>
                <div class="card">
                    <h3 class="card-title">Origin (Background)</h3>
                    <div class="input-group">
                        <label class="input-label">Origin (Background)</label>
                        <input type="text" class="text-input" id="bg-original" placeholder="e.g. Acolyte">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Origin Features</label>
                        <div id="origin-features-container-original"></div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Origin Feat</label>
                        <input type="text" class="text-input" id="orig-feat-original" placeholder="Feat Name">
                        <div class="field-header-row" style="margin-top:10px;"><label class="input-label"
                                style="font-size:0.8em">Origin Feat Modifiers</label></div>
                        <div id="origin-mod-container-original"></div>
                        <div class="field-header-row" style="margin-top:10px;"><label class="input-label"
                                style="font-size:0.8em">Origin Feat Features</label></div>
                        <div id="origin-feat-features-container-original"></div>
                    </div>
                </div>
                <div class="card">
                    <h3 class="card-title">Classes</h3>
                    <div id="classes-container-original"></div>
                    <button type="button" class="button button-secondary" onclick="window.addClassRow('original')">+ Add
                        Class</button>
                </div>
                <div id="feats-container-original"></div>
            </div>

            <div class="char-column" id="col-new">
                <h2 class="column-header">New Character</h2>
                <div class="card">
                    <h3 class="card-title">Character Info</h3>
                    <div class="origin-grid">
                        <div class="input-group">
                            <div class="field-header-row"><label class="input-label">Character Name</label><button
                                    type="button" class="copy-link"
                                    onclick="window.copyValue('name-original', 'name-new')">Copy</button></div>
                            <input type="text" class="text-input" id="name-new" placeholder="Name">
                        </div>
                        <div class="input-group">
                            <div class="field-header-row"><label class="input-label">Base Attributes</label><button
                                    type="button" class="copy-link" onclick="window.copyAttributes()">Copy</button>
                            </div>
                            <div id="attrs-container-new"></div>
                            <div id="points-new" style="font-size: 0.85em; text-align: right; margin-top: 4px; font-weight: bold; color: #2ecc71;">
                                27 / 27 Pts
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h3 class="card-title">Race/Species</h3>
                    <div class="input-group">
                        <div class="field-header-row"><label class="input-label">Race/Species</label><button
                                type="button" class="copy-link"
                                onclick="window.copyValue('race-original', 'race-new')">Copy</button></div>
                        <input type="text" class="text-input" id="race-new" placeholder="Race/Species Details">
                    </div>
                    <div class="input-group">
                        <div class="field-header-row"><label class="input-label">Racial Bonuses</label><button
                                type="button" class="copy-link" onclick="window.copyMods('race')">Copy</button>
                        </div>
                        <div id="race-mod-container-new"></div>
                    </div>
                    <div class="input-group">
                        <div class="field-header-row"><label class="input-label">Racial Features</label><button
                                type="button" class="copy-link" onclick="window.copyFeatures('race')">Copy</button>
                        </div>
                        <div id="race-features-container-new"></div>
                    </div>
                </div>
                <div class="card">
                    <h3 class="card-title">Origin (Background)</h3>
                    <div class="input-group">
                        <div class="field-header-row"><label class="input-label">Origin (Background)</label><button
                                type="button" class="copy-link"
                                onclick="window.copyValue('bg-original', 'bg-new')">Copy</button></div>
                        <input type="text" class="text-input" id="bg-new" placeholder="e.g. Acolyte">
                    </div>
                    <div class="input-group">
                        <div class="field-header-row"><label class="input-label">Origin Features</label><button
                                type="button" class="copy-link" onclick="window.copyFeatures('origin')">Copy</button>
                        </div>
                        <div id="origin-features-container-new"></div>
                    </div>
                    <div class="input-group">
                        <div class="field-header-row"><label class="input-label">Origin Feat</label><button
                                type="button" class="copy-link"
                                onclick="window.copyValue('orig-feat-original', 'orig-feat-new')">Copy</button>
                        </div>
                        <input type="text" class="text-input" id="orig-feat-new" placeholder="Feat Name">
                        <div class="field-header-row" style="margin-top:10px;"><label class="input-label"
                                style="font-size:0.8em">Origin Feat Modifiers</label><button type="button"
                                class="copy-link" onclick="window.copyMods('origin')">Copy</button></div>
                        <div id="origin-mod-container-new"></div>
                        <div class="field-header-row" style="margin-top:10px;"><label class="input-label"
                                style="font-size:0.8em">Origin Feat Features</label><button type="button"
                                class="copy-link" onclick="window.copyFeatures('origin-feat')">Copy</button></div>
                        <div id="origin-feat-features-container-new"></div>
                    </div>
                </div>
                <div class="card">
                    <h3 class="card-title">Classes</h3>
                    <div id="classes-container-new"></div>
                    <button type="button" class="button button-secondary" onclick="window.addClassRow('new')">+ Add
                        Class</button>
                </div>
                <div id="feats-container-new"></div>
            </div>
        </div>
<div class="control-bar" id="controls-area">
    
    <div class="control-group" style="display:flex; align-items:center; gap: 10px; margin-bottom: 10px;">
        <label>Discord ID:</label>
        <input type="text" id="manual-discord-id" class="text-input" style="width: 150px;" placeholder="username">
    </div>

    <div id="tab-cost" class="tab-content">
        <h2 class="column-header">Cost Calculations</h2>
        
        <div class="card">
            <h3 class="card-title" onclick="window.toggleAccordion('cost-info')" style="cursor: pointer; user-select: none;">
                <span id="cost-info-icon">▼</span> Cost Calculations
            </h3>
            <div id="cost-info-content" style="margin-bottom: 20px; line-height: 1.6;">
                <p style="margin-bottom: 10px;">Costs are based on the type of change:</p>
                <ul style="margin-left: 20px; margin-bottom: 15px;">
                    <li>2024 Update Rework (0 cost)</li>
                    <li>Any rework before level 6 (0 cost)</li>
                    <li>Checkpoint Rework (cost based on tier)</li>
                    <li>A-la-carte Rework (cost on a per-change basis)</li>
                </ul>
                
                <p style="margin-bottom: 10px;"><strong>A-la-carte change costs:</strong></p>
                <ul style="margin-left: 20px;">
                    <li>Changing 1 class level, your race/species (including racial features and ASIs), background (including features, proficiencies, and/or ASIs) and changing a feat or ASI all cost 1 change each</li>
                    <li>Changing a language known or tool or skill proficiency independent of other changes costs 1 change</li>
                    <li>Changing a subclass costs 1 change per class level that adds a subclass feature. (You aren't charged for a subclass change added as a result of a class level change)</li>
                    <li>Changing starting ability scores, or changing the character to a different person, costs 2 changes</li>
                    <li>Changing from 2014 to 2024 costs 1 change. You must change your species, class, subclass, feats, and all other character options to their 2024 equivalent unless that option has not been reprinted. Your starting ASIs from your species are replaced with ASIs of your choice from your background, which can be customized as written in Appendix A of the Player Guidelines.</li>
                    <li>Changing from 2024 to 2014 costs 1 change. You must change your species, class, subclass, feats, and all other character options to their 2014 equivalent. If there is no 2014 equivalent for a character option, you must choose an eligible 2014 option instead. This does not incur any additional costs.</li>
                </ul>
                <p style="margin-top: 15px; font-style: italic;">
                    The section below does a preliminary calculation based on a comparison of your characters in the input tab. Please review carefully and make adjustments to the calculations where appropriate.
                </p>
            </div>
            
            <div style="margin-bottom: 15px;">
                <label class="input-label">Rework Type</label>
                <select id="rework-type" class="text-input" onchange="window.calculateCosts()">
                    <option value="">-- Select Rework Type --</option>
                    <option value="2024-update">2024 Update Rework</option>
                    <option value="level-5-below">Level 5 or below Rework</option>
                    <option value="t2-checkpoint">T2 Checkpoint Rework</option>
                    <option value="t3-checkpoint">T3 Checkpoint Rework</option>
                    <option value="t4-checkpoint">T4 Checkpoint Rework</option>
                    <option value="alacarte">A-la-carte Rework</option>
                </select>
            </div>
            
            <div id="cost-error" style="display: none; padding: 10px; background-color: #fee; border: 1px solid #c00; border-radius: 4px; margin-bottom: 15px; color: #c00;">
            </div>
            
            <h4 style="margin-top: 20px; margin-bottom: 10px;">Cost Calculation</h4>
            <button type="button" class="button button-secondary" onclick="window.calculateCosts()" style="margin-bottom: 10px;">Calculate Costs</button>
    <div id="logged-in-controls" class="control-group" style="display:none; flex-direction: column;">
        <div style="display: flex; gap: 10px; width: 100%; align-items: center;">
            <button class="button action-btn btn-save" onclick="window.saveRework()">Save</button>
            
            <table class="stat-table" id="cost-table" style="margin-bottom: 10px;">
                <thead>
                    <tr>
                        <th style="width: 50%;">Change</th>
                        <th style="width: 15%;"># of Changes</th>
                        <th style="width: 15%;">DTP Cost</th>
                        <th style="width: 15%;">Gold Cost</th>
                        <th style="width: 5%;"></th>
                    </tr>
                </thead>
                <tbody id="cost-table-body">
                    <!-- Cost rows will be added here -->
                </tbody>
            </table>
            <select id="load-rework-select" class="load-select" style="flex-grow: 1;" onchange="window.loadSelectedRework()">
                <option value="">-- Load My Saved Rework --</option>
            </select>
            
            <button type="button" class="button button-secondary" onclick="window.addCostRow()">+ Add Row</button>
            <button class="button action-btn" onclick="window.loadExternalId()" style="background-color: #3498db;">Import UUID</button>
            
            <div style="margin-top: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 4px;">
                <strong>Total Changes: <span id="total-changes">0</span></strong><br>
                <strong>Total DTP Cost: <span id="total-dtp">0</span></strong><br>
                <strong>Total Gold Cost: <span id="total-gold">0</span> GP</strong>
            </div>
            <button class="button action-btn btn-delete" onclick="window.deleteRework()" style="background-color: #c0392b;">Delete</button>
        </div>
        
        <div class="card">
            <h3 class="card-title">Rework Details</h3>
            <input type="text" id="rework-cost" class="text-input" placeholder="GP/DTP Costs">
            <textarea id="rework-notes" class="notes-area" style="min-height:100px;"
                placeholder="Notes for auditors"></textarea>
        </div>
    </div>

    <div id="tab-output" class="tab-content">
        <h2 class="column-header">Rework Request Form</h2>
        
        {% include discord-output.html 
            id="output-text" 
            channel_name="#Character-Rework-Log" 
            channel_url="https://discord.com/channels/308324031478890497/1094052066898518057" 
        %}
    </div>
</div>

<script type="module" src="{{ '/assets/js/auth-manager.js' | relative_url }}"></script>

<script type="module">
    // Import the guard
    import { checkAccess } from "{{ '/assets/js/auth-check.js' | relative_url }}";

    // Visibility toggle for Auth instructions
    // Made ASYNC to handle database checks
    window.handlePageAuth = async function (user) {
        window.currentUser = user;

        const instructionText = document.getElementById('instruction-text');
        const loggedOutGroup = document.getElementById('logged-out-controls');
        const loggedInGroup = document.getElementById('logged-in-controls');
        const authErrorGroup = document.getElementById('auth-error-msg');

        // 1. Reset UI
        if (loggedOutGroup) loggedOutGroup.style.display = 'none';
        if (loggedInGroup) loggedInGroup.style.display = 'none';
        if (authErrorGroup) authErrorGroup.style.display = 'none';
        
        // Reset Header Status
        if (window.setAuthStatus) window.setAuthStatus('normal');

        // 2. Handle Logged Out
        if (!user) {
            if (instructionText) instructionText.style.display = 'block';
            if (loggedOutGroup) loggedOutGroup.style.display = 'flex';
            return;
        }

        // 3. Handle Logged In
        if (instructionText) instructionText.style.display = 'none';

        // 4. CHECK PERMISSIONS using AuthGuard
        // rework.html requires 'Adventurer'
        const hasAccess = await checkAccess(user.id, 'Adventurer');

        if (hasAccess) {
            // SUCCESS: Show controls and fetch data
            if (loggedInGroup) loggedInGroup.style.display = 'flex';
            if (window.fetchReworks) window.fetchReworks();
        } else {
            // FAILURE: Show error message
            if (authErrorGroup) {
                authErrorGroup.style.display = 'flex';
                authErrorGroup.querySelector('span').innerText = 
                    "Access Denied: You need the 'Adventurer' role to Save/Load.";
            }
            if (window.setAuthStatus) window.setAuthStatus('denied');
        }
    };
</script>

<script type="module">
    import { supabase } from "{{ '/assets/js/supabaseClient.js' | relative_url }}";

    const ATTRIBUTES = ['STR', 'DEX', 'CON', 'INT', 'WIS', 'CHA'];
    const POINT_COSTS = { 8: 0, 9: 1, 10: 2, 11: 3, 12: 4, 13: 5, 14: 7, 15: 9 };
    let characterData = [];

    // DATABASE CORE FUNCTIONS
    window.fetchReworks = async function () {
        if (!window.currentUser) return;
        const select = document.getElementById('load-rework-select');
        try {
            const { data, error } = await supabase.from('rework')
                .select('id, character_name, updated_at')
                .eq('user_id', window.currentUser.id)
                .order('updated_at', { ascending: false });
            if (error) throw error;
            select.innerHTML = '<option value="">-- Load Saved Rework --</option>';
            data.forEach(row => {
                const opt = document.createElement('option');
                opt.value = row.id;
                opt.innerText = `${row.character_name || "Unnamed"} (${new Date(row.updated_at).toLocaleDateString()})`;
                select.appendChild(opt);
            });
        } catch (err) { console.error("Fetch Error:", err); }
    };

    window.saveRework = async function () {
        if (!window.currentUser) return alert("Please log in to save.");
        const oldChar = window.scrapeColumn('original');
        const newChar = window.scrapeColumn('new');
        const currentId = document.getElementById('current-rework-id').value;

        // Collect cost rows
        const costRows = [];
        document.querySelectorAll('#cost-table-body tr').forEach(row => {
            const change = row.querySelector('.cost-change')?.value || '';
            const numChanges = parseInt(row.querySelector('.cost-num-changes')?.value) || 0;
            const dtpCost = parseInt(row.querySelector('.cost-dtp')?.value) || 0;
            const goldCost = parseInt(row.querySelector('.cost-gold')?.value) || 0;
            costRows.push({ change, numChanges, dtpCost, goldCost });
        });

        const payload = {
            user_id: window.currentUser.id,
            discord_id: window.getCurrentDiscordID(),
            character_name: oldChar.name || "Unnamed",
            old_character: oldChar,
            new_character: newChar,
            cost: document.getElementById('rework-cost').value,
            notes: document.getElementById('rework-notes').value,
            rework_type: document.getElementById('rework-type').value,
            cost_rows: costRows,
            updated_at: new Date().toISOString()
        };

        try {
            const { data, error } = currentId
                ? await supabase.from('rework').update(payload).eq('id', currentId).select()
                : await supabase.from('rework').insert([payload]).select();
            if (error) throw error;
            if (!currentId && data) document.getElementById('current-rework-id').value = data[0].id;
            alert("Rework Saved!");
            window.fetchReworks();
        } catch (e) { alert("Save failed: " + e.message); }
    };

    window.deleteRework = async function() {
        const id = document.getElementById('load-rework-select').value;
        if (!id) return alert("Please select a rework from the dropdown to delete.");
        
        if (!confirm("Are you sure you want to delete this rework? This cannot be undone.")) return;

        try {
            const { error } = await supabase.from('rework').delete().eq('id', id);
            if (error) throw error;
            
            alert("Rework deleted.");
            // If the deleted rework was the one currently on screen, clear the ID tracker
            if (document.getElementById('current-rework-id').value === id) {
                 document.getElementById('current-rework-id').value = "";
            }
            window.fetchReworks(); 
        } catch (e) {
            alert("Delete failed: " + e.message);
        }
    };

    window.loadSelectedRework = async function () {
        const id = document.getElementById('load-rework-select').value;
        if (!id) return alert("Select a rework first.");
        try {
            const { data, error } = await supabase.from('rework').select('*').eq('id', id).single();
            if (error) throw error;

            document.getElementById('current-rework-id').value = data.id;
            document.getElementById('rework-cost').value = data.cost || "";
            document.getElementById('rework-notes').value = data.notes || "";
            document.getElementById('rework-type').value = data.rework_type || "";

            // Restore cost rows
            document.getElementById('cost-table-body').innerHTML = '';
            if (data.cost_rows && data.cost_rows.length > 0) {
                data.cost_rows.forEach(row => {
                    window.addCostRow(
                        row.change || '', 
                        row.numChanges || row.cost || 0,  // Backward compatible with old 'cost' field
                        row.dtpCost || 0, 
                        row.goldCost || 0
                    );
                });
            }

            populateColumn('original', data.old_character);
            populateColumn('new', data.new_character);
            alert("Rework Loaded!");
        } catch (err) { alert("Load failed."); }
    };

    function populateColumn(colId, data) {
        if (!data) return;
        const setV = (id, val) => { const el = document.getElementById(id); if (el) el.value = val || ""; };

        setV(`name-${colId}`, data.name);
        setV(`race-${colId}`, data.race);
        setV(`bg-${colId}`, data.bg);
        setV(`orig-feat-${colId}`, data.origin_feat);

        ATTRIBUTES.forEach(a => setV(`attr-${colId}-${a}`, data.attributes?.[a] || "10"));

        document.querySelectorAll(`.mod-select-race[data-col="${colId}"]`).forEach(s => s.value = data.race_mods?.[s.dataset.attr] || "0");
        document.querySelectorAll(`.mod-select-origin[data-col="${colId}"]`).forEach(s => s.value = data.origin_mods?.[s.dataset.attr] || "0");

        // Restore race features
        const raceFeatureRows = document.querySelectorAll(`#race-features-container-${colId} .feature-row`);
        if (data.race_features) {
            data.race_features.forEach((feat, i) => {
                if (raceFeatureRows[i]) {
                    const typeSelect = raceFeatureRows[i].querySelector('.feature-type');
                    const nameInput = raceFeatureRows[i].querySelector('.feature-name');
                    if (typeSelect) typeSelect.value = feat.type || "none";
                    if (nameInput) nameInput.value = feat.name || "";
                }
            });
        }
        
        // Restore origin features
        const originFeatureRows = document.querySelectorAll(`#origin-features-container-${colId} .feature-row`);
        if (data.origin_features) {
            data.origin_features.forEach((feat, i) => {
                if (originFeatureRows[i]) {
                    const typeSelect = originFeatureRows[i].querySelector('.feature-type');
                    const nameInput = originFeatureRows[i].querySelector('.feature-name');
                    if (typeSelect) typeSelect.value = feat.type || "none";
                    if (nameInput) nameInput.value = feat.name || "";
                }
            });
        }
        
        // Restore origin feat features
        const originFeatFeatureRows = document.querySelectorAll(`#origin-feat-features-container-${colId} .feature-row`);
        if (data.origin_feat_features) {
            data.origin_feat_features.forEach((feat, i) => {
                if (originFeatFeatureRows[i]) {
                    const typeSelect = originFeatFeatureRows[i].querySelector('.feature-type');
                    const nameInput = originFeatFeatureRows[i].querySelector('.feature-name');
                    if (typeSelect) typeSelect.value = feat.type || "none";
                    if (nameInput) nameInput.value = feat.name || "";
                }
            });
        }

        const container = document.getElementById(`classes-container-${colId}`);
        container.innerHTML = "";
        data.classes?.forEach(c => window.addClassRow(colId, c));

        window.generateFeatCards(colId, data.feats);
        window.calculatePointBuy(colId);
    }

    // SCRAPER & OUTPUT FORMATTING
    window.scrapeColumn = (colId) => {
        const getV = (id) => document.getElementById(id)?.value || "";
        const attrs = {}; ATTRIBUTES.forEach(a => attrs[a] = getV(`attr-${colId}-${a}`));

        const rMods = {};
        document.querySelectorAll(`.mod-select-race[data-col="${colId}"]`).forEach(s => rMods[s.dataset.attr] = s.value);
        const oMods = {};
        document.querySelectorAll(`.mod-select-origin[data-col="${colId}"]`).forEach(s => oMods[s.dataset.attr] = s.value);

        const classes = [];
        document.querySelectorAll(`#classes-container-${colId} .class-block`).forEach(b => {
            classes.push({
                version: b.querySelector('.version-select').value,
                class: b.querySelector('.class-select').value,
                subclass: b.querySelector('.subclass-select').value,
                level: b.querySelector('.level-input').value
            });
        });

        const feats = [];
        document.querySelectorAll(`#feats-container-${colId} .feat-card`).forEach(c => {
            const mods = {};
            c.querySelectorAll('select[data-attr]').forEach(s => mods[s.dataset.attr] = s.value);
            
            const features = [];
            const featureTypes = c.querySelectorAll('.feat-feature-type');
            const featureNames = c.querySelectorAll('.feat-feature-name');
            featureTypes.forEach((typeSelect, i) => {
                features.push({
                    type: typeSelect.value,
                    name: featureNames[i]?.value || ""
                });
            });
            
            feats.push({
                name: c.querySelector('.feat-name')?.value || "",
                mods: mods,
                features: features,
                // Using 'source' to match generateOutput's expectations
                source: c.querySelector('.card-title').innerText.split(' - ')[0],
                lvl: c.querySelector('.card-title').innerText.match(/Lvl (\d+)/)?.[1] || ""
            });
        });

        // Collect race features
        const raceFeatures = [];
        document.querySelectorAll(`#race-features-container-${colId} .feature-row`).forEach(row => {
            const type = row.querySelector('.feature-type')?.value || "none";
            const name = row.querySelector('.feature-name')?.value || "";
            raceFeatures.push({ type, name });
        });
        
        // Collect origin features
        const originFeatures = [];
        document.querySelectorAll(`#origin-features-container-${colId} .feature-row`).forEach(row => {
            const type = row.querySelector('.feature-type')?.value || "none";
            const name = row.querySelector('.feature-name')?.value || "";
            originFeatures.push({ type, name });
        });
        
        // Collect origin feat features
        const originFeatFeatures = [];
        document.querySelectorAll(`#origin-feat-features-container-${colId} .feature-row`).forEach(row => {
            const type = row.querySelector('.feature-type')?.value || "none";
            const name = row.querySelector('.feature-name')?.value || "";
            originFeatFeatures.push({ type, name });
        });

        return { 
            name: getV(`name-${colId}`), 
            race: getV(`race-${colId}`), 
            race_features: raceFeatures,
            bg: getV(`bg-${colId}`), 
            origin_features: originFeatures,
            origin_feat: getV(`orig-feat-${colId}`), 
            origin_feat_features: originFeatFeatures,
            attributes: attrs, 
            race_mods: rMods, 
            origin_mods: oMods, 
            classes, 
            feats 
        };
    };

    window.generateOutput = () => {
        const buildB = (c) => {
            const clean = (s) => (s || '').replace(/\s*\(.*?\)\s*/g, ' ').trim();
            const classLine = c.classes.map(cl => {
                const name = clean(cl.class);
                const sub = clean(cl.subclass);
                return `${name}${sub && sub !== 'None' ? ' ' + sub : ''} (${cl.level})`;
            }).join(' / ');

            const bonusLine = [];
            ATTRIBUTES.forEach(a => {
                const total = (parseInt(c.race_mods[a]) || 0) + (parseInt(c.origin_mods[a]) || 0);
                if (total > 0) bonusLine.push(`+${total} ${a}`);
            });

            const featChoices = [];
            if (c.origin_feat) {
                let m = []; ATTRIBUTES.forEach(a => { if (c.origin_mods[a] != "0") m.push(`+${c.origin_mods[a]} ${a}`); });
                featChoices.push(`${c.origin_feat}${m.length ? ' ' + m.join(", ") : ""} (Background)`);
            }
            c.feats.forEach(f => {
                let m = []; ATTRIBUTES.forEach(a => { if (f.mods[a] != "0") m.push(`+${f.mods[a]} ${a}`); });

                // Match the feat to its source class to get the subclass for output
                const sourceClassData = c.classes.find(cl => cl.class === f.source);
                const cleanClassName = clean(f.source);
                const cleanSubName = sourceClassData ? clean(sourceClassData.subclass) : "";
                const subPart = (cleanSubName && cleanSubName !== 'None') ? ` ${cleanSubName}` : "";

                featChoices.push(`${f.name}${m.length ? ' ' + m.join(", ") : ""} (${cleanClassName}${subPart} (${f.lvl}))`);
            });

            return `Name: ${c.name}
Version: ${c.classes[0]?.version || '2024'}
Level: ${c.classes.reduce((a, b) => a + (parseInt(b.level) || 0), 0)}
Class: ${classLine}
Race/Species: ${c.race}
Starting Stats: (excluding Racial/Background Bonuses)
Str / Dex / Con / Int / Wis / Cha
${ATTRIBUTES.map(a => c.attributes[a]).join(' / ')}
Racial/Background stat bonuses: ${bonusLine.join(', ') || 'None'}
ASI/Feat/Origin Feat choices: ${featChoices.join(', ')}
Background: ${c.bg}`;
        };

        const oldC = window.scrapeColumn('original');
        const newC = window.scrapeColumn('new');
        const finalOutput = `\`\`\`
__***Character Change Request***__

**Requestor:** @${window.getCurrentDiscordID()} as ${oldC.name} (${oldC.classes.reduce((a, b) => a + (parseInt(b.level) || 0), 0)})

**Old Character**
${buildB(oldC)}

**New Character**
${buildB(newC)}

**Notes**
Cost: ${document.getElementById('rework-cost').value || 'None'}
Notes: ${document.getElementById('rework-notes').value || 'None'}
\`\`\`
<@&474659626193780751> <@&554463237924716545>`;
        document.getElementById('output-text').value = finalOutput;
    };

    // UI RENDERERS
    // Helper to capture current feat card state
    window.saveFeatState = function (colId) {
        const feats = [];
        document.querySelectorAll(`#feats-container-${colId} .feat-card`).forEach(c => {
            const mods = {};
            c.querySelectorAll('select').forEach(s => mods[s.dataset.attr] = s.value);
            feats.push({
                name: c.querySelector('.text-input').value,
                mods: mods
            });
        });
        return feats;
    };

    window.removeClassRow = function (btn) {
        const block = btn.closest('.class-block');
        const container = block.parentElement;
        // Determine colId from the container's ID (e.g., "classes-container-original")
        const colId = container.id.replace('classes-container-', '');

        const savedFeats = window.saveFeatState(colId);
        block.remove();
        window.generateFeatCards(colId, savedFeats);
    };

    window.addClassRow = function (colId, init = null) {
        const container = document.getElementById(`classes-container-${colId}`);
        const block = document.createElement('div');
        block.className = 'class-block';
        block.innerHTML = `
            <div class="class-row">
                <select class="version-select"><option value="">Ver</option><option value="2014">2014</option><option value="2024">2024</option></select>
                <select class="class-select" disabled><option value="">Class</option></select>
                <select class="subclass-select" disabled><option value="">Subclass</option></select>
            </div>
            <div class="class-row-bottom">
                <div class="level-wrapper">Lvl:<input type="number" class="level-input" value="1" min="1" max="20"></div>
                <button type="button" class="remove-class-btn" onclick="window.removeClassRow(this)">&times;</button>
            </div>`;
        container.appendChild(block);

        const vS = block.querySelector('.version-select'), cS = block.querySelector('.class-select'), sS = block.querySelector('.subclass-select'), lI = block.querySelector('.level-input');

        const updC = (val) => {
            cS.innerHTML = '<option value="">Class</option>'; cS.disabled = !vS.value;
            [...new Set(characterData.filter(i => i.version == vS.value).map(i => i.class))].forEach(c => {
                const opt = document.createElement('option'); opt.value = c; opt.innerText = c;
                if (c === val) opt.selected = true;
                cS.appendChild(opt);
            });
        };
        const updS = (val) => {
            sS.innerHTML = '<option value="">Subclass</option>'; sS.disabled = !cS.value;
            characterData.filter(i => i.version == vS.value && i.class == cS.value).forEach(s => {
                const opt = document.createElement('option'); opt.value = s.subclass; opt.innerText = s.subclass || 'None';
                if (s.subclass === val) opt.selected = true;
                sS.appendChild(opt);
            });
        };

        // When updating any field, first save the current feat state, then regenerate
        const updateAndRegen = () => {
            const savedState = window.saveFeatState(colId);
            window.generateFeatCards(colId, savedState);
        };

        vS.onchange = () => { updC(); updateAndRegen(); };
        cS.onchange = () => { updS(); updateAndRegen(); };
        lI.oninput = () => updateAndRegen();

        if (init) { vS.value = init.version; updC(init.class); updS(init.subclass); lI.value = init.level; }
    };

    window.generateFeatCards = function (colId, saved = null) {
        const container = document.getElementById(`feats-container-${colId}`);
        container.innerHTML = ''; 
        let idx = 0;

        document.querySelectorAll(`#classes-container-${colId} .class-block`).forEach(b => {
            const ver = b.querySelector('.version-select').value;
            const cls = b.querySelector('.class-select').value;
            const sub = b.querySelector('.subclass-select').value;
            const lvl = parseInt(b.querySelector('.level-input').value) || 0;

            if (!cls || !ver) return;

            // 1. Find the matching data object to get the correct ASI array
            // If subclass is selected, try to match it exactly. 
            // If not, just find the first entry for that Class+Version (usually ASIs are consistent across subclasses).
            let dataRow = characterData.find(row => 
                row.version == ver && 
                row.class === cls && 
                row.subclass === sub
            );
            
            if (!dataRow) {
                dataRow = characterData.find(row => row.version == ver && row.class === cls);
            }

            // 2. Use the ASI array from data, or default to standard 4,8,12,16,19 if missing
            const asiLevels = dataRow?.ASI || [4, 8, 12, 16, 19];

            // 3. Generate a card for every ASI level reached
            asiLevels.forEach(milestone => {
                if (milestone > lvl) return; // Skip if we haven't reached this level yet

                const card = document.createElement('div'); 
                card.className = 'card feat-card';
                card.innerHTML = `
                    <h3 class="card-title">${cls} - Lvl ${milestone} ASI/Feat</h3>
                    <input type="text" class="text-input feat-name" placeholder="Feat Name">
                    <table class="stat-table">
                        <thead>
                            <tr>${ATTRIBUTES.map(a => `<th>${a}</th>`).join('')}</tr>
                        </thead>
                        <tbody>
                            <tr>${ATTRIBUTES.map(a => `<td><select data-attr="${a}"><option value="0">0</option><option value="1">+1</option><option value="2">+2</option></select></td>`).join('')}
                            </tr>
                        </tbody>
                    </table>
                    <div style="margin-top: 10px;">
                        <label class="input-label" style="font-size:0.8em">Feat Features</label>
                        <div class="feat-features-container">
                            ${[1, 2, 3].map(i => `
                                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 8px; margin-bottom: 8px;">
                                    <select class="text-input feat-feature-type">
                                        <option value="none">None</option>
                                        <option value="language">Language</option>
                                        <option value="skill">Skill</option>
                                        <option value="tool proficiency">Tool Proficiency</option>
                                    </select>
                                    <input type="text" class="text-input feat-feature-name" placeholder="Feature Name">
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
                
                container.appendChild(card);

                // Restore saved data if it exists for this index
                if (saved && saved[idx]) {
                    const nameInput = card.querySelector('.feat-name');
                    if (nameInput) nameInput.value = saved[idx].name || "";
                    
                    ATTRIBUTES.forEach(a => {
                        const sel = card.querySelector(`select[data-attr="${a}"]`);
                        if (sel) sel.value = saved[idx].mods?.[a] || "0";
                    });
                    
                    // Restore features
                    const featureTypes = card.querySelectorAll('.feat-feature-type');
                    const featureNames = card.querySelectorAll('.feat-feature-name');
                    if (saved[idx].features) {
                        saved[idx].features.forEach((feat, i) => {
                            if (featureTypes[i]) featureTypes[i].value = feat.type || "none";
                            if (featureNames[i]) featureNames[i].value = feat.name || "";
                        });
                    }
                }
                idx++;
            });
        });
    };

    window.renderBaseAttributes = function (colId) {
        const container = document.getElementById(`attrs-container-${colId}`);
        
        // Helper to generate options 8-15 with cost in text
        const generateOptions = (selectedValue) => {
            let optionsHtml = '';
            for (let i = 8; i <= 15; i++) {
                const cost = POINT_COSTS[i];
                const isSelected = i === selectedValue ? 'selected' : '';
                optionsHtml += `<option value="${i}" ${isSelected}>${i} (${cost})</option>`;
            }
            return optionsHtml;
        };

        container.innerHTML = `
        <table class="stat-table">
            <thead>
                <tr>${ATTRIBUTES.map(a => `<th>${a}</th>`).join('')}</tr>
            </thead>
            <tbody>
                <tr>
                    ${ATTRIBUTES.map(a => `
                        <td>
                            <select id="attr-${colId}-${a}" class="text-input" 
                                style="width: 100%; padding: 4px; text-align: center;" 
                                onchange="window.calculatePointBuy('${colId}')">
                                ${generateOptions(10)}
                            </select>
                        </td>
                    `).join('')}
                </tr>
            </tbody>
        </table>`;
        
        // Run calculation immediately
        window.calculatePointBuy(colId);
    };

    window.calculatePointBuy = function (colId) {
        let spent = 0;
        ATTRIBUTES.forEach(a => {
            // We use .value just like before, but now it comes from a select
            const val = parseInt(document.getElementById(`attr-${colId}-${a}`).value);
            spent += POINT_COSTS[val] || 0;
        });

        const remaining = 27 - spent;
        const display = document.getElementById(`points-${colId}`);
        
        display.innerText = `${remaining} / 27 Pts`;

        if (remaining < 0) {
            display.style.color = '#e74c3c'; // Red
        } else if (remaining === 0) {
            display.style.color = '#2ecc71'; // Green
        } else {
            display.style.color = '#f39c12'; // Orange
        }
    };

    // COST CALCULATION FUNCTIONS
    window.toggleAccordion = function(id) {
        const content = document.getElementById(`${id}-content`);
        const icon = document.getElementById(`${id}-icon`);
        if (content.style.display === 'none') {
            content.style.display = 'block';
            icon.innerText = '▼';
        } else {
            content.style.display = 'none';
            icon.innerText = '▶';
        }
    };

    window.addCostRow = function(change = "", numChanges = 0, dtpCost = 0, goldCost = 0) {
        const tbody = document.getElementById('cost-table-body');
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><input type="text" class="text-input cost-change" value="${change}" style="width: 100%;"></td>
            <td><input type="number" class="text-input cost-num-changes" value="${numChanges}" min="0" style="width: 100%;" onchange="window.updateTotalCost()"></td>
            <td><input type="number" class="text-input cost-dtp" value="${dtpCost}" min="0" style="width: 100%;" onchange="window.updateTotalCost()"></td>
            <td><input type="number" class="text-input cost-gold" value="${goldCost}" min="0" style="width: 100%;" onchange="window.updateTotalCost()"></td>
            <td><button type="button" class="button" onclick="window.deleteCostRow(this)" style="background-color: #c0392b; color: #fff; padding: 4px 8px; font-size: 0.9em;">×</button></td>
        `;
        tbody.appendChild(row);
        window.updateTotalCost();
    };

    window.deleteCostRow = function(btn) {
        btn.closest('tr').remove();
        window.updateTotalCost();
    };

    window.updateTotalCost = function() {
        let totalChanges = 0;
        let totalDTP = 0;
        let totalGold = 0;
        
        document.querySelectorAll('#cost-table-body tr').forEach(row => {
            totalChanges += parseInt(row.querySelector('.cost-num-changes')?.value) || 0;
            totalDTP += parseInt(row.querySelector('.cost-dtp')?.value) || 0;
            totalGold += parseInt(row.querySelector('.cost-gold')?.value) || 0;
        });
        
        document.getElementById('total-changes').innerText = totalChanges;
        document.getElementById('total-dtp').innerText = totalDTP;
        document.getElementById('total-gold').innerText = totalGold;
    };

    window.getTotalLevel = function(classes) {
        return classes.reduce((sum, c) => sum + (parseInt(c.level) || 0), 0);
    };

    window.getAlacarteCost = function(level) {
        if (level >= 6 && level <= 6) return { gold: 160, dtp: 30 };
        if (level >= 7 && level <= 8) return { gold: 270, dtp: 30 };
        if (level >= 9 && level <= 10) return { gold: 400, dtp: 30 };
        if (level >= 11 && level <= 12) return { gold: 630, dtp: 40 };
        if (level >= 13 && level <= 14) return { gold: 810, dtp: 40 };
        if (level >= 15 && level <= 16) return { gold: 1030, dtp: 40 };
        if (level >= 17 && level <= 18) return { gold: 1270, dtp: 50 };
        if (level >= 19 && level <= 20) return { gold: 1530, dtp: 50 };
        return { gold: 0, dtp: 0 };
    };

    window.showError = function(message) {
        const errorDiv = document.getElementById('cost-error');
        errorDiv.innerText = message;
        errorDiv.style.display = 'block';
    };

    window.hideError = function() {
        document.getElementById('cost-error').style.display = 'none';
    };

    window.calculateCosts = function() {
        window.hideError();
        
        const reworkType = document.getElementById('rework-type').value;
        if (!reworkType) {
            window.showError('Please select a rework type first.');
            return;
        }
        
        // Clear existing rows
        document.getElementById('cost-table-body').innerHTML = '';
        
        const original = window.scrapeColumn('original');
        const newChar = window.scrapeColumn('new');
        
        const origLevel = window.getTotalLevel(original.classes || []);
        const newLevel = window.getTotalLevel(newChar.classes || []);
        
        // Helper function to check if any class is 2014 or 2024
        const has2014Class = (classes) => classes.some(c => c.version === '2014');
        const has2024Class = (classes) => classes.some(c => c.version === '2024');
        
        // 1. Below Level 6 Rework
        if (reworkType === 'level-5-below') {
            if (origLevel > 5 || newLevel > 5) {
                window.showError('Both original and new character must be level 5 or below for this rework type.');
                return;
            }
            window.addCostRow('Level 5 or Below Free Rework', 0, 0, 0);
            window.updateTotalCost();
            return;
        }
        
        // 2. 2024 Update Rework
        if (reworkType === '2024-update') {
            if (!has2014Class(original.classes || []) || !has2024Class(newChar.classes || [])) {
                window.showError('2024 Update requires original character to have 2014 classes and new character to have 2024 classes.');
                return;
            }
            window.addCostRow('2024 Update', 0, 0, 0);
            window.updateTotalCost();
            return;
        }
        
        // 3. T2 Checkpoint Rework
        if (reworkType === 't2-checkpoint') {
            // Original must be Tier 2 (6-10), New must be Tier 1 (1-5)
            if (origLevel < 6 || origLevel > 10) {
                window.showError('T2 Checkpoint requires original character to be Tier 2 (level 6-10).');
                return;
            }
            if (newLevel < 1 || newLevel > 5) {
                window.showError('T2 Checkpoint requires new character to be Tier 1 (level 1-5).');
                return;
            }
            window.addCostRow('T2 Checkpoint', 1, 150, 820);
            window.updateTotalCost();
            return;
        }
        
        // 4. T3 Checkpoint Rework
        if (reworkType === 't3-checkpoint') {
            // Original must be Tier 3 (11-16), New must be Tier 2 (6-10)
            if (origLevel < 11 || origLevel > 16) {
                window.showError('T3 Checkpoint requires original character to be Tier 3 (level 11-16).');
                return;
            }
            if (newLevel < 6 || newLevel > 10) {
                window.showError('T3 Checkpoint requires new character to be Tier 2 (level 6-10).');
                return;
            }
            window.addCostRow('T3 Checkpoint', 1, 180, 2400);
            window.updateTotalCost();
            return;
        }
        
        // 5. T4 Checkpoint Rework
        if (reworkType === 't4-checkpoint') {
            // Original must be Tier 4 (17-20), New must be Tier 3 (11-16)
            if (origLevel < 17 || origLevel > 20) {
                window.showError('T4 Checkpoint requires original character to be Tier 4 (level 17-20).');
                return;
            }
            if (newLevel < 11 || newLevel > 16) {
                window.showError('T4 Checkpoint requires new character to be Tier 3 (level 11-16).');
                return;
            }
            window.addCostRow('T4 Checkpoint', 1, 260, 4250);
            window.updateTotalCost();
            return;
        }
        
        // 6. A-la-carte calculation
        if (reworkType === 'alacarte') {
            const costPerChange = window.getAlacarteCost(origLevel);
            if (costPerChange.gold === 0) {
                window.showError('A-la-carte rework is only available for characters level 6 and above.');
                return;
            }
            
            let changes = [];
            
            // a. Character name change (2 changes)
            if (original.name !== newChar.name && original.name && newChar.name) {
                changes.push({ desc: `Character name change: ${original.name} → ${newChar.name}`, count: 2 });
            }
            
            // b. Base attribute change (2 changes)
            const changedAttrs = [];
            ATTRIBUTES.forEach(a => {
                if (original.attributes[a] !== newChar.attributes[a]) {
                    changedAttrs.push(a);
                }
            });
            if (changedAttrs.length > 0) {
                changes.push({ desc: `Starting ability score changes: ${changedAttrs.join(', ')}`, count: 2 });
            }
            
            // c. Race "section" change (1 change if anything changes)
            let raceChanged = false;
            if (original.race !== newChar.race) {
                raceChanged = true;
            } else {
                // Check racial bonuses
                ATTRIBUTES.forEach(a => {
                    if (original.race_mods[a] !== newChar.race_mods[a]) {
                        raceChanged = true;
                    }
                });
                
                // Check racial features
                const origRaceFeats = original.race_features || [];
                const newRaceFeats = newChar.race_features || [];
                if (origRaceFeats.length !== newRaceFeats.length) {
                    raceChanged = true;
                } else {
                    for (let i = 0; i < origRaceFeats.length; i++) {
                        const origFeat = origRaceFeats[i] || { type: 'none', name: '' };
                        const newFeat = newRaceFeats[i] || { type: 'none', name: '' };
                        if (origFeat.type !== newFeat.type || origFeat.name !== newFeat.name) {
                            raceChanged = true;
                            break;
                        }
                    }
                }
            }
            if (raceChanged) {
                changes.push({ desc: `Race/Species section changed`, count: 1 });
            }
            
            // d. Origin/Background "section" change (1 change if anything changes)
            let originChanged = false;
            if (original.bg !== newChar.bg) {
                originChanged = true;
            } else {
                // Check origin features
                const origOriginFeats = original.origin_features || [];
                const newOriginFeats = newChar.origin_features || [];
                if (origOriginFeats.length !== newOriginFeats.length) {
                    originChanged = true;
                } else {
                    for (let i = 0; i < origOriginFeats.length; i++) {
                        const origFeat = origOriginFeats[i] || { type: 'none', name: '' };
                        const newFeat = newOriginFeats[i] || { type: 'none', name: '' };
                        if (origFeat.type !== newFeat.type || origFeat.name !== newFeat.name) {
                            originChanged = true;
                            break;
                        }
                    }
                }
                
                // Check origin feat
                if (original.origin_feat !== newChar.origin_feat) {
                    originChanged = true;
                } else if (original.origin_feat) {
                    // Check origin feat modifiers
                    ATTRIBUTES.forEach(a => {
                        if (original.origin_mods[a] !== newChar.origin_mods[a]) {
                            originChanged = true;
                        }
                    });
                    
                    // Check origin feat features
                    const origOriginFeatFeats = original.origin_feat_features || [];
                    const newOriginFeatFeats = newChar.origin_feat_features || [];
                    if (origOriginFeatFeats.length !== newOriginFeatFeats.length) {
                        originChanged = true;
                    } else {
                        for (let i = 0; i < origOriginFeatFeats.length; i++) {
                            const origFeat = origOriginFeatFeats[i] || { type: 'none', name: '' };
                            const newFeat = newOriginFeatFeats[i] || { type: 'none', name: '' };
                            if (origFeat.type !== newFeat.type || origFeat.name !== newFeat.name) {
                                originChanged = true;
                                break;
                            }
                        }
                    }
                }
            }
            if (originChanged) {
                changes.push({ desc: `Origin/Background section changed`, count: 1 });
            }
            
            // e. Class/subclass-feat changes
            const origFeats = (original.feats || []).filter(f => f.name);
            const newFeats = (newChar.feats || []).filter(f => f.name);
            
            // Create a map of original feats by their class-subclass-name combo
            const origFeatMap = {};
            origFeats.forEach(f => {
                const key = `${f.source}-${f.name}`;
                if (!origFeatMap[key]) {
                    origFeatMap[key] = [];
                }
                origFeatMap[key].push(f);
            });
            
            // Check each new feat
            newFeats.forEach(newFeat => {
                const key = `${newFeat.source}-${newFeat.name}`;
                const origMatches = origFeatMap[key] || [];
                
                if (origMatches.length === 0) {
                    // New feat (not found on the left)
                    changes.push({ desc: `Feat added: ${newFeat.name} (${newFeat.source})`, count: 1 });
                } else {
                    // Find an unmatched original feat to compare
                    let matched = false;
                    for (let i = 0; i < origMatches.length; i++) {
                        const origFeat = origMatches[i];
                        if (!origFeat._matched) {
                            origFeat._matched = true;
                            matched = true;
                            
                            // Compare the details
                            let detailsChanged = false;
                            
                            // Check attribute changes
                            ATTRIBUTES.forEach(a => {
                                if ((origFeat.mods?.[a] || '0') !== (newFeat.mods?.[a] || '0')) {
                                    detailsChanged = true;
                                }
                            });
                            
                            // Check feat features
                            const origFeatFeats = origFeat.features || [];
                            const newFeatFeats = newFeat.features || [];
                            if (origFeatFeats.length !== newFeatFeats.length) {
                                detailsChanged = true;
                            } else {
                                for (let j = 0; j < origFeatFeats.length; j++) {
                                    const origF = origFeatFeats[j] || { type: 'none', name: '' };
                                    const newF = newFeatFeats[j] || { type: 'none', name: '' };
                                    if (origF.type !== newF.type || origF.name !== newF.name) {
                                        detailsChanged = true;
                                        break;
                                    }
                                }
                            }
                            
                            if (detailsChanged) {
                                changes.push({ desc: `Feat modified: ${newFeat.name} (${newFeat.source})`, count: 1 });
                            }
                            break;
                        }
                    }
                    
                    // If we couldn't find an unmatched original, treat as new
                    if (!matched) {
                        changes.push({ desc: `Feat added: ${newFeat.name} (${newFeat.source})`, count: 1 });
                    }
                }
            });
            
            // f. Multiply # of changes by cost by level
            changes.forEach(change => {
                const dtpCost = change.count * costPerChange.dtp;
                const goldCost = change.count * costPerChange.gold;
                window.addCostRow(change.desc, change.count, dtpCost, goldCost);
            });
            
            window.updateTotalCost();
        }
    };


    // UTILITIES
    window.getCurrentDiscordID = () => window.currentUser?.user_metadata.full_name || document.getElementById('manual-discord-id').value;
    window.copyValue = (s, t) => { document.getElementById(t).value = document.getElementById(s).value; };
    window.copyAttributes = () => { ATTRIBUTES.forEach(a => document.getElementById(`attr-new-${a}`).value = document.getElementById(`attr-original-${a}`).value); window.calculatePointBuy('new'); };
    window.copyMods = (type) => { ATTRIBUTES.forEach(a => { const s = document.querySelector(`.mod-select-${type}[data-col="original"][data-attr="${a}"]`), t = document.querySelector(`.mod-select-${type}[data-col="new"][data-attr="${a}"]`); if (s && t) t.value = s.value; }); };
    
    window.copyFeatures = (type) => {
        const sourceContainer = document.getElementById(`${type}-features-container-original`);
        const targetContainer = document.getElementById(`${type}-features-container-new`);
        if (!sourceContainer || !targetContainer) return;
        
        const sourceRows = sourceContainer.querySelectorAll('.feature-row');
        const targetRows = targetContainer.querySelectorAll('.feature-row');
        
        sourceRows.forEach((sourceRow, i) => {
            if (targetRows[i]) {
                const sourceType = sourceRow.querySelector('.feature-type');
                const sourceName = sourceRow.querySelector('.feature-name');
                const targetType = targetRows[i].querySelector('.feature-type');
                const targetName = targetRows[i].querySelector('.feature-name');
                
                if (sourceType && targetType) targetType.value = sourceType.value;
                if (sourceName && targetName) targetName.value = sourceName.value;
            }
        });
    };
    
    window.renderFeatureRows = (containerId, count = 4) => {
        const container = document.getElementById(containerId);
        if (!container) return;
        
        let html = '';
        for (let i = 0; i < count; i++) {
            html += `
                <div class="feature-row" style="display: grid; grid-template-columns: 1fr 2fr; gap: 8px; margin-bottom: 8px;">
                    <select class="text-input feature-type">
                        <option value="none">None</option>
                        <option value="language">Language</option>
                        <option value="skill">Skill</option>
                        <option value="tool proficiency">Tool Proficiency</option>
                    </select>
                    <input type="text" class="text-input feature-name" placeholder="Feature Name">
                </div>
            `;
        }
        container.innerHTML = html;
    };

    window.switchTab = (t) => {
        document.querySelectorAll('.tab-btn, .tab-content').forEach(el => el.classList.remove('active'));
        document.querySelector(`[onclick*="'${t}'"]`)?.classList.add('active');
        document.getElementById(`tab-${t}`).classList.add('active');
        if (t === 'output') window.generateOutput();
        if (t === 'cost') {
            // Only auto-calculate if the table is empty
            const tbody = document.getElementById('cost-table-body');
            if (!tbody || tbody.children.length === 0) {
                window.calculateCosts();
            }
        }
    };
    
    async function startApp() {
        try {
            const { data } = await supabase.from('lookups').select('data').eq('type', 'character').single();
            characterData = data?.data || [];
            ['original', 'new'].forEach(col => {
                window.renderBaseAttributes(col);
                document.getElementById(`race-mod-container-${col}`).innerHTML = `<table class="stat-table"><thead><tr>${ATTRIBUTES.map(a => `<th>${a}</th>`).join('')}</tr></thead><tbody><tr>${ATTRIBUTES.map(a => `<td><select class="mod-select-race" data-col="${col}" data-attr="${a}"><option value="0">0</option><option value="1">+1</option><option value="2">+2</option></select></td>`).join('')}</tr></tbody></table>`;
                document.getElementById(`origin-mod-container-${col}`).innerHTML = `<table class="stat-table"><thead><tr>${ATTRIBUTES.map(a => `<th>${a}</th>`).join('')}</tr></thead><tbody><tr>${ATTRIBUTES.map(a => `<td><select class="mod-select-origin" data-col="${col}" data-attr="${a}"><option value="0">0</option><option value="1">+1</option><option value="2">+2</option></select></td>`).join('')}</tr></tbody></table>`;
                
                // Initialize feature containers
                window.renderFeatureRows(`race-features-container-${col}`, 4);
                window.renderFeatureRows(`origin-features-container-${col}`, 4);
                window.renderFeatureRows(`origin-feat-features-container-${col}`, 4);
                
                window.addClassRow(col);
            });
        } catch (e) { console.error("App Init Error:", e); }
    }

    startApp();
</script>
    <input ty