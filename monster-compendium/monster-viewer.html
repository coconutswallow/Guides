---
layout: default
title: Monster Viewer
permalink: /monster-compendium/viewer.html
extra_css:
  - /assets/css/statblock.css
---

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<div class="viewer-container">
    <div class="viewer-controls">
        <a href="/monster-compendium/" class="back-link">← Back to Compendium</a>
        <div id="meta-controls"></div>
    </div>

    <div id="viewer-content" class="statblock-wrapper">
        <div class="loading-spinner">Summoning monster details...</div>
    </div>
</div>

<style>
    .viewer-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
    }
    .viewer-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--color-primary);
    }
    .back-link {
        font-family: var(--font-header);
        font-weight: bold;
        text-decoration: none;
        color: var(--color-primary);
    }
    .back-link:hover {
        color: var(--color-secondary);
    }
    /* Styles for the Statblock display */
    .statblock-wrapper {
        background: #fdf1dc;
        padding: 30px;
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    .monster-image-header {
        text-align: center;
        margin-bottom: 2em;
    }
    .monster-image-header img {
        max-height: 400px;
        max-width: 100%;
        border: 5px solid white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .status-warning {
        background: #fff3cd;
        color: #856404;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.9em;
        border: 1px solid #ffeeba;
    }
    .creator-credit {
        margin-top: 20px;
        font-style: italic;
        color: #666;
        text-align: right;
        font-size: 0.9em;
        border-top: 1px solid #ccc;
        padding-top: 10px;
    }
</style>

<script src="{{ '/assets/js/monster-calculator.js' | relative_url }}"></script>
<script src="{{ '/assets/js/monster-validator.js' | relative_url }}"></script>
<script src="{{ '/assets/js/monster-generator.js' | relative_url }}"></script>
<script src="{{ '/assets/js/monster-ui.js' | relative_url }}"></script>

<script>
    // --- CONFIGURATION ---
    const SUPABASE_URL = 'https://iepqxczcyvrxcbyeiscc.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImllcHF4Y3pjeXZyeGNieWVpc2NjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNjU2MDEsImV4cCI6MjA3OTk0MTYwMX0.9fK4TppNy7IekO3n4Uwd37dbqMQ7KRhFkex_P_JSeVA';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    document.addEventListener('DOMContentLoaded', async () => {
        const container = document.getElementById('viewer-content');
        const metaControls = document.getElementById('meta-controls');
        
        // 1. Get ID from URL
        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');

        if (!id) {
            container.innerHTML = '<p class="error">No monster ID specified.</p>';
            return;
        }

        try {
            // 2. Fetch Data from Supabase
            // We fetch the 'data' column (JSON) and 'status' metadata
            const { data: record, error } = await supabase
                .from('monsters')
                .select('*')
                .eq('id', id)
                .single();

            if (error) throw error;

            // 3. Prepare State
            // The JSON column 'data' holds the JS object structure
            const state = record.data;
            
            // 4. Calculate Modifiers on the fly
            // (The previewer needs calculated stats which aren't stored hardcoded in JSON)
            const abilities = MonsterCalculator.calculateAllAbilities(state);

            // 5. Render Visuals
            
            // A. Header Image (if exists)
            let html = '';
            if (state.image) {
                // Use WSrv.nl for resizing/optimization and onerror fallback
                const safeImgUrl = `https://wsrv.nl/?url=${encodeURIComponent(state.image)}&w=800&output=webp`;
                html += `
                    <div class="monster-image-header">
                        <img src="${safeImgUrl}" 
                             alt="${state.title}" 
                             onerror="this.style.display='none'">
                        ${state.image_credit ? `<div style="font-size:0.8em; color:#666;">Art Credit: ${state.image_credit}</div>` : ''}
                    </div>`;
            }

            // B. The Stat Block
            // MonsterUI.renderVisualStatBlock returns the HTML for the 2-column block + description
            html += MonsterUI.renderVisualStatBlock(state, abilities);

            // C. Footer / Credits
            html += `<div class="creator-credit">Created by: ${state.creator || 'Unknown'}</div>`;

            // 6. Inject HTML
            container.innerHTML = html;

            // 7. Handle Meta/Admin Controls
            if (record.status !== 'approved') {
                metaControls.innerHTML = `<span class="status-warning">⚠️ Status: ${record.status.toUpperCase()}</span>`;
            }

            // Update Page Title
            document.title = `${state.title} | Monster Compendium`;

        } catch (err) {
            console.error('Error fetching monster:', err);
            container.innerHTML = `
                <div style="text-align:center; padding: 40px;">
                    <h2>Monster Not Found</h2>
                    <p>This monster may have been deleted or is currently under revision.</p>
                    <a href="/monster-compendium/" class="tool-btn">Return to Index</a>
                </div>
            `;
        }
    });
</script>