---
layout: default
title: Monster View
permalink: /monster-compendium/view/
extra_css:
  - /assets/css/statblock.css
---

<div id="monster-viewer-container" style="max-width: 800px; margin: 0 auto; padding: 20px;">
    <div id="loading-state" style="text-align: center; font-style: italic; color: #666;">
        Loading monster details...
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="{{ '/assets/js/auth-manager.js' | relative_url }}?v=1"></script>
<script src="{{ '/assets/js/monster-calculator.js' | relative_url }}?v=1"></script>
<script src="{{ '/assets/js/monster-ui.js' | relative_url }}?v=1"></script>
<script src="{{ '/assets/js/monster-storage.js' | relative_url }}?v=1"></script>

<script>
document.addEventListener('DOMContentLoaded', async function() {
    const container = document.getElementById('monster-viewer-container');
    
    try {
        // 1. Check Dependencies
        if (typeof supabase === 'undefined') throw new Error("Supabase SDK not loaded.");
        if (!window.authManager) throw new Error("AuthManager not loaded.");
        if (!window.MonsterStorage) throw new Error("MonsterStorage not loaded. Check file path.");
        if (!window.MonsterUI) throw new Error("MonsterUI not loaded.");

        // 2. Get ID
        const params = new URLSearchParams(window.location.search);
        const monsterId = params.get('id');
        
        if (!monsterId) {
            container.innerHTML = `
                <div class="error-message">
                    <h3>⚠️ No Monster Selected</h3>
                    <p>Please return to the <a href="{{ '/monster-compendium/' | relative_url }}">Compendium</a>.</p>
                </div>`;
            return;
        }

        // 3. Fetch Data (Now wrapped in try/catch)
        console.log("Fetching monster:", monsterId);
        const result = await MonsterStorage.getMonsterById(monsterId);
        
        // Handle Supabase network/logic errors
        if (result.error) {
            console.error("Supabase Error:", result.error);
            throw new Error(result.error.message || "Database error");
        }
        
        if (!result.data) {
            container.innerHTML = `
                <div class="error-message">
                    <h3>❌ Monster Not Found</h3>
                    <p>This monster may have been deleted or is not approved for public viewing.</p>
                    <p><a href="{{ '/monster-compendium/' | relative_url }}">Return to Compendium</a></p>
                </div>`;
            return;
        }

        // 4. Render
        const data = result.data;
        const state = data.content;
        
        document.title = `${state.title} | Hawthorne Monster Compendium`;
        
        // Ensure UI function exists
        if (typeof MonsterUI.renderVisualStatBlock !== 'function') {
            throw new Error("MonsterUI.renderVisualStatBlock is missing. Did you update monster-ui.js?");
        }

        const abilities = MonsterCalculator.calculateAllAbilities(state);
        const statBlockHtml = MonsterUI.renderVisualStatBlock(state, abilities);

        container.innerHTML = `
            <div style="margin-bottom: 20px;">
                <a href="{{ '/monster-compendium/' | relative_url }}" style="text-decoration: none;">&larr; Back to Compendium</a>
            </div>
            ${statBlockHtml}
            <div style="margin-top: 40px; border-top: 1px solid #ccc; padding-top: 20px; font-size: 0.9em; color: #666;">
                <p><strong>Created by:</strong> ${MonsterUI.escapeHtml(state.creator)}</p>
                <p><strong>Version:</strong> ${data.version}</p>
                ${state.image_credit ? `<p><strong>Art Credit:</strong> ${MonsterUI.escapeHtml(state.image_credit)}</p>` : ''}
            </div>
        `;

    } catch (err) {
        console.error("View Page Error:", err);
        container.innerHTML = `
            <div style="background:#ffebee; border:1px solid red; padding:20px; text-align:center; color:#c62828;">
                <h3>⚠️ Error Loading Monster</h3>
                <p>${err.message}</p>
                <small>Check the browser console (F12) for details.</small>
            </div>
        `;
    }
});
</script>

<style>
/* Simple error styling */
.error-message {
    background: #fff1f0;
    border: 1px solid #ffa39e;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
}
</style>