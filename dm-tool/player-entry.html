<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player Session Entry</title>
    <link rel="stylesheet" href="assets/css/dm-tool.css">
    <style>
        body { padding: 20px; max-width: 600px; margin: 0 auto; background: #202225; color: #dcddde; }
        .container { background: #2f3136; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .hidden { display: none; }
        .tab-nav { display: flex; border-bottom: 2px solid #202225; margin-bottom: 20px; }
        .tab-btn { flex: 1; background: none; border: none; color: #72767d; padding: 10px; cursor: pointer; font-weight: bold; }
        .tab-btn.active { color: #fff; border-bottom: 2px solid #5865f2; }
        h2 { color: #fff; margin-top: 0; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-size: 0.9em; color: #b9bbbe; }
        input, textarea { width: 100%; padding: 10px; background: #202225; border: 1px solid #202225; color: #fff; border-radius: 4px; box-sizing: border-box; }
        input:focus { border-color: #5865f2; outline: none; }
        .btn-primary { width: 100%; padding: 12px; background: #5865f2; color: white; border: none; border-radius: 4px; font-size: 1rem; cursor: pointer; }
        .btn-primary:hover { background: #4752c4; }
        .status-msg { margin-top: 10px; text-align: center; font-size: 0.9em; height: 20px; }
        .login-screen { text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <div id="login-section" class="login-screen">
        <h2>Player Check-In</h2>
        <p style="color:#b9bbbe; margin-bottom: 20px;">Enter your Discord ID to access this session.</p>
        <div class="form-group">
            <input type="text" id="login-discord-id" placeholder="Your Discord ID (e.g. username123)">
        </div>
        <button class="btn-primary" id="btn-login">Start / Load</button>
    </div>

    <div id="form-section" class="hidden">
        <div class="tab-nav">
            <button class="tab-btn active" data-tab="tab-setup">1. Setup</button>
            <button class="tab-btn" data-tab="tab-end">2. End of Session</button>
        </div>

        <form id="player-form">
            <input type="hidden" id="p-discord-id">

            <div id="tab-setup" class="tab-content">
                <div class="form-group">
                    <label>Character Name</label>
                    <input type="text" id="p-char-name" placeholder="Character Name">
                </div>
                <div class="form-group" style="display:flex; gap:10px;">
                    <div style="flex:1;">
                        <label>Level</label>
                        <input type="number" id="p-level" placeholder="Current Level">
                    </div>
                    <div style="flex:1;">
                        <label>Playing As (Optional)</label>
                        <input type="number" id="p-level-as" placeholder="Lvl">
                    </div>
                </div>
                <div class="form-group">
                    <label>Games Played (Current Count)</label>
                    <input type="text" id="p-games" placeholder="e.g. 5">
                </div>
            </div>

            <div id="tab-end" class="tab-content hidden">
                <div class="form-group">
                    <label>Loot Rewarded</label>
                    <textarea id="p-loot" rows="3" placeholder="List loot items received..."></textarea>
                </div>
                <div class="form-group">
                    <label>Gold Spent/Earned (Optional)</label>
                    <input type="text" id="p-gold" placeholder="GP value">
                </div>
                <div class="form-group">
                    <label>Items Used</label>
                    <textarea id="p-items" rows="2" placeholder="Potions, scrolls, etc..."></textarea>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="p-notes" rows="2" placeholder="Private notes..."></textarea>
                </div>
            </div>

            <button type="button" class="btn-primary" id="btn-submit">Save Updates</button>
            <div id="status-message" class="status-msg"></div>
        </form>
    </div>
</div>

<script type="module">
    import { supabase } from './assets/js/supabaseClient.js';

    // 1. Get Session ID
    const params = new URLSearchParams(window.location.search);
    const sessionId = params.get('session_id');

    if(!sessionId) {
        document.body.innerHTML = "<h3 style='color:white; text-align:center;'>Error: No Session ID provided.</h3>";
    }

    // 2. UI Logic
    const loginSection = document.getElementById('login-section');
    const formSection = document.getElementById('form-section');
    const statusMsg = document.getElementById('status-message');

    // Tabs
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            btn.classList.add('active');
            document.getElementById(btn.dataset.tab).classList.remove('hidden');
        });
    });

    // 3. Login / Load Data
    document.getElementById('btn-login').addEventListener('click', async () => {
        const discordId = document.getElementById('login-discord-id').value.trim();
        if(!discordId) return alert("Please enter a Discord ID");

        document.getElementById('p-discord-id').value = discordId;

        // Fetch existing
        const { data, error } = await supabase
            .from('session_player_submissions')
            .select('payload')
            .eq('session_id', sessionId)
            .eq('discord_id', discordId)
            .single();

        if(data && data.payload) {
            populateForm(data.payload);
        }

        loginSection.classList.add('hidden');
        formSection.classList.remove('hidden');
    });

    function populateForm(p) {
        if(p.char_name) document.getElementById('p-char-name').value = p.char_name;
        if(p.level) document.getElementById('p-level').value = p.level;
        if(p.level_as) document.getElementById('p-level-as').value = p.level_as;
        if(p.games) document.getElementById('p-games').value = p.games;
        if(p.loot) document.getElementById('p-loot').value = p.loot;
        if(p.gold) document.getElementById('p-gold').value = p.gold;
        if(p.items) document.getElementById('p-items').value = p.items;
        if(p.notes) document.getElementById('p-notes').value = p.notes;
    }

    // 4. Submit / Save
    document.getElementById('btn-submit').addEventListener('click', async () => {
        const discordId = document.getElementById('p-discord-id').value;
        const payload = {
            char_name: document.getElementById('p-char-name').value,
            level: document.getElementById('p-level').value,
            level_as: document.getElementById('p-level-as').value,
            games: document.getElementById('p-games').value,
            loot: document.getElementById('p-loot').value,
            gold: document.getElementById('p-gold').value,
            items: document.getElementById('p-items').value,
            notes: document.getElementById('p-notes').value
        };

        statusMsg.textContent = "Saving...";
        statusMsg.style.color = "#fbbf24";

        const { error } = await supabase
            .from('session_player_submissions')
            .upsert({ 
                session_id: sessionId,
                discord_id: discordId,
                payload: payload,
                updated_at: new Date().toISOString()
            }, { onConflict: 'session_id, discord_id' });

        if(error) {
            console.error(error);
            statusMsg.textContent = "Error saving.";
            statusMsg.style.color = "#f87171";
        } else {
            statusMsg.textContent = "Saved successfully!";
            statusMsg.style.color = "#34d399";
        }
    });
</script>
</body>
</html>