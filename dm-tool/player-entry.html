<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player Session Entry</title>
    
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/dm-tool.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Almendra:wght@400;700&family=Source+Sans+3:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        /* Local overrides for the centered layout specifically */
        body {
            display: flex;
            justify-content: center;
            align-items: center; /* Vertically center */
            min-height: 100vh;
            padding: 20px;
            background-image: var(--page-bg-image, none); /* Inherits from style.css */
        }
        
        .entry-container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }

        .tab-content {
            animation: fadeIn 0.3s ease;
        }

        /* Ensure textareas in this view look consistent */
        textarea {
            resize: vertical;
        }

        .status-msg { 
            margin-top: 15px; 
            text-align: center; 
            font-weight: bold;
            min-height: 24px;
        }
        
        /* Helper to hide elements */
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="entry-container">
    
    <div class="card">
        
        <div class="site-title" style="color: var(--color-primary); text-align: center; margin-bottom: 1rem; text-shadow: none;">
            Player Check-In
        </div>

        <div id="login-section">
            <p style="text-align: center; color: var(--color-text-secondary); margin-bottom: 2rem;">
                Enter your Discord ID to access the session data.
            </p>
            
            <div class="form-group">
                <label>Discord ID</label>
                <input type="text" id="login-discord-id" placeholder="e.g. username123" class="table-input">
            </div>

            <div style="margin-top: 2rem;">
                <button type="button" class="button" id="btn-login" style="width: 100%;">Start / Load</button>
            </div>
        </div>

        <div id="form-section" class="hidden">
            
            <div class="content-tabs">
                <div class="content-tab active" data-tab="tab-character">1. Character</div>
                <div class="content-tab" data-tab="tab-session">2. Session</div>
            </div>

            <form id="player-form">
                <input type="hidden" id="p-discord-id">

                <div id="tab-character" class="tab-content">
                    <div class="form-group">
                        <label>Character Name</label>
                        <input type="text" id="p-char-name" class="table-input" placeholder="Character Name">
                    </div>
                    
                    <div class="form-row-full" style="gap: 1rem; margin-bottom: 15px;">
                        <div class="form-group flex-grow">
                            <label>Level</label>
                            <input type="number" id="p-level" class="table-input" placeholder="Actual">
                        </div>
                        <div class="form-group flex-grow">
                            <label>Playing As</label>
                            <input type="number" id="p-level-as" class="table-input" placeholder="Adjusted">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Number of Games on Server</label>
                        <input type="number" id="p-games" class="table-input" placeholder="Total games played">
                    </div>
                </div>

                <div id="tab-session" class="tab-content hidden">
                    <div class="form-group">
                        <label>Loot Acquired</label>
                        <textarea id="p-loot" rows="4" class="table-input" placeholder="List items, gold, or rewards received..."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Items Used</label>
                        <textarea id="p-items" rows="3" class="table-input" placeholder="Potions, scrolls, charges spent..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Character Notes</label>
                        <textarea id="p-notes" rows="3" class="table-input" placeholder="Private session notes..."></textarea>
                    </div>
                </div>

                <hr style="border-color: var(--color-border); margin: 2rem 0;">

                <button type="button" class="button" id="btn-submit" style="width: 100%;">Save Updates</button>
                <div id="status-message" class="status-msg"></div>
            </form>
        </div>

    </div>
    
    <button class="theme-toggle" id="theme-toggle" aria-label="Toggle Dark Mode">
        <span class="sun-icon">‚òÄÔ∏è</span>
        <span class="moon-icon">üåô</span>
    </button>
</div>

<script type="module">
    // 1. Import Supabase (Adjusted path for /dm-tool/ folder structure)
    import { supabase } from '../assets/js/supabaseClient.js';

    // 2. Theme Toggle Logic (Matches site standard)
    const toggleBtn = document.getElementById('theme-toggle');
    const htmlEl = document.documentElement;
    
    // Check local storage or default
    if (localStorage.getItem('theme') === 'dark') {
        htmlEl.setAttribute('data-theme', 'dark');
    }

    toggleBtn.addEventListener('click', () => {
        const currentTheme = htmlEl.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        htmlEl.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
    });

    // 3. Application Logic
    const params = new URLSearchParams(window.location.search);
    const sessionId = params.get('session_id');

    // UI References
    const loginSection = document.getElementById('login-section');
    const formSection = document.getElementById('form-section');
    const statusMsg = document.getElementById('status-message');
    const btnLogin = document.getElementById('btn-login');
    const btnSubmit = document.getElementById('btn-submit');

    // Tab Logic
    document.querySelectorAll('.content-tab').forEach(btn => {
        btn.addEventListener('click', () => {
            // Remove active class from all tabs
            document.querySelectorAll('.content-tab').forEach(b => b.classList.remove('active'));
            // Hide all contents
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            
            // Activate clicked
            btn.classList.add('active');
            const targetId = btn.dataset.tab;
            document.getElementById(targetId).classList.remove('hidden');
        });
    });

    // Login Handler
    btnLogin.addEventListener('click', async () => {
        const discordId = document.getElementById('login-discord-id').value.trim();
        
        if (!sessionId) {
            alert("Error: No Session ID found in URL. Please use the link provided by your DM.");
            return;
        }

        if (!discordId) {
            alert("Please enter your Discord ID.");
            return;
        }

        document.getElementById('p-discord-id').value = discordId;
        btnLogin.textContent = "Loading...";
        btnLogin.disabled = true;

        try {
            // Check for existing submission
            const { data, error } = await supabase
                .from('session_player_submissions')
                .select('payload')
                .eq('session_id', sessionId)
                .eq('discord_id', discordId)
                .maybeSingle();

            if (error) throw error;

            if (data && data.payload) {
                populateForm(data.payload);
            }

            // Transition UI
            loginSection.classList.add('hidden');
            formSection.classList.remove('hidden');

        } catch (err) {
            console.error(err);
            alert("Error loading data. Check console for details.");
            btnLogin.textContent = "Start / Load";
            btnLogin.disabled = false;
        }
    });

    function populateForm(p) {
        if(p.char_name) document.getElementById('p-char-name').value = p.char_name;
        if(p.level) document.getElementById('p-level').value = p.level;
        if(p.level_as) document.getElementById('p-level-as').value = p.level_as;
        if(p.games) document.getElementById('p-games').value = p.games;
        if(p.loot) document.getElementById('p-loot').value = p.loot;
        if(p.items) document.getElementById('p-items').value = p.items;
        if(p.notes) document.getElementById('p-notes').value = p.notes;
    }

    // Save Handler
    btnSubmit.addEventListener('click', async () => {
        const discordId = document.getElementById('p-discord-id').value;
        
        const payload = {
            char_name: document.getElementById('p-char-name').value,
            level: document.getElementById('p-level').value,
            level_as: document.getElementById('p-level-as').value,
            games: document.getElementById('p-games').value,
            loot: document.getElementById('p-loot').value,
            items: document.getElementById('p-items').value,
            notes: document.getElementById('p-notes').value
        };

        statusMsg.textContent = "Saving...";
        statusMsg.style.color = "var(--palette-role-auditor)"; // Orange/Warning color from CSS vars

        try {
            const { error } = await supabase
                .from('session_player_submissions')
                .upsert({ 
                    session_id: sessionId,
                    discord_id: discordId,
                    payload: payload,
                    updated_at: new Date().toISOString()
                }, { onConflict: 'session_id, discord_id' });

            if(error) throw error;

            statusMsg.textContent = "Saved successfully!";
            statusMsg.style.color = "var(--palette-role-full-dm)"; // Green color
            
            // Optional: Reset message after a few seconds
            setTimeout(() => { statusMsg.textContent = ""; }, 3000);

        } catch (err) {
            console.error(err);
            statusMsg.textContent = "Error saving data.";
            statusMsg.style.color = "var(--palette-alert-danger-action)";
        }
    });
</script>

</body>
</html>