---
layout: null
title: Player Session Entry
---
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page.title }}</title>
    
    <link rel="stylesheet" href="{{ '/assets/css/style.css' | relative_url }}">
    <link rel="stylesheet" href="{{ '/assets/css/dm-tool.css' | relative_url }}">
    
    <link href="https://fonts.googleapis.com/css2?family=Almendra:wght@400;700&family=Source+Sans+3:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        /* Layout Overrides */
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background-image: var(--page-bg-image, none);
            padding-top: 40px;
        }
        
        .entry-container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            position: relative;
        }

        .auth-header-container {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 15px;
        }

        .session-info {
            text-align: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--color-border);
        }
        
        .session-name {
            font-family: var(--font-header);
            font-size: 1.8rem;
            color: var(--color-primary);
            line-height: 1.2;
            margin-bottom: 0.5rem;
            min-height: 2rem;
        }
        
        .dm-name {
            color: var(--color-text-secondary);
            font-size: 1rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Message shown when not logged in */
        #guest-message {
            text-align: center;
            color: var(--color-text-secondary);
            padding: 2rem;
            font-style: italic;
        }

        .hidden { display: none !important; }
        
        .skeleton {
            color: transparent !important;
            background-color: var(--color-bg-medium);
            border-radius: 4px;
            animation: pulse 1.5s infinite;
            pointer-events: none;
            user-select: none;
        }

        /* Incentives Checkbox List Styling */
        .checkbox-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            background: var(--color-bg-light);
            border: 1px solid var(--color-border);
            padding: 0.5rem;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95em;
            cursor: pointer;
            padding: 4px;
        }
        
        .checkbox-item input {
            cursor: pointer;
            width: 16px;
            height: 16px;
        }

        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 0.3; }
            100% { opacity: 0.6; }
        }
    </style>
</head>
<body>

    <div class="entry-container">
        
        <div class="auth-header-container">
            {% include auth-header.html %}
        </div>
        
        <div class="card">
            
            <div class="session-info">
                <div id="display-session-name" class="session-name skeleton">Loading Session...</div>
                <div class="dm-name">DM: <span id="display-dm-name" class="skeleton">...</span></div>
            </div>

            <div id="guest-message">
                Please log in above to access this session.
            </div>

            <div id="form-section" class="hidden">
                <div class="content-tabs">
                    <div class="content-tab active" data-tab="tab-character">1. Character</div>
                    <div class="content-tab" data-tab="tab-session">2. Session</div>
                </div>

                <form id="player-form">
                    <input type="hidden" id="p-discord-id">
                    
                    <div style="text-align: center; margin-bottom: 1rem; font-size: 0.9em; color: var(--color-primary);">
                        Playing as: <strong id="current-player-display">Loading...</strong>
                    </div>

                    <div id="tab-character" class="tab-content">
                        <div class="form-group">
                            <label>Character Name</label>
                            <input type="text" id="p-char-name" class="table-input" placeholder="Character Name">
                        </div>
                        
                        <div class="form-row-full" style="gap: 1rem; margin-bottom: 15px;">
                            <div class="form-group flex-grow">
                                <label>Level (1-20)</label>
                                <input type="number" id="p-level" class="table-input" placeholder="Actual" min="1" max="20">
                            </div>
                            <div class="form-group flex-grow">
                                <label>Playing As (1-20)</label>
                                <input type="number" id="p-level-as" class="table-input" placeholder="Adjusted" min="1" max="20">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Number of Games on Server</label>
                            <select id="p-games" class="table-input">
                                <option value="" disabled selected>Select...</option>
                                <option value="0">0</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                                <option value="10+">10+</option>
                            </select>
                        </div>
                    </div>

                    <div id="tab-session" class="tab-content hidden">
                        <div class="form-group">
                            <label>Loot Acquired</label>
                            <textarea id="p-loot" rows="3" class="table-input" placeholder="List items or rewards received..."></textarea>
                        </div>

                        <div class="form-group">
                            <label>Gold Acquired</label>
                            <input type="text" id="p-gold" class="table-input" placeholder="e.g. 50gp">
                        </div>

                        <div class="form-group">
                            <label>Items Used</label>
                            <textarea id="p-items" rows="3" class="table-input" placeholder="Potions, scrolls, charges spent..."></textarea>
                        </div>

                        <div class="form-group">
                            <label>Player Incentives (If Any)</label>
                            <div id="incentives-container" class="checkbox-list">
                                <div style="color:var(--color-text-secondary); padding:5px;">Loading options...</div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Character Outcomes Notes</label>
                            <textarea id="p-notes" rows="3" class="table-input" placeholder="Private session notes..."></textarea>
                        </div>
                    </div>

                    <hr style="border-color: var(--color-border); margin: 2rem 0;">

                    <button type="button" class="button" id="btn-submit" style="width: 100%;">Save Updates</button>
                    <div id="status-message" style="margin-top:15px; text-align:center; font-weight:bold; min-height:24px;"></div>
                </form>
            </div>
        </div>
        
        <button class="theme-toggle" id="theme-toggle" aria-label="Toggle Dark Mode">
            <span class="sun-icon">‚òÄÔ∏è</span>
            <span class="moon-icon">üåô</span>
        </button>
    </div>

<script type="module" src="{{ '/assets/js/auth-manager.js' | relative_url }}"></script>
<script type="module">
    import { supabase } from "{{ '/assets/js/supabaseClient.js' | relative_url }}";

    // GLOBAL UI REFERENCES
    const ui = {
        sessionName: document.getElementById('display-session-name'),
        dmNameContainer: document.querySelector('.dm-name'), 
        dmNameSpan: document.getElementById('display-dm-name'),
        status: document.getElementById('status-message'),
        incentivesContainer: document.getElementById('incentives-container')
    };

    // 0. PATCH AUTH LOGIN (Preserves Session ID in URL)
    const patchLogin = () => {
        if(window.authManager) {
            window.authManager.login = async function() {
                // FIX: Strip the hash (#) from the current URL to prevent double hashes (##) on re-login
                const currentUrl = window.location.origin + window.location.pathname + window.location.search;
                
                await this.client.auth.signInWithOAuth({
                    provider: 'discord',
                    options: { redirectTo: currentUrl, scopes: 'guilds guilds.members.read' }
                });
            };
        } else {
            setTimeout(patchLogin, 50);
        }
    };
    patchLogin();

    // 1. GLOBAL UI HANDLERS (Theme, Tabs)
    const toggleBtn = document.getElementById('theme-toggle');
    const htmlEl = document.documentElement;
    
    if (localStorage.getItem('theme') === 'dark') htmlEl.setAttribute('data-theme', 'dark');

    toggleBtn.addEventListener('click', () => {
        const currentTheme = htmlEl.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        htmlEl.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
    });

    document.querySelectorAll('.content-tab').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.content-tab').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            btn.classList.add('active');
            document.getElementById(btn.dataset.tab).classList.remove('hidden');
        });
    });

    // 2. PAGE AUTH HOOK
    window.handlePageAuth = async function(user) {
        const formSection = document.getElementById('form-section');
        const currentPlayer = document.getElementById('current-player-display');
        const discordIdInput = document.getElementById('p-discord-id');

        if (user) {
            // === AUTHENTICATED STATE ===
            ui.sessionName.classList.add('skeleton');
            ui.sessionName.style.fontSize = ""; 
            ui.sessionName.style.color = "";    
            ui.dmNameContainer.style.display = 'block'; 

            fetchSessionMetadata();
            fetchIncentivesOptions(); // Fetch lookups

            try {
                const { data: userData, error: userError } = await supabase
                    .from('discord_users')
                    .select('discord_id, display_name')
                    .eq('user_id', user.id)
                    .single();

                if (userError || !userData) {
                    console.error("Identity Error:", userError);
                    currentPlayer.textContent = "Error loading Identity";
                    return;
                }

                currentPlayer.textContent = `${userData.display_name} (Verified)`;
                discordIdInput.value = userData.discord_id;

                // Load existing data AFTER fetching incentives to ensure checkboxes exist
                setTimeout(() => {
                    loadPlayerData(userData.discord_id);
                }, 500);
                
                formSection.classList.remove('hidden');

            } catch (err) {
                console.error("Auth Logic Error:", err);
            }
        } else {
            // === GUEST / LOGGED OUT STATE ===
            ui.sessionName.textContent = "A DM has invited you to join their game! Login to enter your character and session details";
            ui.sessionName.classList.remove('skeleton');
            ui.sessionName.style.fontSize = "1.2rem";
            ui.sessionName.style.lineHeight = "1.5";
            ui.dmNameContainer.style.display = 'none';
            formSection.classList.add('hidden');
        }
    };

    // 3. INITIALIZATION
    const params = new URLSearchParams(window.location.search);
    const sessionId = params.get('session_id');

    if (!sessionId) {
        ui.sessionName.textContent = "Error: No Session ID";
        ui.sessionName.classList.remove('skeleton');
        ui.sessionName.style.color = "var(--palette-alert-danger-action)";
    }

    // 4. DATA FUNCTIONS
    async function fetchSessionMetadata() {
        if(!sessionId) return;
        try {
            const { data: session, error: sErr } = await supabase
                .from('session_logs')
                .select('title, user_id') 
                .eq('id', sessionId)
                .single();

            if (sErr || !session) throw sErr;

            ui.sessionName.textContent = session.title;
            ui.sessionName.classList.remove('skeleton');

            if (session.user_id) {
                const { data: dm } = await supabase
                    .from('discord_users')
                    .select('display_name')
                    .eq('user_id', session.user_id)
                    .single();
                
                ui.dmNameSpan.textContent = dm ? dm.display_name : "Unknown DM";
            } else {
                ui.dmNameSpan.textContent = "N/A";
            }
            ui.dmNameSpan.classList.remove('skeleton');

        } catch (err) {
            console.warn("Session Fetch Error:", err.message);
        }
    }

    async function fetchIncentivesOptions() {
        try {
            const { data, error } = await supabase
                .from('lookups')
                .select('data')
                .eq('type', 'dm-tool')
                .single();

            if (error || !data || !data.data || !data.data['player incentives']) {
                ui.incentivesContainer.innerHTML = '<div style="color:var(--color-text-secondary); font-style:italic;">None available</div>';
                return;
            }

            const incentivesMap = data.data['player incentives'];
            const incentiveKeys = Object.keys(incentivesMap);

            if (incentiveKeys.length === 0) {
                 ui.incentivesContainer.innerHTML = '<div style="color:var(--color-text-secondary); font-style:italic;">None available</div>';
                 return;
            }

            // Build Checkboxes
            let html = '';
            incentiveKeys.forEach(key => {
                html += `
                    <label class="checkbox-item">
                        <input type="checkbox" name="incentive" value="${key}">
                        ${key}
                    </label>
                `;
            });
            ui.incentivesContainer.innerHTML = html;

        } catch (e) {
            console.error("Error fetching incentives:", e);
        }
    }

    async function loadPlayerData(discordId) {
        if(!sessionId || !discordId) return;

        try {
            const { data, error } = await supabase
                .from('session_player_submissions')
                .select('payload')
                .eq('session_id', sessionId)
                .eq('discord_id', discordId)
                .maybeSingle();

            if (data && data.payload) {
                populateForm(data.payload);
            }
        } catch (err) {
            console.error("Load Player Data Error", err);
        }
    }

    function populateForm(p) {
        if(p.char_name) document.getElementById('p-char-name').value = p.char_name;
        if(p.level) document.getElementById('p-level').value = p.level;
        if(p.level_as) document.getElementById('p-level-as').value = p.level_as;
        if(p.games) document.getElementById('p-games').value = p.games;
        if(p.loot) document.getElementById('p-loot').value = p.loot;
        if(p.gold) document.getElementById('p-gold').value = p.gold; // New Field
        if(p.items) document.getElementById('p-items').value = p.items;
        if(p.notes) document.getElementById('p-notes').value = p.notes;
        
        // Populate Incentives Checkboxes
        if (p.incentives && Array.isArray(p.incentives)) {
            const checkboxes = document.querySelectorAll('input[name="incentive"]');
            checkboxes.forEach(cb => {
                if (p.incentives.includes(cb.value)) {
                    cb.checked = true;
                }
            });
        }
    }

    document.getElementById('btn-submit').addEventListener('click', async () => {
        const discordId = document.getElementById('p-discord-id').value;
        
        if (!discordId) {
            alert("Error: Missing verified identity. Please refresh.");
            return;
        }

        // VALIDATION: Level Range 1-20
        const level = parseInt(document.getElementById('p-level').value);
        const levelAs = parseInt(document.getElementById('p-level-as').value);

        if (level < 1 || level > 20 || isNaN(level)) {
            alert("Character Level must be between 1 and 20.");
            return;
        }
        if (levelAs < 1 || levelAs > 20 || isNaN(levelAs)) {
            alert("'Playing As' level must be between 1 and 20.");
            return;
        }

        // Collect Selected Incentives
        const selectedIncentives = [];
        document.querySelectorAll('input[name="incentive"]:checked').forEach(cb => {
            selectedIncentives.push(cb.value);
        });

        const payload = {
            char_name: document.getElementById('p-char-name').value,
            level: level,
            level_as: levelAs,
            games: document.getElementById('p-games').value,
            loot: document.getElementById('p-loot').value,
            gold: document.getElementById('p-gold').value,
            items: document.getElementById('p-items').value,
            incentives: selectedIncentives,
            notes: document.getElementById('p-notes').value
        };

        ui.status.textContent = "Saving...";
        ui.status.style.color = "var(--palette-role-auditor)";

        try {
            const { error } = await supabase
                .from('session_player_submissions')
                .upsert({ 
                    session_id: sessionId,
                    discord_id: discordId,
                    payload: payload,
                    updated_at: new Date().toISOString()
                }, { onConflict: 'session_id, discord_id' });

            if(error) throw error;

            ui.status.textContent = "Saved successfully!";
            ui.status.style.color = "var(--palette-role-full-dm)";
            setTimeout(() => { ui.status.textContent = ""; }, 3000);

        } catch (err) {
            console.error(err);
            ui.status.textContent = "Error saving data.";
            ui.status.style.color = "var(--palette-alert-danger-action)";
        }
    });
</script>

</body>
</html>