---
layout: default
title: Character Rework Tool
---

<link rel="stylesheet" href="{{ '/assets/css/rework.css' | relative_url }}">

<div class="page">
    <h1>Character Rework Tool</h1>
    
    {% include auth-header.html %}
    
    <div class="tab-nav">
        <button class="tab-btn active" onclick="window.switchTab('input')">Input</button>
        <button class="tab-btn" onclick="window.switchTab('output')">Output</button>
    </div>

    <div id="tab-input" class="tab-content active">
        
        <div class="control-bar" id="controls-area">
            <div id="logged-out-controls" class="control-group" style="display:none; align-items:center; gap: 10px;">
               <button id="custom-login-btn" class="auth-btn auth-btn-discord" onclick="window.authManager.login()">
                    Login to Save
               </button>
               <span style="font-size:0.9em; margin-left:10px;"> Or enter Discord ID manually: </span>
               <input type="text" id="manual-discord-id" class="text-input" style="width: 150px;" placeholder="Username">
            </div>

            <div id="logged-in-controls" class="control-group" style="display:none;">
                <button class="action-btn btn-save" onclick="window.saveRework()">Save</button>
                <button class="action-btn btn-load" onclick="window.loadSelectedRework()">Load</button>
                <select id="load-rework-select" class="load-select">
                    <option value="">-- Load Saved Rework --</option>
                </select>
            </div>

            <div id="auth-error-msg" class="control-group" style="display:none; color: #e74c3c; font-weight: bold;">
                <span>"Adventurer" role required to Save/Load.</span>
            </div>
        </div>

        <input type="hidden" id="current-rework-id" value="">

        <div class="respec-container">
            <div class="char-column" id="col-original">
                <h2 class="column-header">Original Character</h2>
                <div class="card">
                    <h3 class="card-title">Character Origin</h3>
                    <div class="origin-grid">
                        <div class="input-group">
                            <label class="input-label">Character Name</label>
                            <input type="text" class="text-input" id="name-original" placeholder="Name">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Base Attributes (27 Point Buy)</label>
                            <div id="attrs-container-original"></div>
                            <div class="points-display" id="points-original">Points Remaining: 27</div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Race/Species</label>
                            <input type="text" class="text-input" id="race-original" placeholder="e.g. Human, Elf...">
                        </div>
                        <div class="input-group" id="block-race-original">
                            <label class="input-label">Racial Bonuses</label>
                            <div id="race-mod-container-original"></div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Origin (Background)</label>
                            <input type="text" class="text-input" id="bg-original" placeholder="e.g. Acolyte">
                        </div>
                        <div class="input-group" id="block-origin-original">
                            <label class="input-label">Origin Feat Modifiers</label>
                            <input type="text" class="text-input" id="orig-feat-original" placeholder="e.g. Magic Initiate">
                            <div id="origin-mod-container-original" style="margin-top:10px;"></div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h3 class="card-title">Classes</h3>
                    <div id="classes-container-original"></div>
                    <button type="button" class="button button-secondary" onclick="window.addClassRow('original')">+ Add Class</button>
                </div>
                <div id="feats-container-original"></div>
            </div>

            <div class="char-column" id="col-new">
                <h2 class="column-header">New Character</h2>
                <div class="card">
                    <h3 class="card-title">Character Origin</h3>
                    <div class="origin-grid">
                        <div class="input-group">
                            <div class="field-header-row">
                                <label class="input-label">Character Name</label>
                                <button type="button" class="copy-link" onclick="window.copyValue('name-original', 'name-new')">Copy</button>
                            </div>
                            <input type="text" class="text-input" id="name-new" placeholder="Name">
                        </div>
                        <div class="input-group">
                            <div class="field-header-row">
                                <label class="input-label">Base Attributes</label>
                                <button type="button" class="copy-link" onclick="window.copyAttributes()">Copy</button>
                            </div>
                            <div id="attrs-container-new"></div>
                            <div class="points-display" id="points-new">Points Remaining: 27</div>
                        </div>
                        <div id="race-mod-container-new"></div>
                        <div id="classes-container-new"></div>
                        <div id="feats-container-new"></div>
                    </div>
                </div>
                <button type="button" class="button button-secondary" onclick="window.addClassRow('new')">+ Add Class</button>
            </div>
        </div>

        <div class="card" style="margin-top: 2rem;">
            <h3 class="card-title">Rework Details</h3>
            <input type="text" id="rework-cost" class="text-input" placeholder="GP/DTP Costs">
            <textarea id="rework-notes" class="notes-area" placeholder="Notes for auditors"></textarea>
        </div>
    </div>

    <div id="tab-output" class="tab-content">
        <h2 class="column-header">Rework Request Form</h2>
        <textarea id="output-text" class="output-area" readonly></textarea>
        <button class="action-btn" onclick="window.copyOutput()">Copy to Clipboard</button>
    </div>
</div>

<script type="module" src="{{ '/assets/js/auth-manager.js' | relative_url }}"></script>

<script>
    // 1. AUTH LOGIC: Switches the visibility of controls, but leaves the tool visible
    window.handlePageAuth = function(user, profile) {
        window.currentUser = user;
        const REQUIRED_ROLE = "Adventurer";

        const loggedOutGroup = document.getElementById('logged-out-controls');
        const loggedInGroup = document.getElementById('logged-in-controls');
        const authErrorGroup = document.getElementById('auth-error-msg');
        const manualInput = document.getElementById('manual-discord-id');

        // Reset
        loggedOutGroup.style.display = 'none';
        loggedInGroup.style.display = 'none';
        authErrorGroup.style.display = 'none';

        if (user) {
            const userRoles = (profile && profile.roles) ? profile.roles : [];
            if (userRoles.includes(REQUIRED_ROLE)) {
                loggedInGroup.style.display = 'flex';
                if(window.fetchReworks) window.fetchReworks();
            } else {
                authErrorGroup.style.display = 'flex';
            }
        } else {
            loggedOutGroup.style.display = 'flex';
        }
    };

    // 2. DISCORD ID LOGIC: Uses profile ID or Manual Input
    window.getCurrentDiscordID = function() {
        if (window.currentUser && window.authManager?.profile?.discord_id) {
            return window.authManager.profile.discord_id;
        } 
        return document.getElementById('manual-discord-id')?.value.trim();
    };
</script>

<script type="module">
    import { supabase } from "{{ '/assets/js/supabaseClient.js' | relative_url }}";
    // ... paste all your original logic here (ATTRIBUTES, POINT_COSTS, scrapeColumn, etc) ...
</script>