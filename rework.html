---
layout: default
title: Character Rework Tool
extra_css:
  - "{{ '/assets/css/style.css' | relative_url }}"
---

<style>
    /* Page Specific Styles */
    .respec-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-top: 2rem;
    }

    @media (max-width: 1000px) {
        .respec-container {
            grid-template-columns: 1fr;
        }
    }

    .char-column {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .column-header {
        text-align: center;
        border-bottom: 2px solid var(--color-primary);
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
        color: var(--color-primary);
        font-family: var(--font-header);
    }

    /* Unified Origin Block Styles */
    .origin-grid {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .input-group {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }
    
    .input-label {
        font-size: 0.9em;
        font-weight: bold;
        color: var(--color-text-secondary);
        text-transform: uppercase;
        display: flex;
        justify-content: space-between;
    }

    .text-input {
        width: 100%;
        padding: 8px;
        border: 1px solid var(--color-border);
        border-radius: 4px;
        background: var(--color-bg-page);
        color: var(--color-text);
    }
    
    .notes-area {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--color-border);
        border-radius: 4px;
        background: var(--color-bg-page);
        color: var(--color-text);
        resize: vertical;
        min-height: 100px;
        font-family: var(--font-body);
    }

    /* Tables */
    .stat-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 0.5rem;
        font-size: 0.9em;
    }

    .stat-table th {
        background: var(--color-primary);
        color: white;
        padding: 6px;
        text-align: center;
        border: 1px solid var(--color-primary);
    }

    .stat-table td {
        padding: 6px;
        text-align: center;
        border: 1px solid var(--color-border);
        background: var(--color-bg-medium);
    }

    /* Final Stats Table (Highlight) */
    .final-stats-table th {
        background: var(--color-secondary);
    }
    .final-stats-table td {
        font-weight: bold;
        font-size: 1.1em;
        background: var(--color-bg-page);
    }

    /* Attribute Inputs inside table */
    .attr-input-cell {
        width: 100%;
        max-width: 60px;
        text-align: center;
        padding: 4px;
        border: 1px solid var(--color-border);
        font-weight: bold;
    }

    /* Mod Dropdowns inside table */
    .mod-select-cell {
        width: 100%;
        text-align: center;
        padding: 4px;
        border: 1px solid var(--color-border);
        background: var(--color-bg-page);
        color: var(--color-text);
        cursor: pointer;
    }

    .points-display {
        text-align: center;
        font-weight: bold;
        padding: 0.5rem;
        margin-top: 0.5rem;
        background: var(--color-bg-page);
        border: 1px dashed var(--color-border);
        border-radius: 4px;
    }
    
    .points-display.error {
        color: #e74c3c;
        border-color: #e74c3c;
        background: #fadbd8;
    }

    .block-warning {
        font-size: 0.8em;
        color: #e74c3c;
        font-style: italic;
        display: none;
    }
    .block-warning.active {
        display: inline;
    }

    /* Class Section */
    .class-row {
        display: grid;
        grid-template-columns: 2fr 1fr auto;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        align-items: center;
        padding: 10px;
        background: var(--color-bg-medium);
        border: 1px solid var(--color-border);
        border-radius: 4px;
    }

    .class-select, .level-input {
        padding: 8px;
        border: 1px solid var(--color-border);
        background: var(--color-bg-page);
        color: var(--color-text);
        border-radius: 4px;
    }

    .remove-class-btn {
        background: #e74c3c;
        color: white;
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Feat Cards */
    .feat-card {
        background: var(--color-bg-medium);
        border: 2px solid var(--color-border);
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .feat-header {
        font-weight: bold;
        color: var(--color-primary);
        border-bottom: 2px solid var(--color-border);
        padding-bottom: 0.25rem;
        margin-bottom: 0.5rem;
    }
</style>

<div class="page">
    <h1>Character Rework Tool</h1>
    <p>Use this tool to compare your original character build against a new specialization.</p>

    <div class="respec-container">
        
        <div class="char-column" id="col-original">
            <h2 class="column-header">Original Character</h2>

            <div class="card">
                <h3 class="card-title">Final Attributes</h3>
                <div id="final-stats-container-original">
                    </div>
            </div>

            <div class="card">
                <h3 class="card-title">Character Origin</h3>
                <div class="origin-grid">
                    
                    <div class="input-group">
                        <label class="input-label">Race</label>
                        <input type="text" class="text-input" placeholder="e.g. Human, Elf...">
                    </div>

                    <div class="input-group">
                        <label class="input-label">Base Attributes (27 Point Buy)</label>
                        <div id="attrs-container-original">
                            </div>
                        <div class="points-display" id="points-original">Points Remaining: 27</div>
                    </div>

                    <div class="input-group" id="block-race-original">
                        <label class="input-label">
                            Racial Bonuses 
                            <span class="block-warning">Max 3 total!</span>
                        </label>
                        <div id="race-mod-container-original"></div>
                    </div>

                    <div class="input-group">
                        <label class="input-label">Background Name</label>
                        <input type="text" class="text-input" placeholder="e.g. Acolyte">
                    </div>

                    <div class="input-group" id="block-origin-original">
                        <label class="input-label">
                            Origin Feat
                            <span class="block-warning">Max 3 total!</span>
                        </label>
                        <input type="text" class="text-input" placeholder="e.g. Magic Initiate">
                        
                        <div id="origin-mod-container-original"></div>
                    </div>

                </div>
            </div>

            <div class="card">
                <h3 class="card-title">Classes</h3>
                <div id="classes-container-original"></div>
                <button type="button" class="button button-secondary" style="margin-top: 10px;" onclick="window.addClassRow('original')">+ Add Class</button>
            </div>

            <div id="feats-container-original"></div>

            <div class="card">
                <h3 class="card-title">Notes</h3>
                <textarea class="notes-area" placeholder="Rework Type, cost, etc."></textarea>
            </div>
        </div>


        <div class="char-column" id="col-new">
            <h2 class="column-header">New Character</h2>

            <div class="card">
                <h3 class="card-title">Final Attributes</h3>
                <div id="final-stats-container-new">
                    </div>
            </div>

            <div class="card">
                <h3 class="card-title">Character Origin</h3>
                <div class="origin-grid">
                    
                    <div class="input-group">
                        <label class="input-label">Race</label>
                        <input type="text" class="text-input" placeholder="e.g. Human, Elf...">
                    </div>

                    <div class="input-group">
                        <label class="input-label">Base Attributes (27 Point Buy)</label>
                        <div id="attrs-container-new">
                            </div>
                        <div class="points-display" id="points-new">Points Remaining: 27</div>
                    </div>

                    <div class="input-group" id="block-race-new">
                        <label class="input-label">
                            Racial Bonuses
                            <span class="block-warning">Max 3 total!</span>
                        </label>
                        <div id="race-mod-container-new"></div>
                    </div>

                    <div class="input-group">
                        <label class="input-label">Background Name</label>
                        <input type="text" class="text-input" placeholder="e.g. Acolyte">
                    </div>

                    <div class="input-group" id="block-origin-new">
                        <label class="input-label">
                            Origin Feat
                            <span class="block-warning">Max 3 total!</span>
                        </label>
                        <input type="text" class="text-input" placeholder="e.g. Magic Initiate">
                        
                        <div id="origin-mod-container-new"></div>
                    </div>

                </div>
            </div>

            <div class="card">
                <h3 class="card-title">Classes</h3>
                <div id="classes-container-new"></div>
                <button type="button" class="button button-secondary" style="margin-top: 10px;" onclick="window.addClassRow('new')">+ Add Class</button>
            </div>

            <div id="feats-container-new"></div>

             <div class="card">
                <h3 class="card-title">Notes</h3>
                <textarea class="notes-area" placeholder="Character concept notes, equipment, etc..."></textarea>
            </div>
        </div>

    </div>
</div>

<script type="module">
    import { supabase } from "{{ '/assets/js/supabaseClient.js' | relative_url }}";

    // --- 1. DATA CONSTANTS ---
    const ATTRIBUTES = ['STR', 'DEX', 'CON', 'INT', 'WIS', 'CHA'];
    const POINT_BUY_TOTAL = 27;
    const POINT_COSTS = {
        8: 0, 9: 1, 10: 2, 11: 3, 12: 4, 13: 5, 14: 7, 15: 9
    };
    
    const CLASS_ASI_DATA = [
      { "class": "Barbarian", "ASI": [4, 8, 12, 16, 19] },
      { "class": "Bard", "ASI": [4, 8, 12, 16, 19] },
      { "class": "Blood Hunter", "ASI": [4, 8, 12, 16, 19] },
      { "class": "Cleric", "ASI": [4, 8, 12, 16, 19] },
      { "class": "Druid", "ASI": [4, 8, 12, 16, 19] },
      { "class": "Fighter", "ASI": [4, 6, 8, 12, 14, 16, 19] },
      { "class": "Monk", "ASI": [4, 8, 12, 16, 19] },
      { "class": "Mystic", "ASI": [4, 8, 12, 16, 19] },
      { "class": "Paladin", "ASI": [4, 8, 12, 16, 19] },
      { "class": "Ranger", "ASI": [4, 8, 12, 16, 19] },
      { "class": "Rogue", "ASI": [4, 8, 10, 12, 16, 19] },
      { "class": "Sorcerer", "ASI": [4, 8, 12, 16, 19] },
      { "class": "Warlock", "ASI": [4, 8, 12, 16, 19] },
      { "class": "Wizard", "ASI": [4, 8, 12, 16, 19] },
      { "class": "Artificer", "ASI": [4, 8, 12, 16, 19] }
    ];

    let availableClasses = CLASS_ASI_DATA.map(c => c.class);


    // --- 2. GLOBAL FUNCTIONS ---
    
    window.addClassRow = function(colId) {
        const container = document.getElementById(`classes-container-${colId}`);
        if(!container) return;

        const row = document.createElement('div');
        row.className = 'class-row';

        const select = document.createElement('select');
        select.className = 'class-select';
        
        const defOpt = document.createElement('option');
        defOpt.text = "- Select Class -";
        defOpt.value = "";
        select.appendChild(defOpt);

        availableClasses.forEach(cls => {
            const opt = document.createElement('option');
            opt.value = cls;
            opt.text = cls;
            select.appendChild(opt);
        });

        const lvlInput = document.createElement('input');
        lvlInput.type = 'number';
        lvlInput.className = 'level-input';
        lvlInput.placeholder = "Lvl";
        lvlInput.min = 1;
        lvlInput.max = 20;
        lvlInput.value = 1;

        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'remove-class-btn';
        removeBtn.innerHTML = "&times;";
        removeBtn.onclick = function() {
            container.removeChild(row);
            generateFeatCards(colId);
        };

        select.addEventListener('change', () => generateFeatCards(colId));
        lvlInput.addEventListener('change', () => generateFeatCards(colId));
        lvlInput.addEventListener('input', () => generateFeatCards(colId));

        row.appendChild(select);
        row.appendChild(lvlInput);
        row.appendChild(removeBtn);
        container.appendChild(row);
        
        generateFeatCards(colId);
    }

    // --- 3. RENDERING & CALCULATIONS ---

    function createStatTableHTML(type, colId, contextId) {
        // Generates a table with Dropdowns (0, +1, +2)
        // contextId allows unique identification for summing (e.g., 'race', 'origin', 'feat-X')
        
        let html = `<table class="stat-table" data-block-id="${contextId}"><thead><tr>`;
        ATTRIBUTES.forEach(attr => html += `<th>${attr}</th>`);
        html += `</tr></thead><tbody><tr>`;
        
        ATTRIBUTES.forEach(attr => {
            // Identifier class: 'mod-select-{type}' to easily grab them later
            html += `<td>
                <select class="mod-select-cell mod-select-${type}" data-col="${colId}" data-attr="${attr}" data-context="${contextId}">
                    <option value="0">0</option>
                    <option value="1">+1</option>
                    <option value="2">+2</option>
                </select>
            </td>`;
        });
        
        html += `</tr></tbody></table>`;
        return html;
    }

    function renderStaticTables(colId) {
        // Race
        const raceContainer = document.getElementById(`race-mod-container-${colId}`);
        if(raceContainer) raceContainer.innerHTML = createStatTableHTML('race', colId, `race-${colId}`);

        // Origin
        const originContainer = document.getElementById(`origin-mod-container-${colId}`);
        if(originContainer) originContainer.innerHTML = createStatTableHTML('origin', colId, `origin-${colId}`);
        
        // Final Stats (ReadOnly)
        const finalContainer = document.getElementById(`final-stats-container-${colId}`);
        if(finalContainer) {
            let html = `<table class="stat-table final-stats-table"><thead><tr>`;
            ATTRIBUTES.forEach(attr => html += `<th>${attr}</th>`);
            html += `</tr></thead><tbody><tr>`;
            ATTRIBUTES.forEach(attr => {
                html += `<td id="final-${colId}-${attr}">10</td>`;
            });
            html += `</tr></tbody></table>`;
            finalContainer.innerHTML = html;
        }
        
        attachModListeners(colId);
    }

    function renderBaseAttributes(colId) {
        const container = document.getElementById(`attrs-container-${colId}`);
        if (!container) return;
        
        const table = document.createElement('table');
        table.className = 'stat-table';

        let thead = "<thead><tr>";
        ATTRIBUTES.forEach(attr => thead += `<th>${attr}</th>`);
        thead += "</tr></thead>";

        let tbody = "<tbody><tr>";
        ATTRIBUTES.forEach(attr => {
            tbody += `<td><input type="number" class="attr-input-cell" id="attr-${colId}-${attr}" value="10" min="8" max="15"></td>`;
        });
        tbody += "</tr></tbody>";

        table.innerHTML = thead + tbody;
        container.innerHTML = '';
        container.appendChild(table);

        // Listeners
        ATTRIBUTES.forEach(attr => {
            const input = document.getElementById(`attr-${colId}-${attr}`);
            input.addEventListener('input', () => {
                calculatePointBuy(colId);
                calculateFinalStats(colId);
            });
        });

        calculatePointBuy(colId);
    }

    function generateFeatCards(colId) {
        const classContainer = document.getElementById(`classes-container-${colId}`);
        const featContainer = document.getElementById(`feats-container-${colId}`);
        if(!featContainer || !classContainer) return;
        
        // Save current values if possible? (Skipping for simplicity, simpler to regenerate)
        featContainer.innerHTML = '';

        const rows = classContainer.getElementsByClassName('class-row');
        
        Array.from(rows).forEach((row, index) => {
            const select = row.querySelector('.class-select');
            const levelInput = row.querySelector('.level-input');
            
            const className = select.value;
            const level = parseInt(levelInput.value) || 0;

            if (!className || level < 1) return;

            const classData = CLASS_ASI_DATA.find(c => c.class === className);
            
            if (classData && classData.ASI) {
                const achievedASIs = classData.ASI.filter(asiLevel => asiLevel <= level);

                achievedASIs.forEach((asiLevel, asiIndex) => {
                    const uniqueId = `feat-${colId}-${className}-${index}-${asiLevel}`;
                    const card = createFeatCard(className, asiLevel, colId, uniqueId);
                    featContainer.appendChild(card);
                });
            }
        });

        attachModListeners(colId);
        calculateFinalStats(colId); // Recalc totals with new feats
    }

    function createFeatCard(className, level, colId, contextId) {
        const card = document.createElement('div');
        card.className = 'feat-card';
        card.id = `card-${contextId}`;

        const header = document.createElement('div');
        header.className = 'feat-header';
        
        // Header with warning span
        header.innerHTML = `${className} - Level ${level} ASI/Feat <span class="block-warning" id="warn-${contextId}">Max 3 total!</span>`;

        const inputsDiv = document.createElement('div');
        inputsDiv.className = 'input-group';

        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.className = 'text-input';
        nameInput.placeholder = "Feat Name (or +2 ASI)";

        inputsDiv.appendChild(nameInput);
        card.appendChild(header);
        card.appendChild(inputsDiv);
        
        // Insert Dropdown Table
        const tableContainer = document.createElement('div');
        tableContainer.innerHTML = createStatTableHTML('feat', colId, contextId);
        card.appendChild(tableContainer);

        return card;
    }

    // --- 4. LOGIC: POINTS, VALIDATION, TOTALS ---

    function attachModListeners(colId) {
        // Attaches listeners to ALL dropdowns in the column (Race, Origin, Feats)
        const selects = document.querySelectorAll(`select[data-col="${colId}"]`);
        selects.forEach(sel => {
            // Remove old listeners to avoid dupes (simple way is to overwrite onchange if assigning prop, but addEventListener stacks. 
            // Since we regenerate HTML often, simple addEventListener is fine for new elements.)
            sel.onchange = () => {
                validateBlock(sel.dataset.context);
                calculateFinalStats(colId);
            };
        });
    }

    function validateBlock(contextId) {
        // Sums modifiers for a specific block (Race, Origin, or specific Feat)
        // If sum > 3, show warning
        if(!contextId) return;

        const inputs = document.querySelectorAll(`select[data-context="${contextId}"]`);
        let sum = 0;
        inputs.forEach(input => sum += parseInt(input.value) || 0);

        // Find warning element. 
        // For Race/Origin, it's inside the label with ID
        let warningEl;
        
        if(contextId.startsWith('race')) {
            warningEl = document.querySelector(`#block-race-${contextId.split('-')[1]} .block-warning`);
        } else if(contextId.startsWith('origin')) {
            warningEl = document.querySelector(`#block-origin-${contextId.split('-')[1]} .block-warning`);
        } else {
            // Feat
            warningEl = document.getElementById(`warn-${contextId}`);
        }

        if(warningEl) {
            if(sum > 3) warningEl.classList.add('active');
            else warningEl.classList.remove('active');
        }
    }

    function calculatePointBuy(colId) {
        let spent = 0;
        let valid = true;

        ATTRIBUTES.forEach(attr => {
            const input = document.getElementById(`attr-${colId}-${attr}`);
            if(!input) return;
            const val = parseInt(input.value);
            if (val < 8 || val > 15) valid = false;
            if (POINT_COSTS[val] !== undefined) spent += POINT_COSTS[val];
        });

        const remaining = POINT_BUY_TOTAL - spent;
        const display = document.getElementById(`points-${colId}`);
        
        display.innerText = `Points Remaining: ${remaining}`;
        
        if (remaining < 0 || !valid) {
            display.classList.add('error');
            if (!valid) display.innerText += " (Attributes must be 8-15)";
        } else {
            display.classList.remove('error');
        }
    }

    function calculateFinalStats(colId) {
        ATTRIBUTES.forEach(attr => {
            let total = 0;

            // 1. Base
            const baseInput = document.getElementById(`attr-${colId}-${attr}`);
            if(baseInput) total += parseInt(baseInput.value) || 0;

            // 2. All Dropdowns for this attribute in this column
            const mods = document.querySelectorAll(`select[data-col="${colId}"][data-attr="${attr}"]`);
            mods.forEach(mod => total += parseInt(mod.value) || 0);

            // 3. Update Display
            const finalCell = document.getElementById(`final-${colId}-${attr}`);
            if(finalCell) finalCell.innerText = total;
        });
    }


    // --- 5. INIT ---

    async function initSupabase() {
        try {
            const { data, error } = await supabase
                .from('lookups')
                .select('*')
                .eq('type', 'character')
                .order('value', { ascending: true });

            if (data && data.length > 0) {
                availableClasses = data.map(item => item.value || item.name);
                document.querySelectorAll('.class-select').forEach(select => {
                    const currentVal = select.value;
                    select.innerHTML = '<option value="">- Select Class -</option>';
                    availableClasses.forEach(cls => {
                        const opt = document.createElement('option');
                        opt.value = cls;
                        opt.text = cls;
                        select.appendChild(opt);
                    });
                    select.value = currentVal;
                });
            }
        } catch (err) {
            console.warn("Supabase fetch failed, using defaults");
        }
    }

    function startApp() {
        ['original', 'new'].forEach(col => {
            renderStaticTables(col);
            renderBaseAttributes(col);
            window.addClassRow(col); 
            calculateFinalStats(col);
        });
        initSupabase();
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', startApp);
    } else {
        startApp();
    }

</script>