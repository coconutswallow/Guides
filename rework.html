---
layout: default
title: Character Rework Tool
---

<link rel="stylesheet" href="{{ '/assets/css/rework.css' | relative_url }}">

<div class="page">
    <h1>Character Rework Tool</h1>
    
    {% include auth-header.html %}
    <p id="instruction-text" class="auth-instruction">Please log in to Save/Load WIP Reworks.</p>

    <br>

    <div class="tab-nav">
        <button class="tab-btn active" onclick="window.switchTab('input')">Input</button>
        <button class="tab-btn" onclick="window.switchTab('output')">Output</button>
    </div>

    <div id="tab-input" class="tab-content active">
        
        <div class="control-bar" id="controls-area">
            <div id="logged-out-controls" class="control-group" style="display:none; align-items:center; gap: 10px;">
               <button id="custom-login-btn" class="auth-btn auth-btn-discord" onclick="window.authManager.login()">
                    Login to Save
               </button>
               <span style="font-size:0.9em; margin-left:10px;"> or use Manual ID: </span>
               <input type="text" id="manual-discord-id" class="text-input" style="width: 150px;" placeholder="Username">
            </div>

            <div id="logged-in-controls" class="control-group" style="display:none;">
                <button class="action-btn btn-save" onclick="window.saveRework()">Save</button>
                <button class="action-btn btn-load" onclick="window.loadSelectedRework()">Load</button>
                <select id="load-rework-select" class="load-select">
                    <option value="">-- Load Saved Rework --</option>
                </select>
            </div>

            <div id="auth-error-msg" class="control-group" style="display:none; color: #e74c3c;">
                <span>"Adventurer" role required to Save/Load.</span>
            </div>
        </div>

        <input type="hidden" id="current-rework-id" value="">

        <div class="respec-container">
            <div class="char-column" id="col-original">
                <h2 class="column-header">Original Character</h2>
                <div class="card">
                    <h3 class="card-title">Character Origin</h3>
                    <div class="origin-grid">
                        <div class="input-group">
                            <label class="input-label">Character Name</label>
                            <input type="text" class="text-input" id="name-original" placeholder="Name">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Base Attributes (27 Point Buy)</label>
                            <div id="attrs-container-original"></div>
                            <div class="points-display" id="points-original">Points Remaining: 27</div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Race/Species</label>
                            <input type="text" class="text-input" id="race-original" placeholder="Race/Species Details">
                        </div>
                        <div class="input-group" id="block-race-original">
                            <label class="input-label">Racial Bonuses <span class="block-warning">Max 3!</span></label>
                            <div id="race-mod-container-original"></div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Origin (Background)</label>
                            <input type="text" class="text-input" id="bg-original" placeholder="e.g. Acolyte">
                        </div>
                        <div class="input-group" id="block-origin-original">
                            <label class="input-label">Origin Feat</label>
                            <input type="text" class="text-input" id="orig-feat-original" placeholder="Feat Name">
                            <div id="origin-mod-container-original" style="margin-top:10px;"></div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h3 class="card-title">Classes</h3>
                    <div id="classes-container-original"></div>
                    <button type="button" class="button button-secondary" onclick="window.addClassRow('original')">+ Add Class</button>
                </div>
                <div id="feats-container-original"></div>
            </div>

            <div class="char-column" id="col-new">
                <h2 class="column-header">New Character</h2>
                <div class="card">
                    <h3 class="card-title">Character Origin</h3>
                    <div class="origin-grid">
                        <div class="input-group">
                            <div class="field-header-row"><label class="input-label">Character Name</label><button type="button" class="copy-link" onclick="window.copyValue('name-original', 'name-new')">Copy</button></div>
                            <input type="text" class="text-input" id="name-new" placeholder="Name">
                        </div>
                        <div class="input-group">
                            <div class="field-header-row"><label class="input-label">Base Attributes</label><button type="button" class="copy-link" onclick="window.copyAttributes()">Copy</button></div>
                            <div id="attrs-container-new"></div>
                            <div class="points-display" id="points-new">Points Remaining: 27</div>
                        </div>
                        <div class="input-group">
                            <div class="field-header-row"><label class="input-label">Race/Species</label><button type="button" class="copy-link" onclick="window.copyValue('race-original', 'race-new')">Copy</button></div>
                            <input type="text" class="text-input" id="race-new" placeholder="Race/Species Details">
                        </div>
                        <div class="input-group" id="block-race-new">
                            <div class="field-header-row"><label class="input-label">Racial Bonuses</label><button type="button" class="copy-link" onclick="window.copyMods('race')">Copy</button></div>
                            <div id="race-mod-container-new"></div>
                        </div>
                        <div class="input-group">
                            <div class="field-header-row"><label class="input-label">Origin (Background)</label><button type="button" class="copy-link" onclick="window.copyValue('bg-original', 'bg-new')">Copy</button></div>
                            <input type="text" class="text-input" id="bg-new" placeholder="e.g. Acolyte">
                        </div>
                        <div class="input-group" id="block-origin-new">
                            <div class="field-header-row"><label class="input-label">Origin Feat</label><button type="button" class="copy-link" onclick="window.copyValue('orig-feat-original', 'orig-feat-new')">Copy</button></div>
                            <input type="text" class="text-input" id="orig-feat-new" placeholder="Feat Name">
                            <div id="origin-mod-container-new" style="margin-top:10px;"></div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h3 class="card-title">Classes</h3>
                    <div id="classes-container-new"></div>
                    <button type="button" class="button button-secondary" onclick="window.addClassRow('new')">+ Add Class</button>
                </div>
                <div id="feats-container-new"></div>
            </div>
        </div>

        <div class="card" style="margin-top: 2rem;">
            <h3 class="card-title">Rework Details</h3>
            <input type="text" id="rework-cost" class="text-input" placeholder="GP/DTP Costs">
            <textarea id="rework-notes" class="notes-area" style="min-height:100px;" placeholder="Notes for auditors"></textarea>
        </div>
    </div>

    <div id="tab-output" class="tab-content">
        <h2 class="column-header">Rework Request Form</h2>
        <textarea id="output-text" class="output-area" readonly></textarea>
        <button class="action-btn" onclick="window.copyOutput()" style="width:100%;">Copy to Clipboard</button>
    </div>
</div>

<script type="module" src="{{ '/assets/js/auth-manager.js' | relative_url }}"></script>

<script>
    // Logic for UI visibility based on Auth roles
    window.handlePageAuth = function(user, profile) {
        window.currentUser = user;
        const REQUIRED_ROLE = "Adventurer";
        const loggedOutGroup = document.getElementById('logged-out-controls');
        const loggedInGroup = document.getElementById('logged-in-controls');
        const authErrorGroup = document.getElementById('auth-error-msg');
        
        if (user) {
            const hasAccess = (profile?.roles || []).includes(REQUIRED_ROLE);
            loggedOutGroup.style.display = 'none';
            if (hasAccess) {
                loggedInGroup.style.display = 'flex';
                if(window.fetchReworks) window.fetchReworks();
            } else {
                authErrorGroup.style.display = 'flex';
            }
        } else {
            loggedOutGroup.style.display = 'flex';
            loggedInGroup.style.display = 'none';
        }
    };
</script>

<script type="module">
    import { supabase } from "{{ '/assets/js/supabaseClient.js' | relative_url }}";

    const ATTRIBUTES = ['STR', 'DEX', 'CON', 'INT', 'WIS', 'CHA'];
    const POINT_COSTS = { 8: 0, 9: 1, 10: 2, 11: 3, 12: 4, 13: 5, 14: 7, 15: 9 };
    let characterData = [];

    // Initialize the tool by loading data and setting up both columns
    async function startApp() {
        try {
            const { data } = await supabase.from('lookups').select('data').eq('type', 'character').single();
            characterData = data?.data || [];
            ['original', 'new'].forEach(col => {
                window.renderBaseAttributes(col);
                document.getElementById(`race-mod-container-${col}`).innerHTML = createStatTableHTML('race', col, `race-${col}`);
                document.getElementById(`origin-mod-container-${col}`).innerHTML = createStatTableHTML('origin', col, `origin-${col}`);
                window.addClassRow(col);
            });
        } catch(e) { console.error("App failed to start", e); }
    }

    // Helper to generate the stat modification tables
    function createStatTableHTML(type, colId, ctx) {
        let h = `<table class="stat-table"><thead><tr>`;
        ATTRIBUTES.forEach(a => h += `<th>${a}</th>`);
        h += `</tr></thead><tbody><tr>`;
        ATTRIBUTES.forEach(a => h += `<td><select class="mod-select-${type}" data-col="${colId}" data-attr="${a}" onchange="window.validateBlock('${ctx}')"><option value="0">0</option><option value="1">+1</option><option value="2">+2</option></select></td>`);
        h += `</tr></tbody></table>`;
        return h;
    }

    // Attribute Rendering and Point Buy
    window.renderBaseAttributes = function(colId) {
        const container = document.getElementById(`attrs-container-${colId}`);
        let h = `<table class="stat-table"><thead><tr>`;
        ATTRIBUTES.forEach(a => h += `<th>${a}</th>`);
        h += `</tr></thead><tbody><tr>`;
        ATTRIBUTES.forEach(a => h += `<td><input type="number" class="attr-input-cell" id="attr-${colId}-${a}" value="10" min="8" max="15" oninput="window.calculatePointBuy('${colId}')"></td>`);
        h += `</tr></tbody></table>`;
        container.innerHTML = h;
        window.calculatePointBuy(colId);
    };

    window.calculatePointBuy = function(colId) {
        let spent = 0;
        ATTRIBUTES.forEach(a => {
            const val = parseInt(document.getElementById(`attr-${colId}-${a}`).value);
            spent += POINT_COSTS[val] || 0;
        });
        const remaining = 27 - spent;
        const display = document.getElementById(`points-${colId}`);
        display.innerText = `Points Remaining: ${remaining}`;
        display.style.color = remaining < 0 ? '#e74c3c' : '#2ecc71';
    };

    // Dynamic Class Rows
    window.addClassRow = function(colId, initialData = null) {
        const container = document.getElementById(`classes-container-${colId}`);
        const block = document.createElement('div');
        block.className = 'class-block';
        block.innerHTML = `
            <div class="class-row">
                <select class="version-select"><option value="">Ver</option><option value="2014">2014</option><option value="2024">2024</option></select>
                <select class="class-select" disabled><option value="">Class</option></select>
                <select class="subclass-select" disabled><option value="">Subclass</option></select>
            </div>
            <div class="class-row-bottom">
                <div class="level-wrapper"><span>Lvl:</span><input type="number" class="level-input" value="1" min="1" max="20"></div>
                <button class="remove-class-btn" onclick="this.closest('.class-block').remove(); window.generateFeatCards('${colId}')">&times;</button>
            </div>`;
        container.appendChild(block);

        const vSel = block.querySelector('.version-select');
        const cSel = block.querySelector('.class-select');
        const sSel = block.querySelector('.subclass-select');
        const lInp = block.querySelector('.level-input');

        vSel.onchange = () => {
            cSel.innerHTML = '<option value="">Class</option>';
            cSel.disabled = !vSel.value;
            [...new Set(characterData.filter(i => i.version == vSel.value).map(i => i.class))].forEach(c => {
                cSel.innerHTML += `<option value="${c}">${c}</option>`;
            });
            window.generateFeatCards(colId);
        };

        cSel.onchange = () => {
            sSel.innerHTML = '<option value="">Subclass</option>';
            sSel.disabled = !cSel.value;
            characterData.filter(i => i.version == vSel.value && i.class == cSel.value).forEach(s => {
                sSel.innerHTML += `<option value="${s.subclass}">${s.subclass || 'None'}</option>`;
            });
            window.generateFeatCards(colId);
        };

        lInp.oninput = () => window.generateFeatCards(colId);
    };

    // Feat Card Generation based on Class Levels
    window.generateFeatCards = function(colId) {
        const container = document.getElementById(`feats-container-${colId}`);
        container.innerHTML = '';
        document.querySelectorAll(`#classes-container-${colId} .class-block`).forEach((b, idx) => {
            const cl = b.querySelector('.class-select').value;
            const lv = parseInt(b.querySelector('.level-input').value) || 0;
            if (!cl) return;
            for (let i = 4; i <= lv; i += 4) {
                const card = document.createElement('div');
                card.className = 'card feat-card';
                card.innerHTML = `<h3 class="card-title">${cl} - Lvl ${i} ASI/Feat</h3>
                    <input type="text" class="text-input" placeholder="Feat Name">
                    ${createStatTableHTML('feat', colId, `feat-${colId}-${idx}-${i}`)}`;
                container.appendChild(card);
            }
        });
    };

    startApp();
</script>