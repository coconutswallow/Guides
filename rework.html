---
layout: default
title: Character Rework Tool
---

<style>
    /* --- LAYOUT STYLES --- */
    .respec-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-top: 1rem;
    }

    @media (max-width: 1000px) {
        .respec-container { grid-template-columns: 1fr; }
    }

    .char-column { display: flex; flex-direction: column; gap: 1.5rem; }

    .column-header {
        text-align: center;
        border-bottom: 2px solid var(--color-primary);
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
        color: var(--color-primary);
        font-family: var(--font-header);
    }

    /* --- FORM ELEMENTS --- */
    .origin-grid { display: flex; flex-direction: column; gap: 1rem; }
    .input-group { display: flex; flex-direction: column; gap: 0.25rem; }
    
    /* Header Row for Labels + Copy Buttons */
    .field-header-row {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
    }

    .input-label {
        font-size: 0.9em;
        font-weight: bold;
        color: var(--color-text-secondary);
        text-transform: uppercase;
    }

    /* Copy Button Styles */
    .copy-link {
        background: none;
        border: none;
        padding: 0;
        color: var(--color-secondary);
        font-size: 0.8em;
        text-decoration: underline;
        cursor: pointer;
        font-family: var(--font-body);
    }
    .copy-link:hover { color: var(--color-primary); }
    
    /* Spacer for alignment in Original Column */
    .copy-spacer {
        font-size: 0.8em;
        visibility: hidden;
    }

    .text-input {
        width: 100%;
        padding: 8px;
        border: 1px solid var(--color-border);
        border-radius: 4px;
        background: var(--color-bg-page);
        color: var(--color-text);
    }
    
    .notes-area {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--color-border);
        border-radius: 4px;
        background: var(--color-bg-page);
        color: var(--color-text);
        resize: vertical;
        min-height: 100px;
        font-family: var(--font-body);
    }

    /* --- SAVE / LOAD BAR --- */
    .control-bar {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        background: var(--color-bg-medium);
        padding: 15px;
        border: 1px solid var(--color-border);
        border-radius: 4px;
        margin: 1rem 0;
        align-items: center;
        justify-content: center; /* Centered */
        min-height: 70px;
    }

    .control-group {
        display: flex;
        gap: 10px;
        align-items: center;
        width: 100%;
        justify-content: center;
    }

    .manual-id-input {
        padding: 8px;
        border: 1px solid var(--color-border);
        border-radius: 4px;
        min-width: 250px;
    }

    .load-select {
        padding: 8px;
        border: 1px solid var(--color-border);
        border-radius: 4px;
        min-width: 250px;
        flex-grow: 1;
        max-width: 400px;
    }

    .action-btn {
        padding: 8px 20px;
        border: none;
        border-radius: 4px;
        font-weight: bold;
        cursor: pointer;
        color: white;
        text-transform: uppercase;
        font-size: 0.9em;
    }

    .btn-save { background-color: #27ae60; }
    .btn-save:hover { background-color: #219150; }
    
    .btn-load { background-color: var(--color-primary); }
    .btn-load:hover { background-color: #3a1009; }

    .btn-refresh { background-color: var(--color-secondary); }

    /* --- TABLES & GRIDS --- */
    .stat-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 0.5rem;
        font-size: 0.9em;
    }

    .stat-table th {
        background: var(--color-primary);
        color: white;
        padding: 6px;
        text-align: center;
        border: 1px solid var(--color-primary);
    }

    .stat-table td {
        padding: 6px;
        text-align: center;
        border: 1px solid var(--color-border);
        background: var(--color-bg-medium);
    }

    .final-stats-table th { background: var(--color-secondary); }
    .final-stats-table td { font-weight: bold; font-size: 1.1em; background: var(--color-bg-page); }

    .attr-input-cell {
        width: 100%; max-width: 60px; text-align: center; padding: 4px;
        border: 1px solid var(--color-border); font-weight: bold;
    }

    .mod-select-cell {
        width: 100%; text-align: center; padding: 4px;
        border: 1px solid var(--color-border); background: var(--color-bg-page);
        color: var(--color-text); cursor: pointer;
    }

    .points-display {
        text-align: center; font-weight: bold; padding: 0.5rem; margin-top: 0.5rem;
        background: var(--color-bg-page); border: 1px dashed var(--color-border); border-radius: 4px;
    }
    
    .points-display.error { color: #e74c3c; border-color: #e74c3c; background: #fadbd8; }

    .block-warning { font-size: 0.8em; color: #e74c3c; font-style: italic; display: none; }
    .block-warning.active { display: inline; }

    /* --- CLASS ROWS --- */
    .class-row {
        display: grid;
        grid-template-columns: 80px 1fr 1fr;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
        align-items: center;
        padding: 10px;
        background: var(--color-bg-medium);
        border: 1px solid var(--color-border);
        border-radius: 4px;
    }
    
    .class-row-bottom {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .class-block {
        display: flex;
        flex-direction: column;
        padding: 10px;
        background: var(--color-bg-medium);
        border: 1px solid var(--color-border);
        border-radius: 4px;
        margin-bottom: 0.75rem;
    }

    .class-select, .version-select, .subclass-select {
        padding: 8px;
        border: 1px solid var(--color-border);
        background: var(--color-bg-page);
        color: var(--color-text);
        border-radius: 4px;
        width: 100%;
    }

    .level-wrapper {
        display: flex;
        align-items: center;
        gap: 5px;
        width: 100px;
    }

    .level-label {
        font-weight: bold;
        font-size: 0.9em;
        color: var(--color-primary);
    }

    .level-input {
        width: 100%;
        padding: 8px;
        border: 1px solid var(--color-border);
        background: var(--color-bg-page);
        color: var(--color-text);
        border-radius: 4px;
        text-align: center;
    }

    .remove-class-btn {
        background: #e74c3c; color: white; border: none; width: 32px; height: 32px;
        border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center;
        align-self: flex-end;
    }
    
    .remove-wrapper {
        display: flex;
        justify-content: flex-end;
        align-items: center;
    }

    /* Feat Cards */
    .feat-card {
        background: var(--color-bg-medium); border: 2px solid var(--color-border);
        padding: 1rem; margin-bottom: 1rem; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .feat-header {
        font-weight: bold; color: var(--color-primary); border-bottom: 2px solid var(--color-border);
        padding-bottom: 0.25rem; margin-bottom: 0.5rem;
    }
</style>

<div class="page">

    <h1>Character Rework Tool</h1>
    <p>Login to save/load reworks.   Note this page is not optimized for mobile.</p>

    {% include auth-header.html %}

    <div class="control-bar" id="controls-area">
        
        <div id="logged-out-controls" class="control-group" style="display:none;">
            <label style="font-weight:bold;">Discord ID:</label>
            <input type="text" id="manual-discord-id" class="manual-id-input" placeholder="Enter Discord ID manually...">
            </div>

        <div id="logged-in-controls" class="control-group" style="display:none;">
            <button class="action-btn btn-save" onclick="window.saveRework()">Save</button>
            <button class="action-btn btn-load" onclick="window.loadSelectedRework()">Load</button>
            <select id="load-rework-select" class="load-select">
                <option value="">-- Load Saved Rework --</option>
            </select>
        </div>
    </div>

    <input type="hidden" id="current-rework-id" value="">


    <div class="respec-container">
        
        <div class="char-column" id="col-original">
            <h2 class="column-header">Original Character</h2>

            <div class="card">
                <h3 class="card-title">Character Origin</h3>
                <div class="origin-grid">
                    
                    <div class="input-group">
                        <div class="field-header-row">
                            <label class="input-label">Character Name</label>
                            <span class="copy-spacer">Copy from Original</span>
                        </div>
                        <input type="text" class="text-input" id="name-original" placeholder="Name">
                    </div>

                    <div class="input-group">
                        <div class="field-header-row">
                            <label class="input-label">Base Attributes (27 Point Buy)</label>
                            <span class="copy-spacer">Copy from Original</span>
                        </div>
                        <div id="attrs-container-original"></div>
                        <div class="points-display" id="points-original">Points Remaining: 27</div>
                    </div>

                    <div class="input-group">
                        <div class="field-header-row">
                            <label class="input-label">(Race: Version, Race, and subrace)</label>
                            <span class="copy-spacer">Copy from Original</span>
                        </div>
                        <input type="text" class="text-input" id="race-original" placeholder="e.g. Human, Elf...">
                    </div>

                    <div class="input-group" id="block-race-original">
                        <div class="field-header-row">
                            <label class="input-label">Racial Bonuses <span class="block-warning">Max 3 total!</span></label>
                            <span class="copy-spacer">Copy from Original</span>
                        </div>
                        <div id="race-mod-container-original"></div>
                    </div>

                    <div class="input-group">
                        <div class="field-header-row">
                            <label class="input-label">Origin (Background)</label>
                            <span class="copy-spacer">Copy from Original</span>
                        </div>
                        <input type="text" class="text-input" id="bg-original" placeholder="e.g. Acolyte">
                    </div>

                    <div class="input-group" id="block-origin-original">
                        <div class="field-header-row">
                            <label class="input-label">Origin Feat <span class="block-warning">Max 3 total!</span></label>
                            <span class="copy-spacer">Copy from Original</span>
                        </div>
                        <input type="text" class="text-input" id="orig-feat-original" placeholder="e.g. Magic Initiate">
                        <div id="origin-mod-container-original"></div>
                    </div>

                </div>
            </div>

            <div class="card">
                <h3 class="card-title">Classes</h3>
                <div id="classes-container-original"></div>
                <button type="button" class="button button-secondary" style="margin-top: 10px;" onclick="window.addClassRow('original')">+ Add Class</button>
            </div>

            <div id="feats-container-original"></div>
        </div>


        <div class="char-column" id="col-new">
            <h2 class="column-header">New Character</h2>

            <div class="card">
                <h3 class="card-title">Character Origin</h3>
                <div class="origin-grid">
                    
                    <div class="input-group">
                        <div class="field-header-row">
                            <label class="input-label">Character Name</label>
                            <button type="button" class="copy-link" onclick="window.copyValue('name-original', 'name-new')">Copy from Original</button>
                        </div>
                        <input type="text" class="text-input" id="name-new" placeholder="Name">
                    </div>

                    <div class="input-group">
                        <div class="field-header-row">
                            <label class="input-label">Base Attributes (27 Point Buy)</label>
                            <button type="button" class="copy-link" onclick="window.copyAttributes()">Copy from Original</button>
                        </div>
                        <div id="attrs-container-new"></div>
                        <div class="points-display" id="points-new">Points Remaining: 27</div>
                    </div>

                    <div class="input-group">
                        <div class="field-header-row">
                            <label class="input-label">(Race: Version, Race, and subrace)</label>
                            <button type="button" class="copy-link" onclick="window.copyValue('race-original', 'race-new')">Copy from Original</button>
                        </div>
                        <input type="text" class="text-input" id="race-new" placeholder="e.g. Human, Elf...">
                    </div>

                    <div class="input-group" id="block-race-new">
                        <div class="field-header-row">
                            <label class="input-label">Racial Bonuses <span class="block-warning">Max 3 total!</span></label>
                            <button type="button" class="copy-link" onclick="window.copyMods('race')">Copy from Original</button>
                        </div>
                        <div id="race-mod-container-new"></div>
                    </div>

                    <div class="input-group">
                        <div class="field-header-row">
                            <label class="input-label">Origin (Background)</label>
                            <button type="button" class="copy-link" onclick="window.copyValue('bg-original', 'bg-new')">Copy from Original</button>
                        </div>
                        <input type="text" class="text-input" id="bg-new" placeholder="e.g. Acolyte">
                    </div>

                    <div class="input-group" id="block-origin-new">
                        <div class="field-header-row">
                            <label class="input-label">Origin Feat <span class="block-warning">Max 3 total!</span></label>
                            <button type="button" class="copy-link" onclick="window.copyOriginAll()">Copy from Original</button>
                        </div>
                        <input type="text" class="text-input" id="orig-feat-new" placeholder="e.g. Magic Initiate">
                        <div id="origin-mod-container-new"></div>
                    </div>

                </div>
            </div>

            <div class="card">
                <h3 class="card-title">Classes</h3>
                <div id="classes-container-new"></div>
                <button type="button" class="button button-secondary" style="margin-top: 10px;" onclick="window.addClassRow('new')">+ Add Class</button>
            </div>

            <div id="feats-container-new"></div>
        </div>

    </div>

    <div class="card" style="margin-top: 2rem;">
        <h3 class="card-title">Rework Details</h3>
        
        <div class="input-group" style="margin-bottom: 1rem;">
            <label class="input-label">Rework Costs</label>
            <input type="text" id="rework-cost" class="text-input" placeholder="GP and DTP (or and/or rework token)">
        </div>

        <div class="input-group">
            <label class="input-label">Notes</label>
            <textarea id="rework-notes" class="notes-area" style="min-height: 150px;" placeholder="Summarize character changes"></textarea>
        </div>
    </div>
</div>

<script type="module" src="{{ '/assets/js/auth-manager.js' | relative_url }}"></script>

<script>
    window.currentUser = null;

    function onAuthChange(user, profile) {
        window.currentUser = user;
        const loggedOutGroup = document.getElementById('logged-out-controls');
        const loggedInGroup = document.getElementById('logged-in-controls');
        
        if (user) {
            loggedOutGroup.style.display = 'none';
            loggedInGroup.style.display = 'flex';
            if(window.fetchReworks) window.fetchReworks();
        } else {
            loggedOutGroup.style.display = 'flex';
            loggedInGroup.style.display = 'none';
        }
    }

    const checkAuth = setInterval(() => {
        if (window.authManager) {
            clearInterval(checkAuth);
            window.authManager.client.auth.getSession().then(({ data }) => {
                onAuthChange(data.session?.user, null);
            });
        }
    }, 100);
</script>

<script type="module">
    import { supabase } from "{{ '/assets/js/supabaseClient.js' | relative_url }}";

    // --- 1. DATA CONSTANTS ---
    const ATTRIBUTES = ['STR', 'DEX', 'CON', 'INT', 'WIS', 'CHA'];
    const POINT_BUY_TOTAL = 27;
    const POINT_COSTS = { 8: 0, 9: 1, 10: 2, 11: 3, 12: 4, 13: 5, 14: 7, 15: 9 };
    let characterData = [];

    // --- 2. CORE FUNCTIONS ---

    // === COPY FUNCTIONALITY ===
    
    window.copyValue = function(sourceId, targetId) {
        const src = document.getElementById(sourceId);
        const tgt = document.getElementById(targetId);
        if(src && tgt) tgt.value = src.value;
    }

    window.copyAttributes = function() {
        ATTRIBUTES.forEach(attr => {
            const val = document.getElementById(`attr-original-${attr}`).value;
            document.getElementById(`attr-new-${attr}`).value = val;
        });
        window.calculatePointBuy('new');
        window.calculateFinalStats('new');
    }

    window.copyMods = function(type) {
        // type = 'race' or 'origin'
        ATTRIBUTES.forEach(attr => {
            // Find src select
            const src = document.querySelector(`.mod-select-${type}[data-col="original"][data-attr="${attr}"]`);
            const tgt = document.querySelector(`.mod-select-${type}[data-col="new"][data-attr="${attr}"]`);
            if(src && tgt) {
                tgt.value = src.value;
                // Trigger change event to update warnings/calcs
                tgt.dispatchEvent(new Event('change'));
            }
        });
        window.calculateFinalStats('new');
    }

    window.copyOriginAll = function() {
        window.copyValue('orig-feat-original', 'orig-feat-new');
        window.copyMods('origin');
    }


    // === SAVE / LOAD LOGIC ===

    window.getCurrentDiscordID = function() {
        if (window.currentUser) return window.currentUser.id; 
        const manualInput = document.getElementById('manual-discord-id');
        return manualInput ? manualInput.value.trim() : null;
    }

    window.fetchReworks = async function() {
        const discordId = window.getCurrentDiscordID();
        if (!discordId) return;

        const select = document.getElementById('load-rework-select');
        select.innerHTML = '<option>Loading...</option>';

        try {
            const { data, error } = await supabase
                .from('rework')
                .select('id, character_name, updated_at')
                .eq('discord_id', discordId)
                .order('updated_at', { ascending: false });

            if (error) throw error;

            select.innerHTML = '<option value="">-- Select Rework to Load --</option>';
            data.forEach(row => {
                const date = new Date(row.updated_at).toLocaleDateString();
                const name = row.character_name || "Unnamed";
                const opt = document.createElement('option');
                opt.value = row.id;
                opt.innerText = `${name} (${date})`;
                select.appendChild(opt);
            });
        } catch (err) {
            console.error("Error fetching reworks:", err);
            select.innerHTML = '<option value="">Error loading list</option>';
        }
    }

    window.loadSelectedRework = async function() {
        const id = document.getElementById('load-rework-select').value;
        if (!id) {
            alert("Please select a rework from the dropdown first.");
            return;
        }

        try {
            const { data, error } = await supabase
                .from('rework')
                .select('*')
                .eq('id', id)
                .single();

            if (error) throw error;

            loadReworkData(data);
        } catch (err) {
            console.error("Error loading rework:", err);
            alert("Failed to load rework data.");
        }
    }

    function loadReworkData(data) {
        document.getElementById('current-rework-id').value = data.id;
        populateColumn('original', data.old_character);
        populateColumn('new', data.new_character);
        document.getElementById('rework-cost').value = data.cost || "";
        document.getElementById('rework-notes').value = data.notes || "";
        alert("Rework loaded successfully!");
    }

    window.saveRework = async function() {
        const discordId = window.getCurrentDiscordID();
        if (!discordId) {
            alert("Discord ID required (Login or Manual Entry)");
            return;
        }

        const oldChar = scrapeColumn('original');
        const newChar = scrapeColumn('new');
        const cost = document.getElementById('rework-cost').value;
        const notes = document.getElementById('rework-notes').value;
        const currentId = document.getElementById('current-rework-id').value;

        const payload = {
            discord_id: discordId,
            character_name: oldChar.name || "Unnamed",
            old_character: oldChar,
            new_character: newChar,
            cost: cost,
            notes: notes,
            updated_at: new Date().toISOString()
        };

        try {
            let result;
            if (currentId) {
                result = await supabase.from('rework').update(payload).eq('id', currentId);
            } else {
                result = await supabase.from('rework').insert([payload]).select();
            }

            if (result.error) throw result.error;

            if (!currentId && result.data) {
                document.getElementById('current-rework-id').value = result.data[0].id;
            }

            alert("Rework saved successfully!");
            window.fetchReworks(); 
        } catch (err) {
            console.error("Save error:", err);
            alert("Error saving rework.");
        }
    }

    // === SCRAPER / POPULATOR HELPERS ===

    function scrapeColumn(colId) {
        const getVal = (id) => document.getElementById(id)?.value || "";
        
        const attrs = {};
        ATTRIBUTES.forEach(a => attrs[a] = getVal(`attr-${colId}-${a}`));

        const raceMods = {};
        document.querySelectorAll(`.mod-select-race[data-col="${colId}"]`).forEach(sel => {
            raceMods[sel.dataset.attr] = sel.value;
        });

        const originMods = {};
        document.querySelectorAll(`.mod-select-origin[data-col="${colId}"]`).forEach(sel => {
            originMods[sel.dataset.attr] = sel.value;
        });

        const classes = [];
        const classBlocks = document.querySelectorAll(`#classes-container-${colId} .class-block`);
        classBlocks.forEach(block => {
            classes.push({
                version: block.querySelector('.version-select').value,
                class: block.querySelector('.class-select').value,
                subclass: block.querySelector('.subclass-select').value,
                level: block.querySelector('.level-input').value
            });
        });

        const feats = [];
        const featCards = document.querySelectorAll(`#feats-container-${colId} .feat-card`);
        featCards.forEach(card => {
            const name = card.querySelector('.text-input').value;
            const mods = {};
            card.querySelectorAll('select').forEach(s => mods[s.dataset.attr] = s.value);
            feats.push({ name, mods });
        });

        return {
            name: getVal(`name-${colId}`),
            race: getVal(`race-${colId}`),
            bg: getVal(`bg-${colId}`),
            origin_feat: getVal(`orig-feat-${colId}`),
            attributes: attrs,
            race_mods: raceMods,
            origin_mods: originMods,
            classes: classes,
            feats: feats
        };
    }

    function populateColumn(colId, data) {
        if (!data) return;
        const setVal = (id, v) => { const el = document.getElementById(id); if(el) el.value = v; };

        setVal(`name-${colId}`, data.name);
        setVal(`race-${colId}`, data.race);
        setVal(`bg-${colId}`, data.bg);
        setVal(`orig-feat-${colId}`, data.origin_feat);

        if(data.attributes) {
            ATTRIBUTES.forEach(a => setVal(`attr-${colId}-${a}`, data.attributes[a]));
        }

        const setMods = (type, modData) => {
            if(!modData) return;
            document.querySelectorAll(`.mod-select-${type}[data-col="${colId}"]`).forEach(sel => {
                if (modData[sel.dataset.attr]) sel.value = modData[sel.dataset.attr];
            });
        }
        setMods('race', data.race_mods);
        setMods('origin', data.origin_mods);

        const classContainer = document.getElementById(`classes-container-${colId}`);
        classContainer.innerHTML = '';
        if (data.classes) {
            data.classes.forEach(cData => {
                window.addClassRow(colId, cData); 
            });
        }

        window[`tempFeats_${colId}`] = data.feats;
        
        window.calculatePointBuy(colId);
        window.generateFeatCards(colId); 
        window.calculateFinalStats(colId);
    }


    // --- 3. UI GENERATION ---

    window.addClassRow = function(colId, initialData = null) {
        const container = document.getElementById(`classes-container-${colId}`);
        if(!container) return;

        const block = document.createElement('div');
        block.className = 'class-block';

        const rowTop = document.createElement('div');
        rowTop.className = 'class-row';

        const verSelect = document.createElement('select');
        verSelect.className = 'version-select';
        verSelect.innerHTML = `<option value="">Ver</option><option value="2014">2014</option><option value="2024">2024</option>`;
        
        const classSelect = document.createElement('select');
        classSelect.className = 'class-select';
        classSelect.innerHTML = `<option value="">- Class -</option>`;
        classSelect.disabled = true;

        const subSelect = document.createElement('select');
        subSelect.className = 'subclass-select';
        subSelect.innerHTML = `<option value="">- Subclass -</option>`;
        subSelect.disabled = true;

        rowTop.appendChild(verSelect);
        rowTop.appendChild(classSelect);
        rowTop.appendChild(subSelect);

        const rowBottom = document.createElement('div');
        rowBottom.className = 'class-row-bottom';
        const lvlWrapper = document.createElement('div');
        lvlWrapper.className = 'level-wrapper';
        const lvlLabel = document.createElement('span');
        lvlLabel.className = 'level-label';
        lvlLabel.innerText = "Lvl:";
        const lvlInput = document.createElement('input');
        lvlInput.type = 'number';
        lvlInput.className = 'level-input';
        lvlInput.min = 1; 
        lvlInput.max = 20; 
        lvlInput.value = 1;
        lvlWrapper.appendChild(lvlLabel);
        lvlWrapper.appendChild(lvlInput);

        const removeWrapper = document.createElement('div');
        removeWrapper.className = 'remove-wrapper';
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'remove-class-btn';
        removeBtn.innerHTML = "&times;";
        removeBtn.onclick = function() { container.removeChild(block); generateFeatCards(colId); };
        removeWrapper.appendChild(removeBtn);

        rowBottom.appendChild(lvlWrapper);
        rowBottom.appendChild(removeWrapper);
        block.appendChild(rowTop);
        block.appendChild(rowBottom);
        container.appendChild(block);

        const updateClasses = (selectedClass = null) => {
            const ver = parseInt(verSelect.value);
            classSelect.innerHTML = `<option value="">- Class -</option>`;
            subSelect.innerHTML = `<option value="">- Subclass -</option>`;
            subSelect.disabled = true;
            if(!ver) { classSelect.disabled = true; return; }
            classSelect.disabled = false;

            const classes = [...new Set(characterData.filter(i => i.version === ver).map(i => i.class))].sort();
            classes.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c; opt.text = c;
                if(c === selectedClass) opt.selected = true;
                classSelect.appendChild(opt);
            });
        };

        const updateSubclasses = (selectedSub = null) => {
            const ver = parseInt(verSelect.value);
            const cls = classSelect.value;
            subSelect.innerHTML = `<option value="">- Subclass -</option>`;
            if(!cls) { subSelect.disabled = true; return; }
            subSelect.disabled = false;

            const subs = [...new Set(characterData.filter(i => i.version === ver && i.class === cls && i.subclass).map(i => i.subclass))].sort();
            if(subs.length > 0) {
                subs.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s; opt.text = s;
                    if(s === selectedSub) opt.selected = true;
                    subSelect.appendChild(opt);
                });
            } else {
                const opt = document.createElement('option');
                opt.value = "None"; opt.text = "None";
                subSelect.appendChild(opt);
                subSelect.value = "None";
            }
        };

        verSelect.addEventListener('change', () => { updateClasses(); generateFeatCards(colId); });
        classSelect.addEventListener('change', () => { updateSubclasses(); generateFeatCards(colId); });
        subSelect.addEventListener('change', () => generateFeatCards(colId));
        lvlInput.addEventListener('change', () => generateFeatCards(colId));
        lvlInput.addEventListener('input', () => generateFeatCards(colId));

        if (initialData) {
            verSelect.value = initialData.version;
            updateClasses(initialData.class);
            updateSubclasses(initialData.subclass);
            lvlInput.value = initialData.level;
        }

        generateFeatCards(colId);
    }

    function createStatTableHTML(type, colId, contextId) {
        let html = `<table class="stat-table" data-block-id="${contextId}"><thead><tr>`;
        ATTRIBUTES.forEach(attr => html += `<th>${attr}</th>`);
        html += `</tr></thead><tbody><tr>`;
        ATTRIBUTES.forEach(attr => {
            html += `<td><select class="mod-select-cell mod-select-${type}" data-col="${colId}" data-attr="${attr}" data-context="${contextId}"><option value="0">0</option><option value="1">+1</option><option value="2">+2</option></select></td>`;
        });
        html += `</tr></tbody></table>`;
        return html;
    }

    function renderStaticTables(colId) {
        const raceC = document.getElementById(`race-mod-container-${colId}`);
        if(raceC) raceC.innerHTML = createStatTableHTML('race', colId, `race-${colId}`);
        const origC = document.getElementById(`origin-mod-container-${colId}`);
        if(origC) origC.innerHTML = createStatTableHTML('origin', colId, `origin-${colId}`);
        attachModListeners(colId);
    }

    function renderBaseAttributes(colId) {
        const container = document.getElementById(`attrs-container-${colId}`);
        if (!container) return;
        const table = document.createElement('table');
        table.className = 'stat-table';
        let thead = "<thead><tr>"; ATTRIBUTES.forEach(a => thead += `<th>${a}</th>`); thead += "</tr></thead>";
        let tbody = "<tbody><tr>"; ATTRIBUTES.forEach(a => tbody += `<td><input type="number" class="attr-input-cell" id="attr-${colId}-${a}" value="10" min="8" max="15"></td>`); tbody += "</tr></tbody>";
        table.innerHTML = thead + tbody;
        container.innerHTML = '';
        container.appendChild(table);
        ATTRIBUTES.forEach(a => document.getElementById(`attr-${colId}-${a}`).addEventListener('input', () => { window.calculatePointBuy(colId); window.calculateFinalStats(colId); }));
        window.calculatePointBuy(colId);
    }

    window.generateFeatCards = function(colId) {
        const classContainer = document.getElementById(`classes-container-${colId}`);
        const featContainer = document.getElementById(`feats-container-${colId}`);
        if(!featContainer) return;
        featContainer.innerHTML = '';

        const blocks = classContainer.getElementsByClassName('class-block');
        let cardIndex = 0;

        Array.from(blocks).forEach((block) => {
            const ver = parseInt(block.querySelector('.version-select').value);
            const cls = block.querySelector('.class-select').value;
            const sub = block.querySelector('.subclass-select').value;
            const level = parseInt(block.querySelector('.level-input').value) || 0;

            if (!ver || !cls || level < 1) return;

            let dataEntry = characterData.find(i => i.version === ver && i.class === cls && i.subclass === sub);
            if (!dataEntry) dataEntry = characterData.find(i => i.version === ver && i.class === cls && !i.subclass);

            if (dataEntry && dataEntry.ASI) {
                const achieved = dataEntry.ASI.filter(l => l <= level);
                achieved.forEach(lvl => {
                    const uniqueId = `feat-${colId}-${cardIndex}`;
                    const card = createFeatCard(cls, lvl, colId, uniqueId);
                    featContainer.appendChild(card);
                    
                    if (window[`tempFeats_${colId}`] && window[`tempFeats_${colId}`][cardIndex]) {
                        const saved = window[`tempFeats_${colId}`][cardIndex];
                        card.querySelector('.text-input').value = saved.name || "";
                        if (saved.mods) {
                            card.querySelectorAll('select').forEach(s => {
                                if(saved.mods[s.dataset.attr]) s.value = saved.mods[s.dataset.attr];
                            });
                        }
                    }
                    cardIndex++;
                });
            }
        });
        
        attachModListeners(colId);
        window.calculateFinalStats(colId);
    }

    function createFeatCard(className, level, colId, contextId) {
        const card = document.createElement('div');
        card.className = 'feat-card';
        const header = document.createElement('div');
        header.className = 'feat-header';
        header.innerHTML = `${className} - Level ${level} ASI/Feat <span class="block-warning" id="warn-${contextId}">Max 3 total!</span>`;
        
        const inputsDiv = document.createElement('div');
        inputsDiv.className = 'input-group';
        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.className = 'text-input';
        nameInput.placeholder = "Feat Name (or +2 ASI)";
        
        inputsDiv.appendChild(nameInput);
        card.appendChild(header);
        card.appendChild(inputsDiv);
        
        const tableC = document.createElement('div');
        tableC.innerHTML = createStatTableHTML('feat', colId, contextId);
        card.appendChild(tableC);
        return card;
    }

    function attachModListeners(colId) {
        document.querySelectorAll(`select[data-col="${colId}"]`).forEach(sel => {
            sel.onchange = () => { validateBlock(sel.dataset.context); window.calculateFinalStats(colId); };
        });
    }

    function validateBlock(ctxId) {
        if(!ctxId) return;
        const inputs = document.querySelectorAll(`select[data-context="${ctxId}"]`);
        let sum = 0; inputs.forEach(i => sum += parseInt(i.value)||0);
        let warnEl;
        if(ctxId.startsWith('race')) warnEl = document.querySelector(`#block-race-${ctxId.split('-')[1]} .block-warning`);
        else if(ctxId.startsWith('origin')) warnEl = document.querySelector(`#block-origin-${ctxId.split('-')[1]} .block-warning`);
        else warnEl = document.getElementById(`warn-${ctxId}`);
        
        if(warnEl) {
            if(sum > 3) warnEl.classList.add('active'); else warnEl.classList.remove('active');
        }
    }

    window.calculatePointBuy = function(colId) {
        let spent = 0; let valid = true;
        ATTRIBUTES.forEach(a => {
            const v = parseInt(document.getElementById(`attr-${colId}-${a}`).value);
            if(v<8||v>15) valid=false;
            if(POINT_COSTS[v]!==undefined) spent+=POINT_COSTS[v];
        });
        const disp = document.getElementById(`points-${colId}`);
        disp.innerText = `Points Remaining: ${27 - spent}`;
        if(27-spent < 0 || !valid) disp.classList.add('error'); else disp.classList.remove('error');
    }

    window.calculateFinalStats = function(colId) {
        // Disabled per request, but logic ready
    }

    async function initSupabase() {
        try {
            const { data, error } = await supabase.from('lookups').select('data').eq('type', 'character').single();
            if(error) throw error;
            if(data && data.data) characterData = data.data;
        } catch(e) { console.warn("DB Init Error", e); }
    }

    async function startApp() {
        await initSupabase();
        ['original', 'new'].forEach(col => {
            renderStaticTables(col);
            renderBaseAttributes(col);
            window.addClassRow(col); 
        });
    }

    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', startApp); else startApp();

</script>