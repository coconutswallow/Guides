---
layout: default
title: Character Rework Tool
---

<link rel="stylesheet" href="{{ '/assets/css/rework.css' | relative_url }}">

<div class="page">
    <h1>Character Rework Tool</h1>
    
    {% include auth-header.html %}
    <p id="instruction-text" class="auth-instruction">Please log in to Save/Load WIP Reworks.</p>

    <br>

    <div class="tab-nav">
        <button class="tab-btn active" onclick="window.switchTab('input')">Input</button>
        <button class="tab-btn" onclick="window.switchTab('output')">Output</button>
    </div>

    <div id="tab-input" class="tab-content active">
        
        <div class="control-bar" id="controls-area">
            <div id="logged-out-controls" class="control-group" style="display:none; align-items:center; gap: 10px;">
               <button id="custom-login-btn" class="auth-btn auth-btn-discord" onclick="window.authManager.login()">
                    Login to Save
               </button>
               <span style="font-size:0.9em; margin-left:10px;"> or use Manual ID: </span>
               <input type="text" id="manual-discord-id" class="text-input" style="width: 150px;" placeholder="Username">
            </div>

            <div id="logged-in-controls" class="control-group" style="display:none;">
                <button class="action-btn btn-save" onclick="window.saveRework()">Save</button>
                <button class="action-btn btn-load" onclick="window.loadSelectedRework()">Load</button>
                <select id="load-rework-select" class="load-select">
                    <option value="">-- Load Saved Rework --</option>
                </select>
            </div>

            <div id="auth-error-msg" class="control-group" style="display:none; color: #e74c3c;">
                <span>"Adventurer" role required to Save/Load.</span>
            </div>
        </div>

        <input type="hidden" id="current-rework-id" value="">

        <div class="respec-container">
            <div class="char-column" id="col-original">
                <h2 class="column-header">Original Character</h2>
                <div class="card">
                    <h3 class="card-title">Character Origin</h3>
                    <div class="origin-grid">
                        <div class="input-group">
                            <label class="input-label">Character Name</label>
                            <input type="text" class="text-input" id="name-original" placeholder="Name">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Base Attributes (27 Point Buy)</label>
                            <div id="attrs-container-original"></div>
                            <div class="points-display" id="points-original">Points Remaining: 27</div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Race/Species</label>
                            <input type="text" class="text-input" id="race-original" placeholder="Race/Species Details">
                        </div>
                        <div class="input-group" id="block-race-original">
                            <label class="input-label">Racial Bonuses <span class="block-warning">Max 3!</span></label>
                            <div id="race-mod-container-original"></div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Origin (Background)</label>
                            <input type="text" class="text-input" id="bg-original" placeholder="e.g. Acolyte">
                        </div>
                        <div class="input-group" id="block-origin-original">
                            <label class="input-label">Origin Feat</label>
                            <input type="text" class="text-input" id="orig-feat-original" placeholder="Feat Name">
                            <div id="origin-mod-container-original" style="margin-top:10px;"></div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h3 class="card-title">Classes</h3>
                    <div id="classes-container-original"></div>
                    <button type="button" class="button button-secondary" onclick="window.addClassRow('original')">+ Add Class</button>
                </div>
                <div id="feats-container-original"></div>
            </div>

            <div class="char-column" id="col-new">
                <h2 class="column-header">New Character</h2>
                <div class="card">
                    <h3 class="card-title">Character Origin</h3>
                    <div class="origin-grid">
                        <div class="input-group">
                            <div class="field-header-row"><label class="input-label">Character Name</label><button type="button" class="copy-link" onclick="window.copyValue('name-original', 'name-new')">Copy</button></div>
                            <input type="text" class="text-input" id="name-new" placeholder="Name">
                        </div>
                        <div class="input-group">
                            <div class="field-header-row"><label class="input-label">Base Attributes</label><button type="button" class="copy-link" onclick="window.copyAttributes()">Copy</button></div>
                            <div id="attrs-container-new"></div>
                            <div class="points-display" id="points-new">Points Remaining: 27</div>
                        </div>
                        <div class="input-group">
                            <div class="field-header-row"><label class="input-label">Race/Species</label><button type="button" class="copy-link" onclick="window.copyValue('race-original', 'race-new')">Copy</button></div>
                            <input type="text" class="text-input" id="race-new" placeholder="Race/Species Details">
                        </div>
                        <div class="input-group" id="block-race-new">
                            <div class="field-header-row"><label class="input-label">Racial Bonuses</label><button type="button" class="copy-link" onclick="window.copyMods('race')">Copy</button></div>
                            <div id="race-mod-container-new"></div>
                        </div>
                        <div class="input-group">
                            <div class="field-header-row"><label class="input-label">Origin (Background)</label><button type="button" class="copy-link" onclick="window.copyValue('bg-original', 'bg-new')">Copy</button></div>
                            <input type="text" class="text-input" id="bg-new" placeholder="e.g. Acolyte">
                        </div>
                        <div class="input-group" id="block-origin-new">
                            <div class="field-header-row"><label class="input-label">Origin Feat</label><button type="button" class="copy-link" onclick="window.copyValue('orig-feat-original', 'orig-feat-new')">Copy</button></div>
                            <input type="text" class="text-input" id="orig-feat-new" placeholder="Feat Name">
                            <div id="origin-mod-container-new" style="margin-top:10px;"></div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h3 class="card-title">Classes</h3>
                    <div id="classes-container-new"></div>
                    <button type="button" class="button button-secondary" onclick="window.addClassRow('new')">+ Add Class</button>
                </div>
                <div id="feats-container-new"></div>
            </div>
        </div>

        <div class="card" style="margin-top: 2rem;">
            <h3 class="card-title">Rework Details</h3>
            <input type="text" id="rework-cost" class="text-input" placeholder="GP/DTP Costs">
            <textarea id="rework-notes" class="notes-area" style="min-height:100px;" placeholder="Notes for auditors"></textarea>
        </div>
    </div>

    <div id="tab-output" class="tab-content">
        <h2 class="column-header">Rework Request Form</h2>
        <textarea id="output-text" class="output-area" readonly></textarea>
        <button class="action-btn" onclick="window.copyOutput()" style="width:100%;">Copy to Clipboard</button>
    </div>
</div>

<script type="module" src="{{ '/assets/js/auth-manager.js' | relative_url }}"></script>

<script>
    // Logic for UI visibility based on Auth roles
    window.handlePageAuth = function(user, profile) {
        window.currentUser = user;
        const REQUIRED_ROLE = "Adventurer";
        const loggedOutGroup = document.getElementById('logged-out-controls');
        const loggedInGroup = document.getElementById('logged-in-controls');
        const authErrorGroup = document.getElementById('auth-error-msg');
        
        if (user) {
            const hasAccess = (profile?.roles || []).includes(REQUIRED_ROLE);
            loggedOutGroup.style.display = 'none';
            if (hasAccess) {
                loggedInGroup.style.display = 'flex';
                if(window.fetchReworks) window.fetchReworks();
            } else {
                authErrorGroup.style.display = 'flex';
            }
        } else {
            loggedOutGroup.style.display = 'flex';
            loggedInGroup.style.display = 'none';
        }
    };
</script>

<script type="module">
    import { supabase } from "{{ '/assets/js/supabaseClient.js' | relative_url }}";

    const ATTRIBUTES = ['STR', 'DEX', 'CON', 'INT', 'WIS', 'CHA'];
    const POINT_BUY_TOTAL = 27;
    const POINT_COSTS = { 8: 0, 9: 1, 10: 2, 11: 3, 12: 4, 13: 5, 14: 7, 15: 9 };
    let characterData = [];

    // --- TAB LOGIC ---
    window.switchTab = function(tabName) {
        if (tabName === 'output') {
            if (!validateForm()) return; 
        }

        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        // Match buttons to tabs
        if(tabName === 'input') document.querySelectorAll('.tab-btn')[0].classList.add('active');
        else document.querySelectorAll('.tab-btn')[1].classList.add('active');
        
        document.getElementById(`tab-${tabName}`).classList.add('active');

        if (tabName === 'output') {
            generateOutput();
        }
    }

    function validateForm() {
        const showError = (el, msg) => {
            alert(msg);
            if(el) {
                el.focus();
                el.style.borderColor = "#e74c3c";
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                el.addEventListener('input', function(){ this.style.borderColor = ''; }, {once: true});
            }
            return false;
        };

        const requiredFields = [
            { id: 'name-original', name: 'Original Character Name' },
            { id: 'race-original', name: 'Original Race/Species' },
            { id: 'bg-original', name: 'Original Background' },
            { id: 'orig-feat-original', name: 'Original Origin Feat' },
            { id: 'name-new', name: 'New Character Name' },
            { id: 'race-new', name: 'New Race/Species' },
            { id: 'bg-new', name: 'New Background' },
            { id: 'orig-feat-new', name: 'New Origin Feat' },
            { id: 'rework-cost', name: 'Rework Cost' },
            { id: 'rework-notes', name: 'Rework Notes' }
        ];

        for (const field of requiredFields) {
            const el = document.getElementById(field.id);
            if (!el || !el.value.trim()) return showError(el, `${field.name} cannot be blank.`);
        }

        const featInputs = document.querySelectorAll('.feat-card .text-input');
        for(const input of featInputs) {
            if(!input.value.trim()) {
                const cardHeader = input.closest('.feat-card').querySelector('.feat-header').innerText.split(' Max')[0];
                return showError(input, `Feat name for "${cardHeader}" cannot be blank.`);
            }
        }
        return true;
    }

    // --- MARKDOWN GENERATION ---
    function generateOutput() {
        const discordId = window.getCurrentDiscordID() || "Unknown";
        const oldChar = scrapeColumn('original');
        const newChar = scrapeColumn('new');
        const cost = document.getElementById('rework-cost').value || "N/A";
        const notes = document.getElementById('rework-notes').value || "N/A";

        const fmtStats = (attrs) => ATTRIBUTES.map(a => (attrs[a] || "10").toString().padStart(2, '0')).join(" / ");

        const getFlatBonuses = (raceMods, origMods) => {
            let bonuses = [];
            ATTRIBUTES.forEach(a => {
                const rVal = parseInt(raceMods[a] || 0);
                const oVal = parseInt(origMods[a] || 0);
                if (rVal > 0) bonuses.push(`+${rVal} ${a}`);
                if (oVal > 0) bonuses.push(`+${oVal} ${a}`);
            });
            return bonuses.length > 0 ? bonuses.join(", ") : "None";
        };

        const getClassInfo = (classes) => {
            if(!classes || classes.length === 0) return { ver: "2024", str: "None", lvl: 0 };
            const ver = classes[0].version || "2024";
            const totalLvl = classes.reduce((sum, c) => sum + (parseInt(c.level)||0), 0);
            const str = classes.map(c => {
                let s = c.class;
                if(c.subclass && c.subclass !== "None") s += ` ${c.subclass}`;
                s += ` (${c.level})`;
                return s;
            }).join(" / ");
            return { ver, str, lvl: totalLvl };
        };

        const oldClass = getClassInfo(oldChar.classes);
        const newClass = getClassInfo(newChar.classes);

        const extractFeats = (colId) => {
            let list = [];
            const origName = document.getElementById(`orig-feat-${colId}`).value;
            const origMods = [];
            document.querySelectorAll(`.mod-select-origin[data-col="${colId}"]`).forEach(s => {
                if(parseInt(s.value) > 0) origMods.push(`+${s.value} ${s.dataset.attr}`);
            });
            if(origName) list.push(`${origName}${origMods.length ? ' ' + origMods.join(", ") : ""} (Background)`);

            const cards = document.querySelectorAll(`#feats-container-${colId} .feat-card`);
            cards.forEach(card => {
                const source = card.querySelector('.feat-header').innerText.split(" ASI/Feat")[0].replace(" - Level ", " ");
                const name = card.querySelector('.text-input').value;
                if(!name) return;
                let mods = [];
                card.querySelectorAll('select').forEach(s => {
                    if(parseInt(s.value) > 0) mods.push(`+${s.value} ${s.dataset.attr}`);
                });
                list.push(`${name}${mods.length ? ' ' + mods.join(", ") : ""} (${source})`);
            });
            return list.length ? list.join(", ") : "None";
        };

        const text = `\`\`\`
__***Character Change Request***__

**Requestor:** @${discordId} as ${oldChar.name} (${oldClass.lvl})

**Old Character**
Name: ${oldChar.name}
Version: ${oldClass.ver}
Level: ${oldClass.lvl}
Class: ${oldClass.str}
Race/Species: ${oldChar.race}
Starting Stats: (excluding Racial/Background Bonuses)
Str / Dex / Con / Int / Wis / Cha
${fmtStats(oldChar.attributes)}
Racial/Background stat bonuses: ${getFlatBonuses(oldChar.race_mods, oldChar.origin_mods)}
ASI/Feat/Origin Feat choices: ${extractFeats('original')}
Background: ${oldChar.bg}

**New Character**
Name: ${newChar.name}
Version: ${newClass.ver}
Level: ${newClass.lvl}
Class: ${newClass.str}
Race/Species: ${newChar.race}
Starting Stats: (excluding Racial/Background Bonuses)
Str / Dex / Con / Int / Wis / Cha
${fmtStats(newChar.attributes)}
Racial/Background stat bonuses: ${getFlatBonuses(newChar.race_mods, newChar.origin_mods)}
ASI/Feat/Origin Feat choices: ${extractFeats('new')}
Background: ${newChar.bg}

**Notes**
Cost: ${cost}
Notes: ${notes}
\`\`\`
<@&474659626193780751> <@&554463237924716545>`;

        document.getElementById('output-text').value = text;
    }

    window.copyOutput = function() {
        const el = document.getElementById('output-text');
        el.select();
        document.execCommand('copy');
        alert("Copied to clipboard!");
    }

    // --- UTILITIES ---
    window.copyValue = (src, tgt) => { const s = document.getElementById(src); const t = document.getElementById(tgt); if(s && t) t.value = s.value; };
    window.copyAttributes = () => {
        ATTRIBUTES.forEach(a => { document.getElementById(`attr-new-${a}`).value = document.getElementById(`attr-original-${a}`).value; });
        window.calculatePointBuy('new');
    };
    window.copyMods = (type) => {
        ATTRIBUTES.forEach(a => {
            const src = document.querySelector(`.mod-select-${type}[data-col="original"][data-attr="${a}"]`);
            const tgt = document.querySelector(`.mod-select-${type}[data-col="new"][data-attr="${a}"]`);
            if(src && tgt) tgt.value = src.value;
        });
    };

    window.getCurrentDiscordID = function() {
        if (window.currentUser) return window.currentUser.user_metadata.full_name || window.currentUser.user_metadata.name || "User";
        return document.getElementById('manual-discord-id')?.value.trim() || null;
    }

    function scrapeColumn(colId) {
        const getVal = (id) => document.getElementById(id)?.value || "";
        const attrs = {}; ATTRIBUTES.forEach(a => attrs[a] = getVal(`attr-${colId}-${a}`));
        const race_mods = {}; document.querySelectorAll(`.mod-select-race[data-col="${colId}"]`).forEach(s => race_mods[s.dataset.attr] = s.value);
        const origin_mods = {}; document.querySelectorAll(`.mod-select-origin[data-col="${colId}"]`).forEach(s => origin_mods[s.dataset.attr] = s.value);
        
        const classes = [];
        document.querySelectorAll(`#classes-container-${colId} .class-block`).forEach(b => {
            classes.push({
                version: b.querySelector('.version-select').value,
                class: b.querySelector('.class-select').value,
                subclass: b.querySelector('.subclass-select').value,
                level: b.querySelector('.level-input').value
            });
        });

        const feats = []; 
        document.querySelectorAll(`#feats-container-${colId} .feat-card`).forEach(c => {
            const mods = {}; c.querySelectorAll('select').forEach(s => mods[s.dataset.attr] = s.value);
            feats.push({name: c.querySelector('.text-input').value, mods});
        });

        return {
            name: getVal(`name-${colId}`), race: getVal(`race-${colId}`), bg: getVal(`bg-${colId}`), 
            origin_feat: getVal(`orig-feat-${colId}`), attributes: attrs, race_mods, origin_mods, classes, feats
        };
    }

    // --- DATABASE / SAVE / LOAD ---
    window.fetchReworks = async function() {
        const discordId = window.getCurrentDiscordID();
        if (!discordId) return;
        const select = document.getElementById('load-rework-select');
        try {
            const { data, error } = await supabase.from('rework').select('id, character_name, updated_at').eq('discord_id', discordId).order('updated_at', { ascending: false });
            if (error) throw error;
            select.innerHTML = '<option value="">-- Load Saved Rework --</option>';
            data.forEach(row => {
                const opt = document.createElement('option');
                opt.value = row.id; opt.innerText = `${row.character_name || "Unnamed"} (${new Date(row.updated_at).toLocaleDateString()})`;
                select.appendChild(opt);
            });
        } catch (err) { console.error(err); }
    }

    window.loadSelectedRework = async function() {
        const id = document.getElementById('load-rework-select').value;
        if (!id) return alert("Select a rework.");
        try {
            const { data, error } = await supabase.from('rework').select('*').eq('id', id).single();
            if (error) throw error;
            document.getElementById('current-rework-id').value = data.id;
            populateColumn('original', data.old_character);
            populateColumn('new', data.new_character);
            document.getElementById('rework-cost').value = data.cost || "";
            document.getElementById('rework-notes').value = data.notes || "";
            alert("Loaded!");
        } catch (err) { alert("Failed to load."); }
    }

    function populateColumn(colId, data) {
        if(!data) return;
        const setVal = (id, v) => { const e = document.getElementById(id); if(e) e.value = v; };
        setVal(`name-${colId}`, data.name); setVal(`race-${colId}`, data.race); setVal(`bg-${colId}`, data.bg); setVal(`orig-feat-${colId}`, data.origin_feat);
        if(data.attributes) ATTRIBUTES.forEach(a => setVal(`attr-${colId}-${a}`, data.attributes[a]));
        if(data.race_mods) document.querySelectorAll(`.mod-select-race[data-col="${colId}"]`).forEach(s => s.value = data.race_mods[s.dataset.attr] || "0");
        if(data.origin_mods) document.querySelectorAll(`.mod-select-origin[data-col="${colId}"]`).forEach(s => s.value = data.origin_mods[s.dataset.attr] || "0");
        
        const cCont = document.getElementById(`classes-container-${colId}`);
        cCont.innerHTML = '';
        if(data.classes) data.classes.forEach(c => window.addClassRow(colId, c));
        
        window[`tempFeats_${colId}`] = data.feats;
        window.calculatePointBuy(colId);
        window.generateFeatCards(colId);
    }

    window.saveRework = async function() {
        const discordId = window.getCurrentDiscordID();
        if (!discordId) return alert("Discord ID required.");
        const oldChar = scrapeColumn('original');
        const newChar = scrapeColumn('new');
        const currentId = document.getElementById('current-rework-id').value;
        const payload = { 
            discord_id: discordId, character_name: oldChar.name || "Unnamed", 
            old_character: oldChar, new_character: newChar, 
            cost: document.getElementById('rework-cost').value, 
            notes: document.getElementById('rework-notes').value, 
            updated_at: new Date().toISOString() 
        };
        try {
            const { data, error } = currentId 
                ? await supabase.from('rework').update(payload).eq('id', currentId)
                : await supabase.from('rework').insert([payload]).select();
            if (error) throw error;
            if (!currentId && data) document.getElementById('current-rework-id').value = data[0].id;
            alert("Saved!");
            window.fetchReworks();
        } catch (e) { alert("Save failed."); }
    }

    // --- UI GENERATORS ---
    window.addClassRow = function(colId, initialData = null) {
        const container = document.getElementById(`classes-container-${colId}`);
        const block = document.createElement('div'); block.className = 'class-block';
        
        block.innerHTML = `
            <div class="class-row">
                <select class="version-select"><option value="">Ver</option><option value="2014">2014</option><option value="2024">2024</option></select>
                <select class="class-select" disabled><option value="">- Class -</option></select>
                <select class="subclass-select" disabled><option value="">- Subclass -</option></select>
            </div>
            <div class="class-row-bottom">
                <div class="level-wrapper">Lvl: <input type="number" class="level-input" min="1" max="20" value="1"></div>
                <button type="button" class="remove-class-btn" onclick="this.closest('.class-block').remove(); window.generateFeatCards('${colId}')">&times;</button>
            </div>`;
        container.appendChild(block);

        const vSel = block.querySelector('.version-select');
        const cSel = block.querySelector('.class-select');
        const sSel = block.querySelector('.subclass-select');
        const lInp = block.querySelector('.level-input');

        const updateClasses = (selected) => {
            const v = parseInt(vSel.value);
            cSel.innerHTML = '<option value="">- Class -</option>';
            if(!v) { cSel.disabled = true; return; }
            cSel.disabled = false;
            [...new Set(characterData.filter(i=>i.version===v).map(i=>i.class))].sort().forEach(cl => {
                cSel.innerHTML += `<option value="${cl}" ${cl===selected?'selected':''}>${cl}</option>`;
            });
        };

        const updateSubs = (selected) => {
            const v = parseInt(vSel.value); const cl = cSel.value;
            sSel.innerHTML = '<option value="">- Subclass -</option>';
            if(!cl) { sSel.disabled = true; return; }
            sSel.disabled = false;
            const subs = [...new Set(characterData.filter(i=>i.version===v && i.class===cl && i.subclass).map(i=>i.subclass))].sort();
            if(subs.length) subs.forEach(s => sSel.innerHTML += `<option value="${s}" ${s===selected?'selected':''}>${s}</option>`);
            else sSel.innerHTML = '<option value="None">None</option>';
        };

        vSel.onchange = () => { updateClasses(); window.generateFeatCards(colId); };
        cSel.onchange = () => { updateSubs(); window.generateFeatCards(colId); };
        sSel.onchange = lInp.oninput = () => window.generateFeatCards(colId);

        if(initialData) {
            vSel.value = initialData.version;
            updateClasses(initialData.class);
            updateSubs(initialData.subclass);
            lInp.value = initialData.level;
        }
    }

    window.generateFeatCards = function(colId) {
        const container = document.getElementById(`feats-container-${colId}`);
        container.innerHTML = '';
        let idx = 0;
        document.querySelectorAll(`#classes-container-${colId} .class-block`).forEach(b => {
            const v = parseInt(b.querySelector('.version-select').value);
            const cl = b.querySelector('.class-select').value;
            const lv = parseInt(b.querySelector('.level-input').value)||0;
            if(!v || !cl) return;
            
            const data = characterData.find(i=>i.version===v && i.class===cl);
            if(data?.ASI) {
                data.ASI.filter(l=>l<=lv).forEach(l => {
                    const id = `feat-${colId}-${idx}`;
                    const card = document.createElement('div'); card.className = 'feat-card card';
                    card.innerHTML = `<h3 class="feat-header card-title">${cl} - Level ${l} ASI/Feat <span class="block-warning" id="warn-${id}">Max 3 total!</span></h3>
                                      <input type="text" class="text-input" placeholder="Feat Name">
                                      ${createStatTableHTML('feat', colId, id)}`;
                    container.appendChild(card);
                    
                    if(window[`tempFeats_${colId}`]?.[idx]) {
                        const saved = window[`tempFeats_${colId}`][idx];
                        card.querySelector('.text-input').value = saved.name || "";
                        card.querySelectorAll('select').forEach(s => s.value = saved.mods?.[s.dataset.attr] || "0");
                    }
                    idx++;
                });
            }
        });
        document.querySelectorAll(`select[data-col="${colId}"]`).forEach(s => s.onchange = () => validateBlock(s.dataset.context));
    }

    function createStatTableHTML(type, colId, ctx) {
        let h = `<table class="stat-table"><thead><tr>${ATTRIBUTES.map(a=>`<th>${a}</th>`).join('')}</tr></thead><tbody><tr>`;
        ATTRIBUTES.forEach(a => h += `<td><select class="mod-select-${type}" data-col="${colId}" data-attr="${a}" data-context="${ctx}"><option value="0">0</option><option value="1">+1</option><option value="2">+2</option></select></td>`);
        return h + '</tr></tbody></table>';
    }

    window.calculatePointBuy = function(colId) {
        let s = 0;
        ATTRIBUTES.forEach(a => s += POINT_COSTS[document.getElementById(`attr-${colId}-${a}`).value] || 0);
        const rem = 27 - s;
        const el = document.getElementById(`points-${colId}`);
        el.innerText = `Points Remaining: ${rem}`;
        el.style.color = rem < 0 ? '#e74c3c' : '#2ecc71';
    }

    function validateBlock(ctxId) {
        if(!ctxId) return;
        const sum = Array.from(document.querySelectorAll(`select[data-context="${ctxId}"]`)).reduce((a, b) => a + parseInt(b.value), 0);
        let warn;
        if(ctxId.startsWith('race')) warn = document.querySelector(`#block-race-${ctxId.split('-')[1]} .block-warning`);
        else if(ctxId.startsWith('origin')) warn = document.querySelector(`#block-origin-${ctxId.split('-')[1]} .block-warning`);
        else warn = document.getElementById(`warn-${ctxId}`);
        if(warn) warn.classList.toggle('active', sum > 3);
    }

    async function startApp() {
        try {
            const { data } = await supabase.from('lookups').select('data').eq('type', 'character').single();
            characterData = data?.data || [];
            ['original', 'new'].forEach(c => {
                document.getElementById(`race-mod-container-${c}`).innerHTML = createStatTableHTML('race', c, `race-${c}`);
                document.getElementById(`origin-mod-container-${c}`).innerHTML = createStatTableHTML('origin', c, `origin-${c}`);
                window.renderBaseAttributes(c);
                window.addClassRow(c);
            });
        } catch(e) { console.error(e); }
    }
    
    window.renderBaseAttributes = function(colId) {
        document.getElementById(`attrs-container-${colId}`).innerHTML = `<table class="stat-table"><thead><tr>${ATTRIBUTES.map(a=>`<th>${a}</th>`).join('')}</tr></thead><tbody><tr>${ATTRIBUTES.map(a=>`<td><input type="number" class="attr-input-cell" id="attr-${colId}-${a}" value="10" min="8" max="15" oninput="window.calculatePointBuy('${colId}')"></td>`).join('')}</tr></tbody></table>`;
        window.calculatePointBuy(colId);
    }

    startApp();
</script>