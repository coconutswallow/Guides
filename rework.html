---
layout: default
title: Character Rework Tool
---

<link rel="stylesheet" href="{{ '/assets/css/rework.css' | relative_url }}">

<div class="page">
    <h1>Character Rework Tool</h1>
    
    {% include auth-header.html %}
    <p id="instruction-text" class="auth-instruction">Please log in to Save/Load WIP Reworks.</p>

    <br>

    <div class="tab-nav">
        <button class="tab-btn active" onclick="window.switchTab('input')">Input</button>
        <button class="tab-btn" onclick="window.switchTab('output')">Output</button>
    </div>

    <div id="tab-input" class="tab-content active">
        
        <div class="control-bar" id="controls-area">
            <div id="logged-out-controls" class="control-group" style="display:none; align-items:center; gap: 10px;">
               <button id="custom-login-btn" class="auth-btn auth-btn-discord" onclick="window.authManager.login()">Login to Save</button>
               <span style="font-size:0.9em; margin-left:10px;"> or use Manual ID: </span>
               <input type="text" id="manual-discord-id" class="text-input" style="width: 150px;" placeholder="Username">
            </div>

            <div id="logged-in-controls" class="control-group" style="display:none;">
                <button class="action-btn btn-save" onclick="window.saveRework()">Save</button>
                <button class="action-btn btn-load" onclick="window.loadSelectedRework()">Load</button>
                <select id="load-rework-select" class="load-select">
                    <option value="">-- Load Saved Rework --</option>
                </select>
            </div>

            <div id="auth-error-msg" class="control-group" style="display:none; color: #e74c3c;">
                <span>"Adventurer" role required to Save/Load.</span>
            </div>
        </div>

        <input type="hidden" id="current-rework-id" value="">

        <div class="respec-container">
            <div class="char-column" id="col-original">
                <h2 class="column-header">Original Character</h2>
                <div class="card">
                    <h3 class="card-title">Character Origin</h3>
                    <div class="origin-grid">
                        <div class="input-group">
                            <label class="input-label">Character Name</label>
                            <input type="text" class="text-input" id="name-original" placeholder="Name">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Base Attributes (27 Point Buy)</label>
                            <div id="attrs-container-original"></div>
                            <div class="points-display" id="points-original">Points Remaining: 27</div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Race/Species</label>
                            <input type="text" class="text-input" id="race-original" placeholder="Race/Species Details">
                        </div>
                        <div class="input-group" id="block-race-original">
                            <label class="input-label">Racial Bonuses <span class="block-warning">Max 3!</span></label>
                            <div id="race-mod-container-original"></div>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Origin (Background)</label>
                            <input type="text" class="text-input" id="bg-original" placeholder="e.g. Acolyte">
                        </div>
                        <div class="input-group" id="block-origin-original">
                            <label class="input-label">Origin Feat</label>
                            <input type="text" class="text-input" id="orig-feat-original" placeholder="Feat Name">
                            <div class="field-header-row" style="margin-top:10px;"><label class="input-label" style="font-size:0.8em">Origin Feat Modifiers</label></div>
                            <div id="origin-mod-container-original"></div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h3 class="card-title">Classes</h3>
                    <div id="classes-container-original"></div>
                    <button type="button" class="button button-secondary" onclick="window.addClassRow('original')">+ Add Class</button>
                </div>
                <div id="feats-container-original"></div>
            </div>

            <div class="char-column" id="col-new">
                <h2 class="column-header">New Character</h2>
                <div class="card">
                    <h3 class="card-title">Character Origin</h3>
                    <div class="origin-grid">
                        <div class="input-group">
                            <div class="field-header-row"><label class="input-label">Character Name</label><button type="button" class="copy-link" onclick="window.copyValue('name-original', 'name-new')">Copy</button></div>
                            <input type="text" class="text-input" id="name-new" placeholder="Name">
                        </div>
                        <div class="input-group">
                            <div class="field-header-row"><label class="input-label">Base Attributes</label><button type="button" class="copy-link" onclick="window.copyAttributes()">Copy</button></div>
                            <div id="attrs-container-new"></div>
                            <div class="points-display" id="points-new">Points Remaining: 27</div>
                        </div>
                        <div class="input-group">
                            <div class="field-header-row"><label class="input-label">Race/Species</label><button type="button" class="copy-link" onclick="window.copyValue('race-original', 'race-new')">Copy</button></div>
                            <input type="text" class="text-input" id="race-new" placeholder="Race/Species Details">
                        </div>
                        <div class="input-group" id="block-race-new">
                            <div class="field-header-row"><label class="input-label">Racial Bonuses</label><button type="button" class="copy-link" onclick="window.copyMods('race')">Copy</button></div>
                            <div id="race-mod-container-new"></div>
                        </div>
                        <div class="input-group">
                            <div class="field-header-row"><label class="input-label">Origin (Background)</label><button type="button" class="copy-link" onclick="window.copyValue('bg-original', 'bg-new')">Copy</button></div>
                            <input type="text" class="text-input" id="bg-new" placeholder="e.g. Acolyte">
                        </div>
                        <div class="input-group" id="block-origin-new">
                            <div class="field-header-row"><label class="input-label">Origin Feat</label><button type="button" class="copy-link" onclick="window.copyValue('orig-feat-original', 'orig-feat-new')">Copy</button></div>
                            <input type="text" class="text-input" id="orig-feat-new" placeholder="Feat Name">
                            <div class="field-header-row" style="margin-top:10px;"><label class="input-label" style="font-size:0.8em">Origin Feat Modifiers</label><button type="button" class="copy-link" onclick="window.copyMods('origin')">Copy</button></div>
                            <div id="origin-mod-container-new"></div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h3 class="card-title">Classes</h3>
                    <div id="classes-container-new"></div>
                    <button type="button" class="button button-secondary" onclick="window.addClassRow('new')">+ Add Class</button>
                </div>
                <div id="feats-container-new"></div>
            </div>
        </div>

        <div class="card" style="margin-top: 2rem;">
            <h3 class="card-title">Rework Details</h3>
            <input type="text" id="rework-cost" class="text-input" placeholder="GP/DTP Costs">
            <textarea id="rework-notes" class="notes-area" style="min-height:100px;" placeholder="Notes for auditors"></textarea>
        </div>
    </div>

    <div id="tab-output" class="tab-content">
        <h2 class="column-header">Rework Request Form</h2>
        <textarea id="output-text" class="output-area" readonly></textarea>
        <button class="action-btn btn-save" onclick="window.copyOutput()" style="width:100%; margin-bottom: 15px;">Copy to Clipboard</button>
        <p style="text-align: center; font-size: 0.9em; color: var(--text-muted);">Please copy this statblock to <a href="https://discord.com/channels/308324031478890497/1094052066898518057" target="_blank" style="color: var(--primary-color); font-weight: bold;">#Character-Rework-Log</a></p>
    </div>
</div>

<script type="module" src="{{ '/assets/js/auth-manager.js' | relative_url }}"></script>

<script>
    // AUTH VISIBILITY HANDLER
    window.handlePageAuth = function(user, profile) {
        window.currentUser = user;
        const instructionText = document.getElementById('instruction-text');
        const loggedOutGroup = document.getElementById('logged-out-controls');
        const loggedInGroup = document.getElementById('logged-in-controls');
        const authErrorGroup = document.getElementById('auth-error-msg');
        
        if (user) {
            if (instructionText) instructionText.style.display = 'none';
            const hasAccess = (profile?.roles || []).includes("Adventurer");
            loggedOutGroup.style.display = 'none';
            if (hasAccess) {
                loggedInGroup.style.display = 'flex';
                if(window.fetchReworks) window.fetchReworks();
            } else {
                authErrorGroup.style.display = 'flex';
            }
        } else {
            if (instructionText) instructionText.style.display = 'block';
            loggedOutGroup.style.display = 'flex';
            loggedInGroup.style.display = 'none';
        }
    };
</script>

<script type="module">
    import { supabase } from "{{ '/assets/js/supabaseClient.js' | relative_url }}";

    const ATTRIBUTES = ['STR', 'DEX', 'CON', 'INT', 'WIS', 'CHA'];
    const POINT_COSTS = { 8: 0, 9: 1, 10: 2, 11: 3, 12: 4, 13: 5, 14: 7, 15: 9 };
    let characterData = [];

    // DATABASE LOAD/SAVE
    window.fetchReworks = async function() {
        if (!window.currentUser) return;
        const select = document.getElementById('load-rework-select');
        try {
            const { data, error } = await supabase.from('rework')
                .select('id, character_name, updated_at')
                .eq('user_id', window.currentUser.id)
                .order('updated_at', { ascending: false });
            if (error) throw error;
            select.innerHTML = '<option value="">-- Load Saved Rework --</option>';
            data.forEach(row => {
                const opt = document.createElement('option');
                opt.value = row.id;
                opt.innerText = `${row.character_name || "Unnamed"} (${new Date(row.updated_at).toLocaleDateString()})`;
                select.appendChild(opt);
            });
        } catch (err) { console.error(err); }
    };

    window.saveRework = async function() {
        if (!window.currentUser) return alert("Login required to save.");
        const oldChar = window.scrapeColumn('original');
        const newChar = window.scrapeColumn('new');
        const currentId = document.getElementById('current-rework-id').value;
        const payload = { 
            user_id: window.currentUser.id,
            discord_id: window.getCurrentDiscordID(),
            character_name: oldChar.name || "Unnamed", 
            old_character: oldChar, 
            new_character: newChar, 
            cost: document.getElementById('rework-cost').value, 
            notes: document.getElementById('rework-notes').value, 
            updated_at: new Date().toISOString() 
        };
        try {
            const { data, error } = currentId 
                ? await supabase.from('rework').update(payload).eq('id', currentId).select()
                : await supabase.from('rework').insert([payload]).select();
            if (error) throw error;
            if (!currentId && data) document.getElementById('current-rework-id').value = data[0].id;
            alert("Saved!");
            window.fetchReworks();
        } catch (e) { alert("Save failed."); }
    };

    window.loadSelectedRework = async function() {
        const id = document.getElementById('load-rework-select').value;
        if (!id) return alert("Please select a rework to load.");
        try {
            const { data, error } = await supabase.from('rework').select('*').eq('id', id).single();
            if (error) throw error;
            
            document.getElementById('current-rework-id').value = data.id;
            document.getElementById('rework-cost').value = data.cost || "";
            document.getElementById('rework-notes').value = data.notes || "";
            
            populateColumn('original', data.old_character);
            populateColumn('new', data.new_character);
            alert("Rework loaded!");
        } catch (err) { alert("Load failed."); }
    };

    function populateColumn(colId, data) {
        if(!data) return;
        const setVal = (id, v) => { const el = document.getElementById(id); if(el) el.value = v; };
        
        setVal(`name-${colId}`, data.name);
        setVal(`race-${colId}`, data.race);
        setVal(`bg-${colId}`, data.bg);
        setVal(`orig-feat-${colId}`, data.origin_feat);
        
        if(data.attributes) {
            ATTRIBUTES.forEach(a => setVal(`attr-${colId}-${a}`, data.attributes[a]));
        }
        
        // Populate Mods
        document.querySelectorAll(`.mod-select-race[data-col="${colId}"]`).forEach(s => {
            s.value = data.race_mods?.[s.dataset.attr] || "0";
        });
        document.querySelectorAll(`.mod-select-origin[data-col="${colId}"]`).forEach(s => {
            s.value = data.origin_mods?.[s.dataset.attr] || "0";
        });

        // Rebuild Classes
        const container = document.getElementById(`classes-container-${colId}`);
        container.innerHTML = "";
        if(data.classes) data.classes.forEach(c => window.addClassRow(colId, c));

        // Feats need a delay or manual trigger because cards depend on classes
        window.generateFeatCards(colId, data.feats);
        window.calculatePointBuy(colId);
    }

    // FORM SCRAPING & STATBLOCK GENERATION
    window.scrapeColumn = (colId) => {
        const getVal = (id) => document.getElementById(id)?.value || "";
        const attrs = {}; ATTRIBUTES.forEach(a => attrs[a] = getVal(`attr-${colId}-${a}`));
        
        const rMods = {}; document.querySelectorAll(`.mod-select-race[data-col="${colId}"]`).forEach(s => rMods[s.dataset.attr] = s.value);
        const oMods = {}; document.querySelectorAll(`.mod-select-origin[data-col="${colId}"]`).forEach(s => oMods[s.dataset.attr] = s.value);
        
        const classes = [];
        document.querySelectorAll(`#classes-container-${colId} .class-block`).forEach(b => {
            classes.push({
                version: b.querySelector('.version-select').value,
                class: b.querySelector('.class-select').value,
                subclass: b.querySelector('.subclass-select').value,
                level: b.querySelector('.level-input').value
            });
        });

        const feats = [];
        document.querySelectorAll(`#feats-container-${colId} .feat-card`).forEach(c => {
            const mods = {};
            c.querySelectorAll('select').forEach(s => { mods[s.dataset.attr] = s.value; });
            feats.push({ 
                name: c.querySelector('.text-input').value, 
                mods: mods, 
                source: c.querySelector('.card-title').innerText.split(' - ')[0] 
            });
        });

        return { name: getVal(`name-${colId}`), race: getVal(`race-${colId}`), bg: getVal(`bg-${colId}`), origin_feat: getVal(`orig-feat-${colId}`), attributes: attrs, race_mods: rMods, origin_mods: oMods, classes, feats };
    };

    window.generateOutput = () => {
        const discordId = window.getCurrentDiscordID();
        const oldC = window.scrapeColumn('original');
        const newC = window.scrapeColumn('new');

        const buildBlock = (c) => {
            const totalLvl = c.classes.reduce((acc, curr) => acc + (parseInt(curr.level) || 0), 0);
            const classStr = c.classes.map(cl => {
                const cleanCl = cl.class.replace(/\s*\(.*?\)\s*/g, ' ').trim();
                const cleanSub = (cl.subclass || '').replace(/\s*\(.*?\)\s*/g, ' ').trim();
                return `${cleanCl}${cleanSub && cleanSub !== 'None' ? ' ' + cleanSub : ''} (${cl.level})`;
            }).join(' / ');

            const statStr = ATTRIBUTES.map(a => c.attributes[a]).join(' / ');
            
            let bonuses = [];
            ATTRIBUTES.forEach(a => {
                const total = (parseInt(c.race_mods[a]) || 0) + (parseInt(c.origin_mods[a]) || 0);
                if(total > 0) bonuses.push(`+${total} ${a}`);
            });

            let featChoices = [];
            if(c.origin_feat) {
                let oMods = []; ATTRIBUTES.forEach(a => { if(c.origin_mods[a] != "0") oMods.push(`+${c.origin_mods[a]} ${a}`); });
                featChoices.push(`${c.origin_feat}${oMods.length ? ' ' + oMods.join(", ") : ""} (Background)`);
            }
            c.feats.forEach(f => {
                let fMods = []; ATTRIBUTES.forEach(a => { if(f.mods[a] != "0") fMods.push(`+${f.mods[a]} ${a}`); });
                featChoices.push(`${f.name}${fMods.length ? ' ' + fMods.join(", ") : ""} (${f.source})`);
            });

            return `Name: ${c.name}\nVersion: ${c.classes[0]?.version || '2024'}\nLevel: ${totalLvl}\nClass: ${classStr}\nRace/Species: ${c.race}\nStarting Stats: (excluding Racial/Background Bonuses)\nStr / Dex / Con / Int / Wis / Cha\n${statStr}\nRacial/Background stat bonuses: ${bonuses.join(', ') || 'None'}\nASI/Feat/Origin Feat choices: ${featChoices.join(', ')}\nBackground: ${c.bg}`;
        };

        const finalOutput = `\`\`\`
__***Character Change Request***__

**Requestor:** @${discordId} as ${oldC.name} (${oldC.classes.reduce((a,b)=>a+(parseInt(b.level)||0),0)})

**Old Character**
${buildBlock(oldC)}

**New Character**
${buildBlock(newC)}

**Notes**
Cost: ${document.getElementById('rework-cost').value || 'None'}
Notes: ${document.getElementById('rework-notes').value || 'None'}
\`\`\`
<@&474659626193780751> <@&554463237924716545>`;

        document.getElementById('output-text').value = finalOutput;
    };

    // UI RENDERERS & BUILDERS
    window.addClassRow = function(colId, initialData = null) {
        const container = document.getElementById(`classes-container-${colId}`);
        const block = document.createElement('div');
        block.className = 'class-block';
        block.innerHTML = `<div class="class-row"><select class="version-select"><option value="">Ver</option><option value="2014">2014</option><option value="2024">2024</option></select><select class="class-select" disabled><option value="">Class</option></select><select class="subclass-select" disabled><option value="">Subclass</option></select></div><div class="class-row-bottom"><div class="level-wrapper">Lvl:<input type="number" class="level-input" value="1" min="1" max="20"></div><button type="button" class="remove-class-btn" onclick="this.closest('.class-block').remove(); window.generateFeatCards('${colId}')">&times;</button></div>`;
        container.appendChild(block);
        
        const vSel = block.querySelector('.version-select'), cSel = block.querySelector('.class-select'), sSel = block.querySelector('.subclass-select'), lInp = block.querySelector('.level-input');
        
        const updateClasses = (val) => {
            cSel.innerHTML = '<option value="">Class</option>'; cSel.disabled = !vSel.value;
            [...new Set(characterData.filter(i => i.version == vSel.value).map(i => i.class))].forEach(c => {
                const opt = document.createElement('option'); opt.value = c; opt.innerText = c;
                if(c === val) opt.selected = true;
                cSel.appendChild(opt);
            });
        };

        const updateSubs = (val) => {
            sSel.innerHTML = '<option value="">Subclass</option>'; sSel.disabled = !cSel.value;
            characterData.filter(i => i.version == vSel.value && i.class == cSel.value).forEach(s => {
                const opt = document.createElement('option'); opt.value = s.subclass; opt.innerText = s.subclass || 'None';
                if(s.subclass === val) opt.selected = true;
                sSel.appendChild(opt);
            });
        };

        vSel.onchange = () => { updateClasses(); window.generateFeatCards(colId); };
        cSel.onchange = () => { updateSubs(); window.generateFeatCards(colId); };
        lInp.oninput = () => window.generateFeatCards(colId);

        if(initialData) {
            vSel.value = initialData.version;
            updateClasses(initialData.class);
            updateSubs(initialData.subclass);
            lInp.value = initialData.level;
        }
    };

    window.generateFeatCards = function(colId, savedFeats = null) {
        const container = document.getElementById(`feats-container-${colId}`);
        container.innerHTML = '';
        let featIdx = 0;
        document.querySelectorAll(`#classes-container-${colId} .class-block`).forEach((b, blockIdx) => {
            const cl = b.querySelector('.class-select').value, lv = parseInt(b.querySelector('.level-input').value) || 0;
            if (!cl) return;
            
            // Note: Simplistic ASI logic (every 4 levels) - adjust if your lookups table has specific levels
            for (let i = 4; i <= lv; i += 4) {
                const card = document.createElement('div');
                card.className = 'card feat-card';
                card.innerHTML = `<h3 class="card-title">${cl} - Lvl ${i} ASI/Feat</h3><input type="text" class="text-input" placeholder="Feat Name">${createStatTableHTML('feat', colId, `feat-${colId}-${blockIdx}-${i}`)}`;
                container.appendChild(card);
                
                if(savedFeats && savedFeats[featIdx]) {
                    const sf = savedFeats[featIdx];
                    card.querySelector('.text-input').value = sf.name || "";
                    ATTRIBUTES.forEach(a => {
                        const sel = card.querySelector(`select[data-attr="${a}"]`);
                        if(sel) sel.value = sf.mods?.[a] || "0";
                    });
                }
                featIdx++;
            }
        });
    };

    window.renderBaseAttributes = function(colId) {
        const container = document.getElementById(`attrs-container-${colId}`);
        let h = `<table class="stat-table"><thead><tr>${ATTRIBUTES.map(a=>`<th>${a}</th>`).join('')}</tr></thead><tbody><tr>`;
        ATTRIBUTES.forEach(a => h += `<td><input type="number" class="attr-input-cell" id="attr-${colId}-${a}" value="10" min="8" max="15" oninput="window.calculatePointBuy('${colId}')"></td>`);
        container.innerHTML = h + `</tr></tbody></table>`;
        window.calculatePointBuy(colId);
    };

    window.calculatePointBuy = function(colId) {
        let spent = 0;
        ATTRIBUTES.forEach(a => { spent += POINT_COSTS[document.getElementById(`attr-${colId}-${a}`).value] || 0; });
        const remaining = 27 - spent;
        const display = document.getElementById(`points-${colId}`);
        display.innerText = `Points Remaining: ${remaining}`;
        display.style.color = remaining < 0 ? '#e74c3c' : '#2ecc71';
    };

    function createStatTableHTML(type, colId, ctx) {
        let h = `<table class="stat-table"><thead><tr>${ATTRIBUTES.map(a=>`<th>${a}</th>`).join('')}</tr></thead><tbody><tr>`;
        ATTRIBUTES.forEach(a => h += `<td><select class="mod-select-${type}" data-col="${colId}" data-attr="${a}"><option value="0">0</option><option value="1">+1</option><option value="2">+2</option></select></td>`);
        return h + `</tr></tbody></table>`;
    }

    // UTILITIES
    window.getCurrentDiscordID = () => window.currentUser?.user_metadata.full_name || document.getElementById('manual-discord-id').value;
    window.copyValue = (src, tgt) => document.getElementById(tgt).value = document.getElementById(src).value;
    window.copyAttributes = () => { ATTRIBUTES.forEach(a => document.getElementById(`attr-new-${a}`).value = document.getElementById(`attr-original-${a}`).value); window.calculatePointBuy('new'); };
    window.copyMods = (type) => { ATTRIBUTES.forEach(a => { const s = document.querySelector(`.mod-select-${type}[data-col="original"][data-attr="${a}"]`), t = document.querySelector(`.mod-select-${type}[data-col="new"][data-attr="${a}"]`); if(s && t) t.value = s.value; }); };
    
    window.switchTab = (t) => {
        document.querySelectorAll('.tab-btn, .tab-content').forEach(el => el.classList.remove('active'));
        const btn = document.querySelector(`[onclick*="'${t}'"]`);
        if(btn) btn.classList.add('active');
        document.getElementById(`tab-${t}`).classList.add('active');
        if(t === 'output') window.generateOutput();
    };

    window.copyOutput = () => { const el = document.getElementById('output-text'); el.select(); document.execCommand('copy'); alert("Copied!"); };

    async function startApp() {
        try {
            const { data } = await supabase.from('lookups').select('data').eq('type', 'character').single();
            characterData = data?.data || [];
            ['original', 'new'].forEach(col => {
                window.renderBaseAttributes(col);
                document.getElementById(`race-mod-container-${col}`).innerHTML = createStatTableHTML('race', col, `race-${col}`);
                document.getElementById(`origin-mod-container-${col}`).innerHTML = createStatTableHTML('origin', col, `origin-${col}`);
                window.addClassRow(col);
            });
        } catch(e) { console.error(e); }
    }

    startApp();
</script>