/* How to use this include:
   Include this file where you want the auth header to appear:
   {% include auth-header.html %}

   This component requires JavaScript to function. It will display a loading
   indicator while checking the user's authentication status, then show either
   a login button or the user's profile information based on the result.

*/

<div id="auth-component" class="auth-wrapper">
    
    <span id="auth-loading" class="auth-loading-text">...</span>

    <button id="login-btn" class="auth-btn auth-btn-discord" style="display:none;">
        Login with Discord
    </button>

    <div id="user-profile" class="auth-profile" style="display:none;">
        
        <img id="user-avatar" src="" alt="User" class="auth-avatar" onerror="this.style.display='none'">
        
        <div class="auth-user-info">
            <span id="user-name" class="auth-name">Adventurer</span>
            
            <span id="user-role-badge" class="auth-role-badge" style="display:none;"></span>
        </div>

        <button id="logout-btn" class="auth-btn auth-btn-logout" title="Sign Out">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
        </button>
    </div>
</div>

<style>
    /* --- STYLING --- 
       Refactored to match Hawthorne Guild Guide (style.css) 
    */
    .auth-wrapper { 
        display: flex; 
        align-items: center; 
        gap: 12px; 
        font-family: var(--font-body); /* */
        font-size: 14px; 
        color: var(--color-text);      /* */
    }

    .auth-loading-text { 
        color: var(--color-text-secondary); /* */
        font-style: italic; 
        font-size: 0.9em; 
    }
    
    /* Buttons */
    .auth-btn { 
        border: none; 
        cursor: pointer; 
        border-radius: var(--border-radius); /* Matches site 0px corners */
        padding: 6px 12px; 
        font-family: var(--font-header);     /* Matches site button font */
        font-weight: 600; 
        text-transform: uppercase;           /* Matches site button style */
        transition: all 0.2s ease; 
        display: inline-flex; 
        align-items: center; 
        justify-content: center; 
        letter-spacing: 0.5px;
    }
    
    /* Discord Button - Kept distinct but integrated */
    .auth-btn-discord { 
        background-color: #5865F2; 
        color: white; 
        box-shadow: var(--shadow-sm); 
    }
    .auth-btn-discord:hover { 
        background-color: #4752C4; 
        transform: translateY(-2px); /* Matches site button hover animation */
        box-shadow: var(--shadow-md);
    }
    
    .auth-btn-logout { 
        background: transparent; 
        color: var(--color-text-secondary); /* */
        padding: 6px; 
        margin-left: 5px; 
    }
    .auth-btn-logout:hover { 
        color: var(--palette-alert-danger-action); /* Uses semantic danger color */
        background: var(--color-bg-medium);        /* */
    }

    /* Profile Container - Styled like a mini site Card */
    .auth-profile { 
        display: flex; 
        align-items: center; 
        gap: 8px; 
        background: var(--color-bg-light); /* Adapts to Dark Mode */
        border: 1px solid var(--color-border); 
        padding: 4px 8px 4px 4px; 
        border-radius: var(--border-radius); /* Square corners */
        transition: border-color 0.3s ease, background-color 0.3s ease;
    }

    .auth-avatar { 
        width: 28px; 
        height: 28px; 
        border-radius: 50%; /* Kept round for avatar convention */
        object-fit: cover; 
        background: var(--color-bg-medium); 
        border: 1px solid var(--color-border); 
    }

    .auth-user-info { 
        display: flex; 
        flex-direction: column; 
        line-height: 1.1; 
        justify-content: center; 
    }

    .auth-name { 
        font-family: var(--font-header); /* Matches headers */
        font-weight: 700; 
        color: var(--color-primary);     /* Uses brand color */
        max-width: 120px; 
        white-space: nowrap; 
        overflow: hidden; 
        text-overflow: ellipsis; 
        font-size: 0.95em;
    }
    
    /* Role Badge */
    .auth-role-badge { 
        font-size: 9px; 
        text-transform: uppercase; 
        color: var(--color-secondary); /* Uses accent color */
        font-weight: 800; 
        letter-spacing: 0.5px; 
        font-family: var(--font-body);
    }
</style>

<script>
(function() {
    /**
     * HELPER: getEl
     * Short for document.getElementById, scoped for this script to keep code clean.
     */
    const getEl = (id) => document.getElementById(id);
    
    // Map UI elements to variables for easy access
    const ui = {
        loading: getEl('auth-loading'),
        loginBtn: getEl('login-btn'),
        profile: getEl('user-profile'),
        avatar: getEl('user-avatar'),
        name: getEl('user-name'),
        roleBadge: getEl('user-role-badge'),
        logoutBtn: getEl('logout-btn')
    };

    /**
     * FUNCTION: updateAuthUI
     * The callback that 'auth-manager.js' triggers whenever login state changes.
     * * @param {Object} user - The Supabase User object (or null)
     * @param {Object} profile - The custom row from 'discord_users' table (or null)
     */
    const updateAuthUI = (user, profile) => {
        // 1. Always hide loading spinner once we have data
        ui.loading.style.display = 'none';

        if (user) {
            // --- STATE: LOGGED IN ---
            ui.loginBtn.style.display = 'none';
            ui.profile.style.display = 'flex';
            
            // Priority: Use DB Username -> Use Discord Real Name -> Default to "User"
            ui.name.textContent = (profile && profile.username) ? profile.username : (user.user_metadata.full_name || 'User');
            
            // Handle Avatar
            if (user.user_metadata.avatar_url) {
                ui.avatar.src = user.user_metadata.avatar_url;
                ui.avatar.style.display = 'block';
            }

            // Handle Custom Role Badge (Only shows if DB has 'role' column data)
            if (profile && profile.role) {
                ui.roleBadge.textContent = profile.role;
                ui.roleBadge.style.display = 'inline-block';
            } else {
                ui.roleBadge.style.display = 'none';
            }

        } else {
            // --- STATE: LOGGED OUT ---
            ui.loginBtn.style.display = 'inline-flex';
            ui.profile.style.display = 'none';
        }
    };

    /**
     * FUNCTION: initAuth
     * Recursively checks if `window.authManager` is loaded yet.
     * This ensures the UI doesn't break if this file loads *before* auth-manager.js.
     */
    const initAuth = () => {
        if (window.authManager) {
            
            // 1. Attach Click Handlers
            ui.loginBtn.onclick = () => window.authManager.login();
            ui.logoutBtn.onclick = () => window.authManager.logout();

            // 2. Register Listener (This triggers updateAuthUI immediately if session exists)
            window.authManager.init(updateAuthUI);
            
        } else {
            // Not ready? Retry in 100ms
            setTimeout(initAuth, 100);
        }
    };

    // Start initialization when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initAuth);
    } else {
        initAuth();
    }
})();
</script>