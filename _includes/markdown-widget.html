{% assign editor_id = include.id | default: "markdown-editor" %}
{% assign input_name = include.name | default: "markdown_content" %}

<div class="md-widget-container">
    <script>
        if (typeof marked === 'undefined' && !window.markedLoading) {
            window.markedLoading = true;
            var script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/marked/marked.min.js';
            document.head.appendChild(script);
        }
    </script>

    <div class="md-toolbar">
        <span class="md-label">Markdown Editor</span>
        <div class="md-tools">
            <small style="color: var(--color-text-secondary); font-size: 0.8em;">Supports **bold**, *italics*, and [links]</small>
        </div>
    </div>

    <div class="md-editor-wrapper">
        <div class="md-column">
            <textarea 
                id="{{ editor_id }}" 
                name="{{ input_name }}" 
                class="md-textarea"
                placeholder="Type your content here..."></textarea>
        </div>
        <div class="md-column preview-col">
            <div id="{{ editor_id }}-preview" class="md-preview-box">
                <em style="color: var(--color-text-secondary)">Preview will appear here...</em>
            </div>
        </div>
    </div>

    <style>
        /* Container */
        .md-widget-container { 
            border: 2px solid var(--color-border); 
            border-radius: var(--border-radius); 
            overflow: hidden; 
            margin-bottom: var(--spacing-md);
            background: var(--color-bg-light);
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }

        /* Toolbar */
        .md-toolbar { 
            background: var(--color-bg-medium); 
            padding: 10px 15px; 
            border-bottom: 2px solid var(--color-border); 
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .md-label {
            font-family: var(--font-header);
            font-weight: 700;
            color: var(--color-primary);
            text-transform: uppercase;
            font-size: 0.9em;
            letter-spacing: 0.5px;
        }

        /* Layout */
        .md-editor-wrapper { display: flex; min-height: 350px; }
        .md-column { flex: 1; display: flex; flex-direction: column; }

        /* Input Area */
        .md-textarea { 
            flex: 1; border: none; padding: 15px; resize: none; outline: none; 
            font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.6;
            background: var(--color-bg-page); color: var(--color-text);
        }
        .md-textarea::placeholder { color: var(--color-text-secondary); }

        /* Preview Area */
        .preview-col { border-left: 2px solid var(--color-border); background: var(--color-bg-light); }
        .md-preview-box { flex: 1; padding: 15px; overflow-y: auto; color: var(--color-text); font-family: var(--font-body); }
        .md-preview-box img { max-width: 100%; border-radius: var(--border-radius); }
        
        /* Typography fixes for preview */
        .md-preview-box h1, .md-preview-box h2 { margin-top: 0.5em; font-size: 1.5em; }
        .md-preview-box ul, .md-preview-box ol { padding-left: 1.5em; margin-bottom: 1em; }

        /* Mobile */
        @media (max-width: 768px) {
            .md-editor-wrapper { flex-direction: column; height: 600px; }
            .preview-col { border-left: none; border-top: 2px solid var(--color-border); }
        }
    </style>

    <script>
        // Self-executing function to isolate scope (prevents variable conflicts)
        (function() {
            var textarea = document.getElementById('{{ editor_id }}');
            var preview = document.getElementById('{{ editor_id }}-preview');
            
            function updatePreview() {
                // Wait for marked to load if it hasn't yet
                if (typeof marked === 'undefined') {
                    setTimeout(updatePreview, 100);
                    return;
                }

                if (!textarea.value.trim()) {
                    preview.innerHTML = '<em style="color: var(--color-text-secondary)">Preview will appear here...</em>';
                    return;
                }
                
                // Convert markdown to HTML
                preview.innerHTML = marked.parse(textarea.value);
            }

            // Attach event listener safely using JS, not inline HTML
            if (textarea) {
                textarea.addEventListener('input', updatePreview);
            }
        })();
    </script>
</div>