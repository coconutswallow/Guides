(function() {
  // Get the necessary HTML elements using their IDs
  var search = document.getElementById('search-input');
  var results = document.getElementById('search-results');
  
  var index = null;
  var store = {}; // Used to store the actual document content/titles

  // Exit if the search box or results container aren't on the current page
  if (!search || !results) return;

  // 1. Fetch the index file generated by Jekyll
  fetch('/search.json')
    .then(response => response.json())
    .then(data => {
      // 2. Build the Lunr index
      index = lunr(function () {
        this.field('title', { boost: 10 }); // Give title a higher importance
        this.field('content');
        this.ref('url'); // The URL is the unique identifier (reference)

        data.forEach(function (doc) {
          this.add(doc);
          // Store the full document data for displaying results later
          store[doc.url] = { title: doc.title, content: doc.content };
        }, this);
      });

      // 3. Attach search listener to the input field
      search.addEventListener('keyup', runSearch);
      search.addEventListener('change', runSearch);
    })
    .catch(error => {
      console.error('Error fetching search index:', error);
      results.innerHTML = '<p>Search functionality is temporarily unavailable.</p>';
      results.classList.add('active'); // Show error message
    });

  function runSearch() {
    var query = search.value;
    
    // Clear previous results
    results.innerHTML = '';
    
    // Hide results container if query is too short
    if (query.length < 2) {
        results.classList.remove('active');
        return; 
    }

    var searchResults = index.search(query);

    if (searchResults.length > 0) {
      // Display the results container
      results.classList.add('active');
      
      var header = document.createElement('li');
      header.classList.add('search-header');
      header.innerHTML = `<h3>Found ${searchResults.length} results for "${query}"</h3>`;
      results.appendChild(header);

      searchResults.forEach(function (res) {
        var doc = store[res.ref];
        var resultList = document.createElement('li');
        
        // Create a short content snippet
        var contentSnippet = doc.content.substring(0, 250) + '...'; 

        resultList.innerHTML = `
          <a href="${res.ref}">
            <h4>${doc.title}</h4>
            <p>${contentSnippet}</p>
          </a>
        `;
        results.appendChild(resultList);
      });
    } else {
      // Display "No results" message
      results.classList.add('active');
      results.innerHTML = `<li><h3>No results found for "${query}"</h3></li>`;
    }
  }
})();